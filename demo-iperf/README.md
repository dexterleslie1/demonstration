## 概念

简单来说，**iperf2（或 iperf version 2）是一个广泛使用的、开源的网络性能测量工具**，它专门用于测试两个节点之间的最大TCP和UDP带宽性能。

---

### 核心功能与用途

iperf2 的主要作用是回答一个关键问题：**“我的网络在两个点之间到底能跑多快？”**

它通过在一台设备上启动**服务器端**，在另一台设备上启动**客户端**，然后在两者之间生成数据流来工作。通过分析数据流的传输情况，它可以提供非常精确的带宽、延迟抖动、数据包丢失等测量结果。

**典型应用场景包括：**
*   **网络验收测试**：新搭建了一条专线或升级了带宽后，用iperf2来验证是否达到了服务商承诺的速率。
*   **故障排查**：当用户感觉网络“慢”时，运维人员可以用它来定位瓶颈是在局域网内、广域链路上还是服务器本身。
*   **性能基准测试**：在调整网络设备（如路由器、防火墙）的参数后，测试性能是否有提升。
*   **压力测试**：对网络链路进行高负载测试，看其在极限情况下的表现。

---

### 与 iperf3 的区别

这是一个非常常见的问题。iperf 项目本身有几个主要版本：

1.  **iperf2**：最经典、最稳定的版本。它的特点是：
    *   **功能丰富**：支持多线程（可以创建多个并行连接来测试，更能榨干高性能链路的带宽）。
    *   **历史悠久**：经过长期发展和测试，非常稳定，被大量脚本和自动化工具集成。
    *   **社区维护**：目前由ESNET组织维护。

2.  **iperf3**：一个旨在更简单、更精简的重新实现。它的特点是：
    *   **代码库更小**：目标是更容易移植到嵌入式系统等环境。
    *   **单线程设计**：默认情况下每个客户端使用一个线程，在某些高性能场景下可能不如iperf2的多线程有效。
    *   **功能聚焦**：移除了一些iperf2的晦涩功能，但后来也增加了一些新特性（如`--reverse`模式）。
    *   **主要开发**：目前是主要开发和维护的版本。

**如何选择？**
*   对于需要**多线程**来测试万兆（10Gbps）及以上高速链路的场景，很多人仍然首选 **iperf2**。
*   对于大多数常规的千兆及以下网络测试，**iperf3** 更简单易用，且足以满足需求。
*   注意：iperf2 和 iperf3 的服务器端和客户端**彼此不兼容**。你不能用iperf3的客户端去连接iperf2的服务器。

---

### 基本使用方法示例

使用iperf2非常简单，通常包含两个步骤：

1.  **在目标服务器上启动服务端**（默认监听5201端口）：
    ```bash
    iperf -s
    ```

2.  **在客户端上向服务器发起测试**（测试持续10秒）：
    ```bash
    iperf -c <服务器IP地址> -t 10
    ```
    *   例如：`iperf -c 192.168.1.100 -t 10`

**常用参数：**
*   `-c <IP>`：作为客户端运行，并指定服务器IP。
*   `-s`：作为服务器端运行。
*   `-t <秒>`：设置测试的时长（默认10秒）。
*   `-i <秒>`：设置每次报告的时间间隔。
*   `-P <数字>`：指定使用的并行线程/连接数（iperf2的优势所在）。例如 `-P 4` 会启动4个连接同时测试。
*   `-u`：使用UDP模式进行测试（默认是TCP）。
*   `-b <带宽>`：当用UDP模式时，指定发送的带宽速率（如 `-b 100M` 表示100Mbps）。
*   `-w`：设置TCP窗口大小。
*   `-r`：进行双向测试（先从客户端到服务器，然后反过来）。
*   `-d`：进行双向同时测试。

### 总结

**iperf2** 是一个强大、可靠且专业的网络性能基准测试工具，尤其以其多线程能力在高带宽测试环境中见长。它是网络工程师、系统管理员和IT专业人士工具箱中不可或缺的一款实用程序。



## `Ubuntu20`使用`autotools`编译`iperf2`

```shell
apt-get update
apt install make g++ -y

# 不使用gdb调试
./configure

# 使用gdb调试代码
./configure --enable-debug-symbols CFLAGS='-O0 -g3' CXXFLAGS='-O0 -g3'

make -j64
make install
iperf -c 192.168.1.xxx -t 180 -d
```

## `Ubuntu20`使用`CLion`调试`iperf2`代码

>说明：使用 `CLion-2022.2.4`。
>
>提示：通过下面使用 `CLion` 调试 `iperf2` 代码经验，大概了解到 `CLion` 通过调用 `autotools` 相关命令生成 `configure` 文件，再调用 `configure` 生成 `makefile`，在以后的运行或者调试中通过调用 `make --makefile=Makefile all` 先编译代码再使用 `gdb` 调试生成的二进制文件。

步骤：

- 使用 `CLion` 选择以 `makefile` 类型项目打开
- `Build, Execution, Deployment` > `Makefile` > `Pre-configuration commands` 最后添加 `--enable-debug-symbols CFLAGS='-O0 -g3' CXXFLAGS='-O0 -g3'`（一定要设置 `-O0 -g3`，否则无法命中断点并调试代码，`-O0` 关闭 `gcc` 代码自动优化，`-g3` 启动 `gcc` 调试模式编译代码）
- 配置 `target all Edit Configurations` > `Run/Debug Configurations` > `Executable` 选择 `iperf-2.1.8/build/src/iperf` 可执行文件，`program arguments: -c 192.168.1.xxx -t 180 -d`（`CLion` 这个界面的 `before launch` 会自动触发 `Build` 任务，使用 `target all` 进行编译 `make --makefile=Makefile all`，然后在调用 `iperf` 可执行文件进行 `debug`）
- 正常使用 `CLion run` 和 `debug` 功能运行或者调试程序