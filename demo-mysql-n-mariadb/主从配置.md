# 主从配置



## 配置

导出主库数据

```sh
docker compose exec -T db sh -c 'mariadb-dump -uroot -p123456 --single-transaction --quick --master-data=2 demo'| gzip > demo.gz
```

在从库中创建数据库

```sh
# 删除已经存在的数据库 demo
docker compose exec -T db sh -c 'mariadb -uroot -p123456 -e "set session sql_log_bin=0;drop database if exists demo;"'

# 创建数据库
docker compose exec -T db sh -c 'mariadb -uroot -p123456 -e "set session sql_log_bin=0;create database demo character set utf8mb4 collate utf8mb4_general_ci;"'
```

还原主库数据到从库中

```sh
(echo "set session sql_log_bin=0;"; gzip -d -c demo.gz) | docker compose exec -T db sh -c 'mariadb -uroot -p123456 demo'
```

找出 binlog 日志位置

```sh
gzip -d -c demo.gz | grep "CHANGE MASTER TO"
```

设置从库同步开始位置

```sh
docker compose exec -T db sh -c "mariadb -uroot -p123456 -e \"change master to master_host='192.168.1.190',master_port=3306,master_user='root',master_password='123456',master_log_file='mysqld-bin.000002',master_log_pos=202096004\""
```

- `master_host=192.168.1.190` 是主库的 ip 地址。

- `master_port=3306` 是主库的端口。

- `master_user` 是主库的用户。

- `master_password` 是主库的密码。

- `master_log_file='mysqld-bin.000002'` 是 `CHANGE MASTER TO` 中的 `MASTER_LOG_FILE`。

- `master_log_pos=202096004` 是 `CHANGE MASTER TO` 中的 `MASTER_LOG_POS`。

- 如果使用普通用户配置主从同步需要在主库中授予普通用户数据复制权限，在主库中执行以下命令：

  ```sql
  grant replication slave on *.* to user1@ip identified by '123456';
  flush privileges;
  ```

  

启动从库同步

```sh
docker compose exec -T db sh -c "mariadb -uroot -p123456 -e \"start slave\""
```

查看从库同步状态

```sh
docker compose exec -T db sh -c "mariadb -uroot -p123456 -e \"show slave status\\G\""
```



## 管理

### 删除 slave 配置

>[参考文档](https://stackoverflow.com/questions/40124114/how-to-delete-mariadbs-specified-connection-name-for-multi-source-replication/40210098)

删除 slavename 的 slave 配置

```sql
reset slave 'slavename' all;

# 不能显示 slavename 状态并且报错，因为 slavename 已被删除
show slave 'slavename' status\G;
```



### 显示所有 slaves 状态

```sql
show all slaves status\G;
```



### 显示指定 slave 状态

```sql
show slave 'slavename' status\G;
```



### 停止指定 slave

```sql
stop slave 'slavename';
```



### 启动指定 slave

```sql
start slave 'slavename';
```