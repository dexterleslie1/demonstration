## `mariadb`分区表 - 概念

> [Partition key , unique key, primary key建立分区表遵循规则](https://dev.mysql.com/doc/refman/8.0/en/partitioning-limitations-partitioning-keys-unique-keys.html)

通过`information_schema.PARTITIONS`表查看表分区状态`select * from information_schema.partitions where table_schema='demo' and table_name='test1';`。



## `mariadb`分区表 - 整数分区

```sql
# 创建实验数据库
CREATE DATABASE IF NOT EXISTS demo CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建实验数据表
USE demo;

DROP TABLE IF EXISTS test1;

CREATE TABLE IF NOT EXISTS test1(
    partition_field     INT NOT NULL COMMENT '分区字段',
    `uuid`          	VARCHAR(64) NOT NULL
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
partition by range columns(partition_field) (
	partition p0 values less than(1),
	partition p1 values less than(2),
	partition p2 values less than(3),
	partition p3 values less than(4),
	partition p4 values less than(5)
);

delimiter |

drop procedure if exists proc_temp|

create procedure proc_temp()
begin
	declare var_counter int default 0;
    while var_counter<50000 do
		insert into test1(partition_field,`uuid`) values(FLOOR(0+RAND()*5),uuid());
        set var_counter = var_counter + 1;
    end while;
end|

delimiter ;

call proc_temp();
```



## `mariadb`分区表 - 日期分区

创建表时指定默认分区

```sql
create table if not exists t_order(
    /* long 类型 */
    /*id              bigint not null auto_increment primary key,*/
    id              bigint not null,
    /* int 类型 */
    /*id              int not null auto_increment primary key,*/
    /* biginteger 类型 */
    /*id              decimal(20,0) not null primary key,*/
    /* uuid string 类型 */
    /*id              varchar(36) not null primary key,*/

    userId          bigint not null,
    `status`        ENUM('Unpay','Undelivery','Unreceive','Received','Canceled') NOT NULL COMMENT '订单状态：未支付、未发货、未收货、已签收、买家取消',
    payTime         datetime default null comment '付款时间',
    deliveryTime    datetime default null comment '发货时间',
    receivedTime    datetime default null comment '签收时间',
    cancelTime      datetime default null comment '取消时间',
    deleteStatus    ENUM('Normal','Deleted') NOT NULL COMMENT '订单删除状态',
    createTime      datetime not null
) engine=innodb character set utf8mb4 collate utf8mb4_general_ci
partition by range columns(createTime)(
	partition pdefault values less than ('2025-01-01 00:00:00')
);
```

创建表后指定默认分区

```sql
create table if not exists t_order(
    /* long 类型 */
    /*id              bigint not null auto_increment primary key,*/
    id              bigint not null,
    /* int 类型 */
    /*id              int not null auto_increment primary key,*/
    /* biginteger 类型 */
    /*id              decimal(20,0) not null primary key,*/
    /* uuid string 类型 */
    /*id              varchar(36) not null primary key,*/

    userId          bigint not null,
    `status`        ENUM('Unpay','Undelivery','Unreceive','Received','Canceled') NOT NULL COMMENT '订单状态：未支付、未发货、未收货、已签收、买家取消',
    payTime         datetime default null comment '付款时间',
    deliveryTime    datetime default null comment '发货时间',
    receivedTime    datetime default null comment '签收时间',
    cancelTime      datetime default null comment '取消时间',
    deleteStatus    ENUM('Normal','Deleted') NOT NULL COMMENT '订单删除状态',
    createTime      datetime not null
) engine=innodb character set utf8mb4 collate utf8mb4_general_ci;

# 创建默认分区
alter table t_order partition by range columns(createTime)(
	partition pdefault values less than ('2025-01-01 00:00:00')
);
```

给已经分区的表添加新的分区

```sql
alter table t_order add partition(
	partition p20250819 values less than ('2025-08-20 00:00:00')
);

alter table t_order add partition(
	partition p20250820 values less than ('2025-08-21 00:00:00')
);

alter table t_order add partition(
	partition p20250821 values less than ('2025-08-22 00:00:00')
);
```

取消所有分区

```sql
alter table t_order remove partitioning;
```



## `mariadb`分区表 - 使用存储过程初始化分区

```sql
create database if not exists demo character set utf8mb4 collate utf8mb4_general_ci;

use demo;

create table if not exists t_order(
    /* long 类型 */
    /*id              bigint not null auto_increment primary key,*/
    id              bigint not null,
    /* int 类型 */
    /*id              int not null auto_increment primary key,*/
    /* biginteger 类型 */
    /*id              decimal(20,0) not null primary key,*/
    /* uuid string 类型 */
    /*id              varchar(36) not null primary key,*/

    userId          bigint not null,
    `status`        ENUM('Unpay','Undelivery','Unreceive','Received','Canceled') NOT NULL COMMENT '订单状态：未支付、未发货、未收货、已签收、买家取消',
    payTime         datetime default null comment '付款时间',
    deliveryTime    datetime default null comment '发货时间',
    receivedTime    datetime default null comment '签收时间',
    cancelTime      datetime default null comment '取消时间',
    deleteStatus    ENUM('Normal','Deleted') NOT NULL COMMENT '订单删除状态',
    createTime      datetime not null
) engine=innodb character set utf8mb4 collate utf8mb4_general_ci
partition by range columns(createTime)(
    partition pdefault values less than ('2025-01-01 00:00:00')
);

delimiter |

create procedure proc_temp()
begin
    declare datetime_today datetime default str_to_date(date_format(date_add(curdate(), interval 1 day), '%Y-%m-%d 00:00:00'), '%Y-%m-%d %H:%i:%s');
	declare counter int default -15;
    declare datetime_loop datetime;
    declare partition_name varchar(16);
    
    -- select datetime_today as debug_info;
    
    while counter <= 60 do
		set datetime_loop = date_add(datetime_today, interval counter day);
        set partition_name = date_format(date_add(datetime_loop, interval -1 day), 'p%Y%m%d');
        -- select date_format(datetime_loop, '%Y-%m-%d %H:%i:%s');
        -- select partition_name;
        
        set @add_partition_sql = concat('alter table t_order add partition(partition ', partition_name, ' values less than (\'', date_format(datetime_loop, '%Y-%m-%d %H:%i:%s'),'\'))');
        PREPARE stmt FROM @add_partition_sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        set counter = counter + 1;
    end while;
end|

delimiter ;

-- 调用存储过程
call proc_temp();

-- 删除存储过程
drop procedure if exists proc_temp;
```

