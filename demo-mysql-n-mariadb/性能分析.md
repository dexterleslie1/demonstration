# `MySQL`æ€§èƒ½åˆ†æ

## `show profiles`

ä½¿ç”¨`show profiles`åˆ†æ`sql`æ€§èƒ½ï¼Œè¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ <a href="/mysql-n-mariadb/å‘½ä»¤.html#show-profileså’Œshow-profileå‘½ä»¤" target="_blank">é“¾æ¥</a>



## `explain` - æ¦‚å¿µ

æ‰§è¡Œè®¡åˆ’å„ä¸ªå­—æ®µå«ä¹‰ï¼š

- idï¼šselectæŸ¥è¯¢çš„åºåˆ—å·ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œselectå­å¥æˆ–è€…æ˜¯æ“ä½œè¡¨çš„é¡ºåºï¼ˆidç›¸åŒï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹æ‰§è¡Œï¼›idä¸åŒï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œï¼‰ã€‚
- select_typeï¼šhttps://www.cnblogs.com/joimages/p/14521966.htmlï¼Œè¡¨ç¤ºselectçš„ç±»å‹ï¼Œå¸¸è§çš„å–å€¼æœ‰SIMPLEï¼ˆæŸ¥è¯¢è¯­å¥ä¸­ä¸åŒ…å«`UNION`æˆ–è€…å­æŸ¥è¯¢çš„æŸ¥è¯¢éƒ½ç®—ä½œæ˜¯`SIMPLE`ç±»å‹ï¼Œæ— è®ºæ˜¯å•è¡¨æŸ¥è¯¢è¿˜æ˜¯è”åˆæŸ¥è¯¢è¿™äº›æŸ¥è¯¢çš„çº§åˆ«éƒ½æ˜¯ simpleã€‚é¡¾åæ€ä¹‰ï¼Œè¿™äº›æŸ¥è¯¢éƒ½è¢« MySQL è®¤ä¸ºæ˜¯æ¯”è¾ƒç®€å•çš„æŸ¥è¯¢æ¨¡å¼ã€‚ï¼‰ã€PRIMARYï¼ˆå¯¹äºåŒ…å«UNIONã€UNION ALLæˆ–è€…å­æŸ¥è¯¢çš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„ï¼Œå…¶ä¸­æœ€å·¦è¾¹çš„é‚£ä¸ªæŸ¥è¯¢çš„select_typeå€¼å°±æ˜¯PRIMARYï¼‰ã€UNIONï¼ˆåŒ…å«UNIONã€UNION ALLæˆ–è€…å­æŸ¥è¯¢çš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„å˜›ã€‚é™¤äº†ç¬¬ä¸€ä¸ªæ˜¯ PRIMARYï¼Œå…¶ä»–çš„éƒ½æ˜¯ UNIONï¼‰ã€UNION RESULTï¼ˆå¦‚æœ MySQL ä¸­çš„ UNION éœ€è¦ç”¨åˆ°ä¸´æ—¶è¡¨è¿›è¡Œå»é‡çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå°æŸ¥è¯¢çš„çº§åˆ«å°±æ˜¯ UNION RESULTï¼‰ã€SUBQUERYï¼ˆå¦‚æœæˆ‘ä»¬çš„å­æŸ¥è¯¢ä¸èƒ½è½¬æ¢å¯¹åº” semi-joinçš„å½¢å¼ï¼Œè€Œä¸”è¿™ä¸ªæŸ¥è¯¢ä¸æ˜¯ç›¸å…³å­æŸ¥è¯¢çš„è¯ï¼Œå¹¶ä¸”æŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šé‡‡ç”¨å°†è¯¥å­æŸ¥è¯¢ç‰©åŒ–çš„æ–¹æ¡ˆæ¥æ‰§è¡Œè¯¥å­æŸ¥è¯¢æ—¶ï¼Œè¿™ä¸ªæ—¶å€™è¯¥å­æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ª SELECT çš„çº§åˆ«å°±æ˜¯ SUBQUERYï¼‰
- typeï¼šè¡¨ç¤ºè¿æ¥ç±»å‹ï¼Œæ€§èƒ½æœ‰å¥½åˆ°å·®çš„è¿æ¥ç±»å‹ä¸ºNULLã€systemã€constã€eq_refã€refã€rangeã€indexï¼ˆç”¨äº†ç´¢å¼•ä½†æ˜¯éœ€è¦å¯¹æ•´ä¸ªç´¢å¼•éå†æ‰«æï¼‰ã€allã€‚
- possible_keyï¼šè¡¨ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸Šçš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªã€‚
- keyï¼šè¡¨ç¤ºæŸ¥è¯¢ä¸­å®é™…ç”¨åˆ°çš„ç´¢å¼•ï¼ŒNULLä¸ºæ²¡æœ‰ç”¨åˆ°ä»»ä½•ç´¢å¼•ã€‚
- key_lenï¼šè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œè¯¥å€¼ä¸ºç´¢å¼•å­—æ®µæœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨çš„é•¿åº¦ï¼Œåœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚
- rowsï¼šMySQLè®¤ä¸ºå¿…é¡»è¦æ‰§è¡ŒæŸ¥è¯¢çš„è¡Œæ•°ï¼Œåœ¨InnoDBå¼•æ“çš„è¡¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¯èƒ½å¹¶ä¸æ€»æ˜¯å‡†ç¡®çš„ã€‚
- filteredï¼šè¡¨ç¤ºè¿”å›ç»“æœçš„è¡Œæ•°å æ€»è¯»å–è¡Œæ•°çš„ç™¾åˆ†æ¯”ï¼Œfilteredçš„å€¼è¶Šå¤§è¶Šå¥½ã€‚

åˆ›å»ºæµ‹è¯•æ•°æ®åº“

```sql
CREATE DATABASE IF NOT EXISTS testdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

use testdb;

create table if not exists course(
  id bigint primary key auto_increment,
  name varchar(64) not null
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 collate=utf8mb4_general_ci;

create table if not exists student(
  id bigint primary key auto_increment,
  name varchar(64) not null,
  `no` varchar(64) not null
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 collate=utf8mb4_general_ci;

create table if not exists student_course(
  id bigint primary key auto_increment,
  studentid bigint not null,
  courseid bigint not null,
  constraint fk_studentCourse_studentId foreign key (studentid) references student(id),
  constraint fk_studentCourse_courseid foreign key (courseid) references course(id)
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 collate=utf8mb4_general_ci;

insert into course values
(1,'Java'),
(2,'PHP'),
(3,'MySQL'),
(4,'Hadoop');

insert into student values
(1,'é»›å€šä¸','2000100101'),
(2,'è°¢é€Š','2000100102'),
(3,'æ˜•å¤©æ­£','2000100103'),
(4,'éŸ¦ä¸€ç¬‘','2000100104');

insert into student_course values
(1,1,1),
(2,1,2),
(3,1,3),
(4,2,2),
(5,2,3),
(6,3,4);
```

æµ‹è¯•`explain`

```shell
# æ‰§è¡Œè®¡åˆ’idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ
# idéƒ½ç­‰äº1,å…ˆæ‰§è¡Œstudentï¼Œå†æ‰§è¡Œstudent_courseï¼Œåœ¨æ‰§è¡Œcourse
mysql> explain select s.*,c.* from student s,student_course sc,course c where s.id=sc.studentid and c.id=sc.courseid\G;
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: s
   partitions: NULL
         type: ALL
possible_keys: PRIMARY
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 4
     filtered: 100.00
        Extra: NULL
*************************** 2. row ***************************
           id: 1
  select_type: SIMPLE
        table: sc
   partitions: NULL
         type: ALL
possible_keys: fk_studentCourse_studentId,fk_studentCourse_courseid
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 6
     filtered: 33.33
        Extra: Using where; Using join buffer (hash join)
*************************** 3. row ***************************
           id: 1
  select_type: SIMPLE
        table: c
   partitions: NULL
         type: eq_ref
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 8
          ref: testdb.sc.courseid
         rows: 1
     filtered: 100.00
        Extra: NULL
3 rows in set, 1 warning (0.00 sec)

# æ‰§è¡Œè®¡åˆ’idä¸åŒï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ
# å…ˆæ‰§è¡Œcourseå­æŸ¥è¯¢ï¼Œåœ¨æ‰§è¡ŒstudentæŸ¥è¯¢ï¼Œæœ€åæ‰§è¡Œstuent_courseæŸ¥è¯¢
mysql> explain select s.* from student s where s.id in(select sc.studentid from student_course sc where sc.courseid=(select c.id from course c where c.name='MySQL'))\G;
*************************** 1. row ***************************
           id: 1
  select_type: PRIMARY
        table: <subquery2>
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: NULL
     filtered: 100.00
        Extra: NULL
*************************** 2. row ***************************
           id: 1
  select_type: PRIMARY
        table: s
   partitions: NULL
         type: eq_ref
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 8
          ref: <subquery2>.studentid
         rows: 1
     filtered: 100.00
        Extra: NULL
*************************** 3. row ***************************
           id: 2
  select_type: MATERIALIZED
        table: sc
   partitions: NULL
         type: ref
possible_keys: fk_studentCourse_studentId,fk_studentCourse_courseid
          key: fk_studentCourse_courseid
      key_len: 8
          ref: const
         rows: 2
     filtered: 100.00
        Extra: Using where
*************************** 4. row ***************************
           id: 3
  select_type: SUBQUERY
        table: c
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 4
     filtered: 25.00
        Extra: Using where
4 rows in set, 1 warning (0.00 sec)
```



## `explain` - `key_len`

>è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œè¯¥å€¼ä¸ºç´¢å¼•å­—æ®µæœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨çš„é•¿åº¦ï¼Œåœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚

åˆ›å»ºæµ‹è¯•è¡¨

```sql
create database if not exists demo character set utf8mb4 collate utf8mb4_general_ci;

use demo;

create table if not exists employees(
    id          int(11) not null primary key auto_increment,
    name        varchar(36) not null default '' comment 'å§“å',
    age         int(11) not null default 0 comment 'å¹´é¾„',
    position    varchar(20) not null default '' comment 'èŒä½',
    hire_time   timestamp not null default current_timestamp comment 'å…¥èŒæ—¶é—´',
    remark      varchar(255) default null comment 'å¤‡æ³¨',
    key idx_name_age_position(name, age, position) using btree
) engine=innodb character set utf8mb4 collate utf8mb4_general_ci;

```

`explain` å‘½ä»¤è¾“å‡º

```sql
$ explain select * from employees where name='d40d82a9-18fa-4719-9867-1d98dea4bb87' and age=55 and position='é«˜çº§å¼€å‘å·¥ç¨‹å¸ˆ';
# id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	employees	ref	idx_name_age_position	idx_name_age_position	232	const,const,const	1	Using index condition

```

- å¯¹äº `name VARCHAR(36)` ä¸º `36 Ã— 4ï¼ˆå­—ç¬¦é›†ï¼šutf8mb4 æ¯ä¸ªå­—ç¬¦æœ€å¤šå  4 å­—èŠ‚ï¼‰= 144` å­—èŠ‚ï¼Œå†åŠ  `2` å­—èŠ‚ï¼ˆé•¿åº¦å‰ç¼€ï¼‰= `146` å­—èŠ‚
- è®¡ç®— `age` åˆ—çš„å­—èŠ‚é•¿åº¦ `INT(11)` å®é™…å›ºå®šä¸º `4` å­—èŠ‚
-  è®¡ç®— `position` åˆ—çš„å­—èŠ‚é•¿åº¦ï¼Œ`20 Ã— 4 = 80` å­—èŠ‚ï¼Œ`2` å­—èŠ‚ï¼ˆé•¿åº¦å‰ç¼€ï¼‰= `82` å­—èŠ‚
-  æ€» `key_len = 146 + 4 + 82 = 232` å­—èŠ‚



## `explain` - `ref`

### MySQL EXPLAIN è¾“å‡ºä¸­çš„ `ref` å­—æ®µè¯¦è§£

`ref` æ˜¯ `EXPLAIN` è¾“å‡ºä¸­çš„ä¸€ä¸ª**å…³é”®æŒ‡æ ‡**ï¼Œå®ƒæ­ç¤ºäº† **MySQL åœ¨ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œå®é™…ç”¨æ¥ä¸ç´¢å¼•åˆ—æ¯”è¾ƒçš„å€¼æ˜¯ä»€ä¹ˆï¼ˆæˆ–æ¥æºå“ªé‡Œï¼‰**ã€‚ç®€è€Œè¨€ä¹‹ï¼š**`ref` å‘Šè¯‰ä½  MySQL ç”¨ã€Œä»€ä¹ˆå€¼ã€å»åŒ¹é…ç´¢å¼•åˆ—**ã€‚

---

### ğŸ” `ref` çš„å¸¸è§å€¼åŠå«ä¹‰

| **`ref` çš„å€¼** | **å«ä¹‰è¯´æ˜**                                                 | **å…¸å‹åœºæ™¯**                           |
| -------------- | ------------------------------------------------------------ | -------------------------------------- |
| **`const`**    | MySQL ä½¿ç”¨**å¸¸é‡å€¼**ç›´æ¥åŒ¹é…ç´¢å¼•åˆ—                           | `WHERE name = 'å¼ ä¸‰'`                  |
| **`åˆ—å`**     | MySQL ä½¿ç”¨**å¦ä¸€å¼ è¡¨çš„åˆ—å€¼**åŒ¹é…å½“å‰ç´¢å¼•åˆ—ï¼ˆå¤šè¡¨ JOIN æ—¶å¸¸è§ï¼‰ | `ON t1.id = t2.foreign_key`            |
| **`func`**     | MySQL éœ€è¦å…ˆå¯¹å€¼è¿›è¡Œ**å‡½æ•°è®¡ç®—**æ‰èƒ½åŒ¹é…ç´¢å¼•ï¼ˆå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼‰ | `WHERE UPPER(name) = 'ZHANGSAN'`       |
| **`NULL`**     | æ— æœ‰æ•ˆçš„æ¯”è¾ƒå€¼ï¼Œé€šå¸¸å› ä¸ºï¼š<br>1. ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼ˆ>ã€<ï¼‰<br>2. æœªä½¿ç”¨ç´¢å¼•<br>3. å…¨è¡¨æ‰«æ | `WHERE age > 30`<br>æˆ–æœªå‘½ä¸­ç´¢å¼•çš„æŸ¥è¯¢ |

---

### âœ… å®ä¾‹è§£æï¼ˆé€šè¿‡è¡¨ç»“æ„å’ŒæŸ¥è¯¢ç†è§£ `ref`ï¼‰

#### è¡¨ç»“æ„ï¼š
```sql
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    dept_id INT NOT NULL,
    INDEX idx_dept (dept_id),
    INDEX idx_name (name)
);

CREATE TABLE departments (
    id INT PRIMARY KEY,
    name VARCHAR(50) NOT NULL
);
```

#### åœºæ™¯ 1ï¼šå•è¡¨å¸¸é‡æŸ¥è¯¢ï¼ˆ`ref = const`ï¼‰
```sql
EXPLAIN SELECT * FROM employees WHERE name = 'æå››';
```
è¾“å‡ºï¼š
```
+----+-------------+-----------+------+---------------+----------+---------+-------+------+-------------+
| id | select_type | table     | type | key           | key_len  | ref     | rows | Extra       |
+----+-------------+-----------+------+---------------+----------+---------+------+-------------+
| 1  | SIMPLE      | employees | ref  | idx_name      | 202      | const   | 1    | Using where |
+----+-------------+-----------+------+---------------+----------+---------+------+-------------+
```
**è¯´æ˜**ï¼š  
ç”¨å¸¸é‡ `'æå››'`ï¼ˆ`ref = const`ï¼‰ç›´æ¥åŒ¹é…ç´¢å¼• `idx_name` çš„ `name` åˆ—ã€‚

---

#### åœºæ™¯ 2ï¼šå¤šè¡¨ JOINï¼ˆ`ref = å¦ä¸€å¼ è¡¨çš„åˆ—å`ï¼‰
```sql
EXPLAIN 
SELECT * 
FROM employees e
JOIN departments d ON e.dept_id = d.id
WHERE d.name = 'æŠ€æœ¯éƒ¨';
```
è¾“å‡ºï¼š
```
+----+-------------+-------+--------+---------------+---------+---------+-----------------+------+-------------+
| id | select_type | table | type   | key           | key_len | ref     | rows | Extra         |
+----+-------------+-------+--------+---------------+---------+---------+-----------------+------+-------------+
| 1  | SIMPLE      | d     | ref    | idx_name      | 202     | const   | 1    | Using index   |
| 1  | SIMPLE      | e     | ref    | idx_dept      | 4       | d.id    | 10   | Using where   |
+----+-------------+-------+--------+---------------+---------+---------+-----------------+------+-------------+
```
**è¯´æ˜**ï¼š  
- å…ˆæŸ¥ `departments`ï¼šç”¨å¸¸é‡ `'æŠ€æœ¯éƒ¨'`ï¼ˆ`ref = const`ï¼‰åŒ¹é…ç´¢å¼• `idx_name`  
- å†æŸ¥ `employees`ï¼šç”¨ `d.id` çš„å€¼ï¼ˆ`ref = d.id`ï¼‰åŒ¹é…ç´¢å¼• `idx_dept`ï¼ˆå…³è”æ“ä½œï¼‰

---

#### åœºæ™¯ 3ï¼šå‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆ`ref = NULL`ï¼‰
```sql
EXPLAIN SELECT * FROM employees WHERE UPPER(name) = 'ZHANGSAN';
```
è¾“å‡ºï¼š
```
+----+-------------+-----------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table     | type | key           | key_len | ref     | rows | Extra       |
+----+-------------+-----------+------+---------------+------+---------+------+-------------+
| 1  | SIMPLE      | employees | ALL  | NULL          | NULL    | NULL    | 1000 | Using where |
+----+-------------+-----------+------+---------------+------+---------+------+-------------+
```
**è¯´æ˜**ï¼š  
å¯¹åˆ—ä½¿ç”¨å‡½æ•° `UPPER(name)` å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œå› æ­¤ `ref = NULL`ï¼ˆå…¨è¡¨æ‰«æï¼‰ã€‚

---

### ğŸ“Œ `ref` çš„æ ¸å¿ƒä»·å€¼
1. **ç´¢å¼•æœ‰æ•ˆæ€§æ£€æµ‹**  
   - `const`/`åˆ—å` = é«˜æ•ˆç´¢å¼•åŒ¹é… âœ…  
   - `NULL` = å¯èƒ½æœªç”¨ç´¢å¼•ï¼ˆéœ€ä¼˜åŒ–ï¼‰ âš ï¸
2. **å¤šè¡¨ JOIN ä¼˜åŒ–ä¾æ®**  
   æ˜ç¡®å…³è”æ—¶æ˜¯å¦ç”¨ç´¢å¼•åŒ¹é…ï¼ˆä¾‹ï¼š`ref = d.id` è¡¨ç¤ºç”¨å…³è”åˆ—ï¼‰
3. **æŸ¥è¯¢æ¡ä»¶è¯Šæ–­**  
   å½“ `ref = NULL` ä½† `type = range` æ—¶ï¼Œè¯´æ˜æ˜¯èŒƒå›´æŸ¥è¯¢è€Œéç­‰å€¼åŒ¹é…

---

### æ€»ç»“ä¸€å¥è¯
> ğŸ’¡ `ref` æ˜¯ **ç´¢å¼•æŸ¥æ‰¾çš„ã€Œé’¥åŒ™ã€** â€”â€” å®ƒç›´æ¥å›ç­”ï¼š  
> **MySQL ç”¨ã€Œä»€ä¹ˆå€¼ã€æ‰“å¼€ç´¢å¼•è¿™æŠŠé”**ã€‚  
> é”ï¼ˆç´¢å¼•ï¼‰å’Œé’¥åŒ™ï¼ˆ`ref` çš„å€¼ï¼‰åŒ¹é…æ—¶ï¼ŒæŸ¥è¯¢æœ€é«˜æ•ˆï¼›é’¥åŒ™ä¸å¯¹ï¼ˆå¦‚ `NULL` æˆ– `func`ï¼‰ï¼Œæ€§èƒ½ä¼šæš´è·Œã€‚



## å¯¼è‡´`SQL`æ…¢æœ‰å“ªäº›å› ç´ å‘¢ï¼Ÿ

> todo åšå®éªŒè¯æ˜å¹¶è§£å†³é—®é¢˜

SQLæŸ¥è¯¢æ…¢çš„åŸå› å¯èƒ½æ¶‰åŠå¤šä¸ªæ–¹é¢ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„åŸå› ï¼š

### 1. ç´¢å¼•é—®é¢˜

- **æ²¡æœ‰ç´¢å¼•æˆ–æœªä½¿ç”¨ç´¢å¼•**ï¼šè¿™æ˜¯æŸ¥è¯¢æ…¢æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ã€‚å¦‚æœæŸ¥è¯¢çš„åˆ—ä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œæ•°æ®åº“å°†ä¸å¾—ä¸è¿›è¡Œå…¨è¡¨æ‰«æï¼Œè¿™ä¼šæ˜¾è‘—å¢åŠ æŸ¥è¯¢æ—¶é—´ã€‚
- **ç´¢å¼•å¤±æ•ˆ**ï¼šå³ä½¿å­˜åœ¨ç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æˆ–æŸ¥è¯¢æ–¹å¼å¯¼è‡´ç´¢å¼•æ— æ³•è¢«æœ‰æ•ˆåˆ©ç”¨ï¼ˆå¦‚ä½¿ç”¨äº†å‡½æ•°æˆ–è®¡ç®—ï¼‰ï¼Œç´¢å¼•ä¹Ÿä¼šå¤±æ•ˆï¼Œä»è€Œå½±å“æŸ¥è¯¢æ€§èƒ½ã€‚

### 2. ç¡¬ä»¶èµ„æºé™åˆ¶

- **I/Oååé‡å°**ï¼šç£ç›˜I/Oæ€§èƒ½ç“¶é¢ˆä¼šé™åˆ¶æ•°æ®çš„è¯»å–é€Ÿåº¦ï¼Œä»è€Œå½±å“æŸ¥è¯¢æ€§èƒ½ã€‚
- **å†…å­˜ä¸è¶³**ï¼šå¦‚æœæ•°æ®åº“æœåŠ¡å™¨çš„å†…å­˜ä¸è¶³ä»¥ç¼“å­˜è¶³å¤Ÿçš„æ•°æ®å’Œç´¢å¼•ï¼Œå°†å¯¼è‡´é¢‘ç¹çš„ç£ç›˜I/Oæ“ä½œï¼Œä»è€Œé™ä½æŸ¥è¯¢é€Ÿåº¦ã€‚
- **ç½‘ç»œé€Ÿåº¦æ…¢**ï¼šå¦‚æœæ•°æ®åº“æœåŠ¡å™¨ä¸åº”ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥é€Ÿåº¦è¾ƒæ…¢ï¼Œæ•°æ®ä¼ è¾“å°†å—åˆ°å½±å“ï¼Œå¯¼è‡´æŸ¥è¯¢å“åº”å˜æ…¢ã€‚

### 3. æŸ¥è¯¢è¯­å¥é—®é¢˜

- **æŸ¥è¯¢è¯­å¥æœªä¼˜åŒ–**ï¼šå¤æ‚çš„æŸ¥è¯¢è¯­å¥ã€ä¸æ°å½“çš„è¿æ¥æ¡ä»¶ã€ä¸å¿…è¦çš„å­æŸ¥è¯¢ç­‰éƒ½å¯èƒ½é™ä½æŸ¥è¯¢æ€§èƒ½ã€‚
- **æŸ¥è¯¢å‡ºçš„æ•°æ®é‡è¿‡å¤§**ï¼šå¦‚æœæŸ¥è¯¢è¿”å›çš„æ•°æ®é‡éå¸¸å¤§ï¼Œå°†å¢åŠ æ•°æ®ä¼ è¾“å’Œå¤„ç†çš„æ—¶é—´ã€‚

### 4. å¹¶å‘å’Œé”ç«äº‰

- **é”æˆ–æ­»é”**ï¼šåœ¨é«˜å¹¶å‘çš„ç¯å¢ƒä¸­ï¼Œå¤šä¸ªæŸ¥è¯¢æˆ–äº‹åŠ¡å¯èƒ½ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”èµ„æºï¼Œä»è€Œå¯¼è‡´é”ç«äº‰æˆ–æ­»é”ï¼Œè¿›è€Œå½±å“æŸ¥è¯¢æ€§èƒ½ã€‚
- **è¯»å†™ç«äº‰èµ„æº**ï¼šå¦‚`sp_lock`ã€`sp_who`ç­‰æ´»åŠ¨ç”¨æˆ·æŸ¥çœ‹å·¥å…·æ˜¾ç¤ºçš„ä¿¡æ¯å¯èƒ½è¡¨æ˜å­˜åœ¨è¯»å†™ç«äº‰èµ„æºçš„æƒ…å†µã€‚

### 5. æ•°æ®åº“è®¾è®¡å’Œé…ç½®é—®é¢˜

- **æ•°æ®åº“è®¾è®¡ä¸åˆç†**ï¼šå¦‚æ•°æ®å†—ä½™ã€æ•°æ®ç±»å‹é€‰æ‹©ä¸å½“ç­‰éƒ½å¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½ã€‚
- **é…ç½®ä¸å½“**ï¼šå¦‚æ•°æ®åº“æœåŠ¡å™¨çš„è‡ªåŠ¨å¢é•¿è®¾ç½®ä¸å½“ã€ç¼“å­˜å¤§å°é…ç½®ä¸åˆç†ç­‰éƒ½å¯èƒ½å½±å“æ•°æ®åº“çš„æ€§èƒ½ã€‚

### 6. å…¶ä»–å› ç´ 

- **æ²¡æœ‰åˆ›å»ºè®¡ç®—åˆ—**ï¼šè¿™å¯èƒ½å¯¼è‡´æŸ¥è¯¢ä¸ä¼˜åŒ–ï¼Œå› ä¸ºæ•°æ®åº“æ— æ³•åˆ©ç”¨è®¡ç®—åˆ—ä¸Šçš„ç´¢å¼•ã€‚
- **ä½¿ç”¨äº†æ¸¸æ ‡**ï¼šæ¸¸æ ‡åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶å¯èƒ½ä¼šéå¸¸æ…¢ï¼Œå› ä¸ºå®ƒéœ€è¦é€è¡Œå¤„ç†æ•°æ®ã€‚

### è§£å†³æ–¹æ¡ˆ

é’ˆå¯¹ä¸Šè¿°åŸå› ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹ä¸€äº›è§£å†³æ–¹æ¡ˆæ¥ä¼˜åŒ–SQLæŸ¥è¯¢æ€§èƒ½ï¼š

- **ä¼˜åŒ–ç´¢å¼•**ï¼šç¡®ä¿æŸ¥è¯¢çš„åˆ—ä¸Šæœ‰é€‚å½“çš„ç´¢å¼•ï¼Œå¹¶é¿å…ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µã€‚
- **ä¼˜åŒ–æŸ¥è¯¢è¯­å¥**ï¼šç®€åŒ–æŸ¥è¯¢è¯­å¥ã€ä½¿ç”¨è¿æ¥ä»£æ›¿å­æŸ¥è¯¢ã€é™åˆ¶è¿”å›çš„æ•°æ®é‡ç­‰ã€‚
- **æå‡ç¡¬ä»¶èµ„æº**ï¼šå¢åŠ å†…å­˜ã€ä½¿ç”¨æ›´å¿«çš„ç£ç›˜ï¼ˆå¦‚SSDï¼‰ç­‰ã€‚
- **è°ƒæ•´æ•°æ®åº“é…ç½®**ï¼šå¦‚è®¾ç½®åˆç†çš„è‡ªåŠ¨å¢é•¿ç­–ç•¥ã€è°ƒæ•´ç¼“å­˜å¤§å°ç­‰ã€‚
- **ä¼˜åŒ–æ•°æ®åº“è®¾è®¡**ï¼šé¿å…æ•°æ®å†—ä½™ã€é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ç­‰ã€‚
- **ä½¿ç”¨æ•°æ®åº“æ€§èƒ½åˆ†æå·¥å…·**ï¼šå¦‚Profilerã€EXPLAINç­‰æ¥åˆ†ææŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’å’Œæ€§èƒ½ç“¶é¢ˆã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒSQLæŸ¥è¯¢æ…¢çš„åŸå› å¤šç§å¤šæ ·ï¼Œéœ€è¦ç»“åˆå…·ä½“çš„æŸ¥è¯¢è¯­å¥ã€æ•°æ®åº“è®¾è®¡ã€ç¡¬ä»¶é…ç½®å’Œå¹¶å‘æƒ…å†µç­‰å› ç´ è¿›è¡Œç»¼åˆåˆ†æå’Œä¼˜åŒ–ã€‚



## `CPU`ä½¿ç”¨ç‡é«˜å¦‚ä½•æ’æŸ¥å’Œè§£å†³

> todo å®Œå–„
>
> todo æ€ä¹ˆé€šè¿‡events_statements_summary_by_digestçŸ¥é“sqlæ˜¯å¦ioæ…¢ã€å†…å­˜ä¸è¶³å‘¢ï¼Ÿ

æ’æŸ¥æ–¹æ³•å¦‚ä¸‹ï¼š

- æŸ¥çœ‹ç³»ç»Ÿç›¸å…³è´Ÿè½½ï¼Œæ˜¯å¦`io`æ…¢ç­‰
- ä½¿ç”¨`show full processlist`å‘½ä»¤æŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„`SQL`ï¼Œæ‰¾å‡º`Time`åˆ—æ—¶é—´ï¼ˆç§’æ•°ï¼‰æ¯”è¾ƒé•¿çš„`SQL`
- æŸ¥çœ‹`performance_schema.events_statements_summary_by_digest`åˆ†æå“ªäº›`SQL`æ¯”è¾ƒç¹å¿™
- åˆ†ææ…¢æ—¥å¿—åï¼Œä½¿ç”¨`explain`å‘½ä»¤åˆ†ææ…¢`SQL`

æ¨¡æ‹Ÿå®éªŒï¼š

1. è¿è¡Œ [demo-mybatis-plus-assistant](https://gitee.com/dexterleslie/demonstration/tree/master/demo-mysql-n-mariadb/demo-mybatis-plus-assistant) é¡¹ç›®ï¼ŒååŠ©æ¨¡æ‹Ÿåˆ†æ`MySQL cpu`ä½¿ç”¨ç‡é«˜æƒ…å†µ

   ```bash
   # ç¼–è¯‘é¡¹ç›®
   mvn package
   
   # å¯åŠ¨æ•°æ®åº“æœåŠ¡
   docker compose up -d
   
   # åˆå§‹åŒ–æµ‹è¯•æ•°æ®
   # è¿è¡Œjunitæµ‹è¯•DatumPreparationTestsåˆå§‹åŒ–æ•°æ®
   
   # è¿è¡Œjunitæµ‹è¯•ApplicationTests.testæµ‹è¯•æ¨¡æ‹Ÿcpuä½¿ç”¨ç‡é«˜
   ```

2. ä½¿ç”¨`show full processlist`å‘½ä»¤æŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„`SQL`ï¼Œè§‚å¯Ÿ`Time`æ¯”è¾ƒé•¿çš„`SQL`

   ```bash
   show full processlist\G;
   ```

3. æŸ¥çœ‹`performance_schema.events_statements_summary_by_digest`è¡¨åˆ†ææ‰¾åˆ°å¯¹åº”æœ‰å¯ä»¥é—®é¢˜çš„`SQL`

   ```bash
   select * from performance_schema.events_statements_summary_by_digest\G;
   
   # ä½¿ç”¨explainå‘½ä»¤åˆ†æsqlæ˜¯å¦å­˜åœ¨é—®é¢˜
   ```

4. ä»æ…¢æ—¥å¿—æ‰¾å‡ºæ…¢`SQL`åï¼Œä½¿ç”¨`explain`å‘½ä»¤åˆ†ææ…¢`SQL`

todo è§£å†³`cpu`ä½¿ç”¨ç‡é«˜ï¼š

å¤‡ä»½

```
https://stackoverflow.com/questions/45584065/cannot-find-oltp-test-on-sysbench

# MySQLæ€§èƒ½æµ‹è¯•
# å‡†å¤‡æµ‹è¯•æ•°æ®
sysbench --db-driver=mysql --mysql-user=root --mysql-password=123456 \
  --mysql-host=192.168.1.193 --mysql-port=50000 --mysql-db=demo_db --range_size=100 \
  --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 \
  --rand-type=uniform /usr/share/sysbench/oltp_read_only.lua prepare

# è¿è¡Œæµ‹è¯•
sysbench --db-driver=mysql --mysql-user=root --mysql-password=123456 \
  --mysql-host=192.168.1.193 --mysql-port=50000 --mysql-db=demo_db --range_size=100 \
  --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 \
  --rand-type=uniform /usr/share/sysbench/oltp_read_only.lua run
  
# æ¸…ç†æµ‹è¯•æ•°æ® 
sysbench --db-driver=mysql --mysql-user=root --mysql-password=123456 \
  --mysql-host=192.168.1.193 --mysql-port=50000 --mysql-db=demo_db --range_size=100 \
  --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 \
  --rand-type=uniform /usr/share/sysbench/oltp_read_only.lua cleanup
```

