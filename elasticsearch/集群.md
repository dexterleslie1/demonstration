## 概念

这是一个从基础概念到核心原理，再到实践部署的全方位指南。

---

### 1. 什么是 Elasticsearch 集群？

一个 **Elasticsearch 集群** 是由一个或多个 **节点**（Node）组成的集合，它们共同存储数据，并提供联合索引和搜索功能。一个集群有一个唯一的名称（默认为 `elasticsearch`），通过这个名称来标识属于同一个集群的节点。

你可以把它想象成一个由多台服务器组成的“超级搜索引擎”，这些服务器协同工作，对外提供一个统一的服务入口。

#### 核心优势：
*   **高可用性**：即使某个节点宕机，其他节点依然可以处理请求，服务不会中断。
*   **可扩展性**：可以通过增加节点来轻松扩展存储容量和处理能力，以应对海量数据和查询压力。
*   **高性能**：数据被分散存储在多个节点上，并行处理搜索和索引请求，速度更快。

---

### 2. 集群的核心概念与组件

要理解集群，必须先了解其组成单元：

#### a. 节点 (Node)
节点是 Elasticsearch 集群中的一个运行实例（即一台服务器上的一个 ES 进程）。根据角色和功能，节点可以分为：

1.  **主节点 (Master Node)**
    *   **职责**：负责管理集群状态，如创建或删除索引、跟踪哪些节点是集群的一部分、决定将哪些分片分配给哪个节点等。**它不负责处理数据相关的操作**。
    *   **特点**：负载很高，对稳定性和资源（CPU、内存）要求高。通常建议设置为**专用节点**，不处理数据读写。
    *   **配置**：`node.master: true`

2.  **数据节点 (Data Node)**
    *   **职责**：负责存储数据、执行与数据相关的操作（CRUD、搜索、聚合等）。是集群中工作量最大的节点。
    *   **特点**：对磁盘 I/O、内存和 CPU 要求高。随着数据量的增长，需要规划更多的数据节点。
    *   **配置**：`node.data: true`

3.  **协调节点 (Coordinating Node)**
    *   **职责**：客户端请求首先会发送到协调节点。协调节点将请求路由到正确的节点（如包含目标分片的节点），收集结果并合并，然后返回给客户端。它本身不存储数据也不参与主节点选举。
    *   **特点**：所有节点默认都是协调节点。在高并发场景下，可以设置**专用协调节点**来分担负载，提升性能。
    *   **配置**：`node.master: false`, `node.data: false`

4.  ** ingest 节点 (Ingest Node)**
    *   **职责**：在数据被索引之前，对文档进行预处理（如 pipeline 中的 enrich, convert, split 等操作）。
    *   **特点**：如果使用了复杂的 ingest pipeline，可以设置专用 ingest 节点。
    *   **配置**：`node.ingest: true`

5.  **机器学习节点 (Machine Learning Node)** & **专有主节点 (Voting-only Master Node)**
    *   用于更高级的功能，如 X-Pack 的机器学习特性。

> **最佳实践**：在生产环境中，通常会根据硬件资源和业务需求，将节点角色分离，例如部署专用的 Master 节点、专用的 Data 节点和专用的 Coordinating 节点。

#### b. 索引 (Index)
一个索引类似于传统关系型数据库中的一个“数据库”或一张“表”。它是具有相似特征的文档的集合。在集群中，**一个索引的数据会被分布到多个节点上**。

#### c. 分片 (Shard) - 分布式存储的关键
由于单台机器的存储和处理能力有限，Elasticsearch 将一个索引的数据分割成多个部分，每个部分就是一个 **分片 (Primary Shard)**。分片是 Elasticsearch 实现水平扩展和高可用性的基石。

*   **主分片 (Primary Shard)**：写入数据时，首先写入主分片。索引创建时需要指定主分片的数量（创建后不可更改！），默认为 1。这个数量决定了该索引最多能存储多少数据（理论上无限，通过增加分片数）。
*   **副本分片 (Replica Shard)**：每个主分片可以有零个或多个副本分片。副本分片是主分片的完整拷贝。
    *   **作用**：
        1.  **高可用性**：当主分片所在的节点宕机时，副本分片会被提升为新的主分片，保证数据不丢失和服务可用。
        2.  **提高读取性能**：搜索请求可以在主分片和所有副本分片上并行执行，从而提升吞吐量。

**示例**：创建一个有 3 个主分片和 1 个副本分片的索引。
*   总主分片数：3
*   总副本分片数：3 (因为 3个主分片 × 1个副本 = 3个副本分片)
*   该索引总共分布在集群中的分片数：6 (3主 + 3副本)
*   这 6 个分片会根据集群的分配规则，分布在不同的数据节点上。

---

### 3. 集群的发现与通信机制

节点如何知道彼此并组成一个集群？

1.  **种子节点 (Seed Hosts)**：新启动的节点需要知道一些已有的节点地址才能加入集群。这些已知的节点列表就是种子节点列表。通常在 `discovery.seed_hosts` 中配置。
2.  **Zen Discovery**：Elasticsearch 内置的发现机制，用于节点间的握手、选举主节点和维护集群状态。在 7.x 版本之后，逐渐被更强大的 **集群协调 (Cluster Coordination)** 模块取代。
3.  **集群状态 (Cluster State)**：由主节点维护的一个包含所有索引元数据（映射、设置）、节点信息以及分片位置信息的对象。所有节点都会持有这份状态的副本，并通过发布订阅模式与主节点保持同步。

---

### 4. 一个简单的集群搭建与管理示例

假设我们有三台机器：`es-node-1`, `es-node-2`, `es-node-3`。我们计划部署一个小型但高可用的生产集群。

#### a. 配置文件 (`elasticsearch.yml`)

**es-node-1 (初始主节点候选)**
```yaml
# 集群名称，必须相同
cluster.name: my-prod-cluster

# 节点名称，每台不同
node.name: node-1

# 节点角色：我们让它成为候选主节点和数据节点
node.roles: [ master, data ]

# 网络设置，允许其他节点访问
network.host: 0.0.0.0 # 或者指定IP
http.port: 9200

# 发现设置
discovery.seed_hosts: ["es-node-1-ip", "es-node-2-ip", "es-node-3-ip"]
cluster.initial_master_nodes: ["node-1", "node-2", "node-3"] # 初始主节点列表

# 防止脑裂，只有拥有多数票的候选主节点才能成为主节点
# 公式： (master_eligible_nodes / 2) + 1
# 这里我们有3个候选主节点，所以 quorum = (3/2)+1 = 2
discovery.zen.minimum_master_nodes: 2 # 对于旧版本Zen Discovery
# 新版本使用 cluster.auto_shrink_voting_configuration: true 自动管理
```

**es-node-2 & es-node-3**
区别仅在于 `node.name` 不同，其他配置类似。可以将它们也设为 `[master, data]` 角色，形成一个有多个候选主节点的健壮集群。

#### b. 启动与验证

1.  在三台机器上分别启动 Elasticsearch。
2.  等待所有节点加入集群。
3.  访问任意节点的 `_cat/nodes` API 查看集群状态：
    ```bash
    curl http://es-node-1-ip:9200/_cat/nodes?v
    ```
    输出应显示三个节点，其中一个标记为 `*`（当前主节点）。

4.  检查集群健康状态：
    ```bash
    curl http://es-node-1-ip:9200/_cluster/health?pretty
    ```
    关注 `"status"` 字段：
    *   `green`：**所有主分片和副本分片都已分配且可用**。集群完全健康。
    *   `yellow`：**所有主分片都已分配，但至少有一个副本分片未分配**。这通常发生在只有一个数据节点时（副本无法分配到不同节点）。对于单节点测试环境是正常的。
    *   `red`：**至少有一个主分片未分配**。此时数据丢失，集群不可用。

---

### 5. 生产环境部署建议

1.  **节点角色分离**：至少部署 3 个专用的 Master 节点（奇数个以避免脑裂），外加多个 Data 节点和可选的 Coordinating 节点。
2.  **JVM 堆大小**：不要超过物理内存的 50%，且不超过 32GB（避免 JVM 指针压缩失效）。剩余内存留给操作系统文件系统缓存，这对搜索性能至关重要。
3.  **磁盘**：使用 SSD。避免使用 NFS 等网络存储。监控磁盘使用率，设置水位线 (`cluster.routing.allocation.disk.watermark.*`) 以防止磁盘写满。
4.  **安全**：务必启用 Elasticsearch 的安全功能（X-Pack Security），设置 TLS 加密通信和密码认证。
5.  **备份**：定期使用 **快照和恢复 (Snapshot and Restore)** 功能对索引进行备份。
6.  **监控**：使用 Kibana 的 Monitoring 功能或 Prometheus/Grafana 来持续监控集群的健康状况、性能指标和资源使用情况。

### 总结

Elasticsearch 集群是一个复杂而强大的分布式系统。其核心设计哲学是通过 **分片** 实现水平扩展，通过 **副本** 实现高可用，通过 **节点角色分工** 实现资源优化。理解这些基本概念和组件，是成功设计、部署和管理一个高效、稳定 ES 集群的关键。