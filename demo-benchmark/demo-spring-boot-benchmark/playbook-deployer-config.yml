- name: "复制deployer"
  hosts: "{{ groups['all'] | difference(groups['management']) }}"
  tasks:
    - name: "复制deployer目录到远程"
      copy:
        src: deployer/
        dest: ~/deployer-spring-boot-benchmark

- name: "配置Prometheus服务的deployer"
  hosts: common
  tasks:
    - name: "配置Prometheus服务的prometheus.yml"
      template:
        src: deployer/prometheus/prometheus.yml.j2
        dest: ~/deployer-spring-boot-benchmark/prometheus/prometheus.yml

- name: "配置openresty服务的deployer"
  hosts: openresty
  tasks:
    - name: "配置OpenResty服务的nginx.conf"
      template:
        src: deployer/openresty/nginx.conf.j2
        dest: ~/deployer-spring-boot-benchmark/openresty/nginx.conf

- name: "配置api服务的deployer"
  hosts: api
  tasks:
    - name: "配置api service服务的java_opts"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service/.env
        regexp: "^java_opts="
        line: "java_opts={{ java_opts }}"
    - name: "配置api service服务的server_port"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service/.env
        regexp: "^server_port="
        line: "server_port={{ server_port }}"
    - name: "配置api service服务的actuator_port"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service/.env
        regexp: "^actuator_port="
        line: "actuator_port={{ actuator_port }}"

    - name: "配置api service2服务的java_opts"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service2/.env
        regexp: "^java_opts="
        line: "java_opts={{ java_opts }}"
      when: server_port2 is defined
    - name: "配置api service2服务的server_port"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service2/.env
        regexp: "^server_port="
        line: "server_port={{ server_port2 }}"
      when: server_port2 is defined
    - name: "配置api service2服务的actuator_port"
      lineinfile:
        path: ~/deployer-spring-boot-benchmark/service2/.env
        regexp: "^actuator_port="
        line: "actuator_port={{ actuator_port2 }}"
      when: server_port2 is defined
