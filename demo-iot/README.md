## IoT概念

### 一句话概括 IoT

**IoT（物联网）就是让原本“沉默”的物体通过互联网“开口说话”，让它们能够被感知、被控制、甚至相互交流。**

---

### 核心思想：万物互联

传统的互联网主要是人与人的连接（比如你用电脑、手机上网与人交流）。而 **物联网的核心是“物与物”、“物与人”的连接**。

这里的“物”可以是任何东西：
*   **家用电器**：灯泡、空调、冰箱、扫地机器人
*   **日常物品**：手表、门锁、体重秤
*   **城市设施**：路灯、停车位、监控摄像头
*   **工业设备**：工厂的机器、农场的传感器、物流包裹

### IoT 是如何工作的？

一个典型的 IoT 系统通常包含四个关键部分，就像一个协同工作的团队：

1.  **感知层（感官）**：设备上的**传感器** 负责收集数据。比如，温度传感器感知室温，摄像头捕捉图像，GPS 模块定位位置。
2.  **网络层（神经）**：通过**网络**（如 Wi-Fi、蓝牙、5G、LoRa）将收集到的数据安全地传输到处理中心。
3.  **平台层（大脑）**：**云平台或服务器** 对海量数据进行分析、处理和管理。比如，判断室温是否过高，或者发现设备异常。
4.  **应用层（手脚）**：根据平台的指令，**执行器** 会采取行动，或者将信息呈现给用户。比如，远程关闭空调，或在你的手机App上发送警报。

**举个例子：智能农业**
*   **感知**：土壤里的湿度传感器检测到土地干旱了。
*   **传输**：传感器通过无线网络将这个“我渴了”的信号发送到云平台。
*   **处理**：云平台分析数据后，判断需要浇水。
*   **执行**：平台向灌溉系统的阀门发出指令，阀门自动打开进行浇水。同时，农场主的手机可能会收到一条通知：“农田A区已开始灌溉”。

### 生活中的 IoT 应用实例

IoT 已经深入我们生活的方方面面：

*   **智能家居**：用手机远程控制家里的灯光、空调；智能门铃有人按门铃时，你可以在手机上看到是谁；扫地机器人自动规划路线清扫。
*   **可穿戴设备**：智能手表/手环监测你的心率、步数和睡眠质量，并将数据同步到手机App上。
*   **智慧城市**：智能路灯根据人流量和天色自动调节亮度；智能停车系统引导你找到空车位。
*   **车联网**：汽车可以将实时路况数据上传到云端，帮助地图App规划更优路线，实现自动驾驶的雏形。
*   **工业物联网**：工厂里的机器可以预测自身何时需要维护，避免突然停机。

### 总结 IoT 的价值

IoT 的最终目的是**提升效率、节约资源、带来更智能、更便捷的体验**。它让物理世界和数字世界深度融合，为我们创造了巨大的可能性。

## 主流开源的MQTT代理

>提示：学习过程使用EMQX作为代理。

目前主流且活跃的开源 MQTT 代理（Broker）主要有以下几个，它们各有特点和适用场景，我来为你详细介绍一下。

### 主流开源 MQTT 代理一览

| 名称          | 开发语言 | 特点                                                         | 适用场景                                         |
| :------------ | :------- | :----------------------------------------------------------- | :----------------------------------------------- |
| **EMQX**      | Erlang   | **高性能、分布式、云原生**。单机支持百万级连接，集群稳定。功能极其丰富（规则引擎、数据桥接等）。 | 大规模物联网平台、车联网、关键业务系统。         |
| **Mosquitto** | C        | **轻量级、稳定、易于部署**。Eclipse 项目，是 MQTT 协议的标准参考实现。 | 初学者学习、小型项目、嵌入式系统、资源受限环境。 |
| **NanoMQ**    | C        | **边缘计算首选、超轻量级**。专为边缘侧设计，资源占用极低，支持多种总线协议。 | 物联网边缘计算、嵌入式 MQTT 网关。               |
| **HiveMQ**    | Java     | **企业级、高可靠、功能全面**。社区版功能强大，企业版提供高级支持和服务。 | 对稳定性和企业级支持有要求的大中型项目。         |
| **Vernemq**   | Erlang   | **高性能、可分布式集群**。专为高并发、低延迟场景优化，插件系统灵活。 | 需要高吞吐量和可靠性的实时消息系统。             |
| **Aedes**     | Node.js  | **轻量级、基于 Node.js**。方便与 Node.js 技术栈集成，适合快速原型开发。 | Node.js 全栈开发、快速原型验证、中小型应用。     |

---

### 详细介绍与选择建议

#### 1. EMQX
- **官网：** https://www.emqx.io/
- **简介：** 这是目前性能最强大、功能最全面的开源 MQTT 代理之一。使用 Erlang/OTP 平台开发，天生具备高并发和分布式能力。
- **核心优势：**
    - **极致性能：** 官方宣称单节点可支持 500 万 MQTT 连接。
    - **集群能力：** 集群功能成熟稳定，易于横向扩展。
    - **生态丰富：** 内置强大的**规则引擎**，可以轻松地将 MQTT 消息与数据库（如 MySQL, PostgreSQL, Redis, MongoDB）、消息队列（如 Kafka, RocketMQ）及云服务（如 AWS S3）进行集成。
    - **云原生友好：** 支持 Kubernetes 部署，有完整的 Operator 项目。
- **选择建议：** 如果你的项目面向海量设备连接、需要高可用集群、或者有复杂的数据集成需求（例如将设备数据存入数据库或转发到 Kafka），EMQX 是首选。

#### 2. Mosquitto
- **官网：** https://mosquitto.org/
- **简介：** 由 Eclipse 基金会维护，是最老牌、最经典的开源 MQTT 代理，可以说是 MQTT 协议的“官方参考实现”。
- **核心优势：**
    - **极其轻量：** 占用资源非常少，安装包只有几百 KB。
    - **极其稳定：** 经过长期、广泛的实践检验，非常稳定可靠。
    - **部署简单：** 配置简单，上手极快。
- **选择建议：** 这是**初学者入门 MQTT 的最佳选择**。也适用于设备数量不多（例如几千以下）的小型项目、测试环境、资源紧张的嵌入式设备（如树莓派）等。它是功能完整性的基准。

#### 3. NanoMQ
- **官网：** https://nanomq.io/
- **简介：** EMQ 公司推出的面向边缘计算的轻量级 MQTT 代理，是 EMQX 在边缘侧的完美补充。
- **核心优势：**
    - **超轻量：** 专为资源受限的边缘设备设计，资源占用极低。
    - **边缘特性：** 内置了消息持久化、数据缓存和断线重传等边缘场景必需的功能。
    - **多协议网关：** 除了 MQTT，还可以作为 **NanoSDK** 支持 DDS、ZMQ、Nanomsg/NNG 等协议的总线网关。
- **选择建议：** 如果你的应用场景是**物联网边缘网关**，需要在网关上进行消息汇聚、协议转换或边缘计算，NanoMQ 是不二之选。

#### 4. HiveMQ
- **官网：** https://www.hivemq.com/
- **简介：** 一个基于 Java 开发的企业级 MQTT 代理，社区版功能已经非常强大。
- **核心优势：**
    - **企业级支持：** 背后有商业公司提供专业的技术支持和企业版服务。
    - **高可靠性：** 在设计上非常注重企业级部署的稳定性和可靠性。
    - **扩展性强：** 提供了完善的 SDK 和插件系统，方便定制开发。
- **选择建议：** 适合对稳定性、售后服务和技术支持有较高要求的企业级用户，特别是那些计划从社区版平滑过渡到企业版的团队。

### 如何选择？

你可以根据以下流程来快速决策：

1.  **你是初学者或个人开发者，只是想学习和搭建简单的 demo？**
    *   **推荐：Mosquitto**。简单、稳定、够用。

2.  **你的项目是中小规模（连接数在几万以内），没有复杂的集成需求？**
    *   **推荐：Mosquitto 或 Aedes**。Mosquitto 更通用，Aedes 适合 Node.js 技术栈。

3.  **你的项目是大型物联网平台，需要支撑海量设备（数十万到百万级连接），并且需要高可用集群和数据集成？**
    *   **推荐：EMQX**。它的性能和功能是为这种场景量身定制的。

4.  **你的场景是边缘计算，需要在网关上运行一个轻量级的代理？**
    *   **推荐：NanoMQ**。它是专为边缘侧设计的。

5.  **你的项目是企业级应用，非常看重稳定性和官方商业支持？**
    *   **推荐：HiveMQ 或 EMQX 企业版**。可以优先试用它们的社区版，再根据需求考虑商业支持。

## 为何MQTT客户端必须连接代理服务器呢？

**MQTT客户端必须连接代理服务器，因为代理服务器是整个MQTT通信架构的核心枢纽，负责所有消息的接收、过滤和分发。**

我们可以通过一个生动的比喻来理解：

*   **MQTT客户端** 就像是一个个的**邮递员**或**收信人**。
*   **MQTT代理服务器** 就像是一个庞大、高效的**中央邮局**。
*   **消息** 就是一封封信件、包裹。

---

### 如果没有代理服务器（直接通信）会怎样？

想象一下，如果世界上没有邮局，每个想寄信的人（发布者）都需要自己记住所有收信人（订阅者）的地址，然后亲自把信送到每个人手里。对于一个要给成千上万人发送消息的设备来说，这是完全不可能的！它需要知道所有订阅者的网络地址，并且要建立和维护与每个订阅者的连接，这会导致：

1.  **网络负担极重**：消息发送者（Publisher）的网络带宽和计算资源会迅速耗尽。
2.  **可扩展性极差**：每增加一个新的订阅者，所有相关的发布者都需要更新配置并建立新连接。
3.  **能耗极高**：对于使用电池的物联网设备（如传感器）来说，这是致命的。
4.  **管理混乱**：设备离线、上线、更换IP地址等情况会使得直接通信难以维护。

---

### 连接代理服务器的核心原因（“中央邮局”的作用）

代理服务器的引入，完美地解决了上述问题，它的核心作用包括：

**1. 解耦发布者和订阅者**
这是最重要的原因。发布者完全不需要知道订阅者是谁、在哪里、有多少个。它只需要把消息“扔”给代理服务器，然后就可以继续自己的工作。同样，订阅者也不需要知道发布者是谁，它只需要告诉代理服务器：“我对某某主题的消息感兴趣”。这种**空间、时间和管理上的解耦**，使得系统极具弹性和可扩展性。

**2. 消息的路由与分发**
代理服务器根据**主题** 来管理消息。当客户端发布一条消息到某个主题（例如 `sensor/temperature/living_room`）时，代理服务器会检查有哪些客户端订阅了这个主题，然后将消息准确地转发给所有这些订阅者。这就是“邮局”的分拣和投递工作。

**3. 会话持久化与离线消息**
对于不稳定的网络（物联网的典型场景），客户端可能会频繁断开连接。代理服务器可以为客户端存储**持久化会话**。当客户端设置了一个持久化会话并断开连接时：
*   代理服务器会记录该客户端的订阅信息。
*   如果客户端订阅了**服务质量等级为1或2** 的消息，代理服务器可以为其暂存离线期间的消息，并在其重新上线后立即送达。这确保了重要消息不丢失。

**4. 安全与授权**
代理服务器是系统的安全门户。它可以：
*   **身份验证**：要求客户端提供用户名和密码或证书来验证身份。
*   **授权**：控制哪些客户端可以发布或订阅特定主题，实现精细的访问控制。

**5. 减轻客户端负担**
对于资源受限的物联网设备（如传感器、执行器），它们的计算能力、内存和电量都非常有限。让它们只与一个固定的代理服务器进行轻量级通信，而不是与无数个对等端通信，极大地降低了它们的资源消耗，延长了电池寿命。

**6. 可扩展性与高可用性**
通过使用集群技术，多个代理服务器可以组成一个集群，共同处理海量的客户端连接和消息流，提供高可用性和水平扩展能力，以支撑百万甚至千万级别的设备连接。

### 总结

| 特性           | 没有代理服务器（直接通信）     | 有MQTT代理服务器                   |
| :------------- | :----------------------------- | :--------------------------------- |
| **耦合度**     | 紧耦合，发布者需知订阅者详情   | **松耦合**，双方互不知晓           |
| **可扩展性**   | 差，新增订阅者需通知所有发布者 | **极佳**，轻松扩展客户端数量       |
| **资源消耗**   | 发布者负担极重                 | **客户端负担轻**，代理承担主要工作 |
| **网络稳定性** | 处理离线、断线困难             | **支持会话持久化和离线消息**       |
| **安全性**     | 分散，难以管理                 | **集中式安全管控**                 |

因此，**MQTT代理服务器是MQTT协议实现其轻量级、高效率、高可靠性通信的基石**。它通过中心化的消息调度，完美适配了物联网场景中设备数量庞大、网络不稳定、设备资源受限的核心特点。

## 为何MQTT消息传递是发布订阅模式呢？

MQTT 选择发布/订阅模式是因为它**完美地契合了物联网场景的核心需求：解耦、可扩展性和灵活性**。

让我们来详细拆解一下，如果不用发布/订阅，而用更常见的“客户端-服务器”或“请求-响应”模式会有什么问题，你就能明白为什么发布/订阅是更优解了。

### 场景对比：请求-响应 vs. 发布-订阅

想象一个智能家居系统，有一个温度传感器和一个智能空调。

**1. 如果使用“请求-响应”模式（像 HTTP 一样）：**

*   **工作方式**：服务器（或空调）必须不断地向温度传感器“请求”当前的温度值：“你好，温度现在是多少？” 传感器回答：“25度”。过一会儿，再问一次。
*   **存在的问题**：
    *   **高延迟**：空调只有在主动询问时才能获得新数据。如果温度在两次请求之间突然变化，空调无法立即感知，反应会慢半拍。
    *   **效率低下**：无论温度是否变化，都会产生大量的网络请求和应答。对于电池供电的传感器来说，这是巨大的能量浪费。
    *   **耦合紧密**：空调必须知道传感器的地址并主动管理通信。如果现在你想让手机App也能显示温度，App也需要不断地向传感器轮询，这会使系统变得非常复杂和脆弱。添加一个新的数据消费者（比如一个温湿度显示器）会很麻烦。

**2. 使用“发布-订阅”模式（MQTT 的方式）：**

*   **工作方式**：
    *   温度传感器不再等待被询问。它只在自己觉得有必要时（例如温度变化超过1度，或每隔一段时间）向一个名为 `home/livingroom/temperature` 的“主题”**发布**一条消息。
    *   空调和手机App只需要**订阅**它们感兴趣的主题 `home/livingroom/temperature`。
    *   MQTT 代理（服务器）负责将传感器发来的消息，**立即**转发给所有订阅了该主题的设备（空调和App）。
*   **带来的优势**：
    *   **空间解耦**：发布者（传感器）不知道，也不关心有多少个订阅者（空调、App、甚至其他传感器）。它只负责向代理发送消息。同样，订阅者也不知道发布者是谁，它们只从代理接收消息。双方只需要认识代理和约定的“主题”即可。
    *   **时间解耦**：发布者和订阅者不需要同时在线。如果空调暂时离线，代理可以为其保留消息（需要设置服务质量等级），等空调重连后再次发送。这非常适合不稳定的物联网网络。
    *   **一对一、一对多、多对多通信**：一个温度读数可以被无数个设备接收。同样，多个传感器（如温度、湿度）可以发布到不同的主题，一个智能中枢可以订阅所有主题，实现集中处理。这种灵活性是请求-响应模式难以实现的。
    *   **高效与实时**：网络流量只发生在数据真正变化时。一旦有新数据，代理会立即推送给所有相关方，延迟极低。

### 为什么这种模式特别适合物联网？

物联网应用通常具有以下特点，而发布/订阅模式正好对症下药：

| 物联网需求           | 发布/订阅模式如何满足                                        |
| :------------------- | :----------------------------------------------------------- |
| **受限的网络和设备** | 消息头极小，协议简洁，减少带宽和电量消耗。                   |
| **不稳定的网络连接** | 通过解耦和消息保留机制，设备断线重连后不影响整体系统。       |
| **海量设备接入**     | 易于水平扩展。可以增加多个 MQTT 代理组成集群来应对海量连接，设备间的通信关系通过主题动态管理，非常灵活。 |
| **事件驱动**         | 本质上是事件驱动的。数据在“事件”发生时（如传感器读数变化、按钮被按下）才产生和传播，而不是无意义的轮询。 |
| **多样化的应用场景** | 主题的层级结构（如 `city/beijing/building/1/floor/3/temperature`）提供了巨大的灵活性，可以轻松地组织和管理数百万设备的通信。 |

### 总结

所以，MQTT 选择发布/订阅模式并非偶然，而是经过深思熟虑的设计决策。它将通信的复杂性从终端设备转移到了中央代理（Broker），使得**轻量级、低功耗、网络状况多变的物联网设备**能够以一种**高效、解耦、可扩展**的方式进行通信，这正是物联网架构所梦寐以求的特性。

## Docker Compose运行EMQX

>详细用法请参考本站示例：https://gitee.com/dexterleslie/demonstration/tree/main/demo-iot/docker-compose.yaml

docker-compose.yaml：

```yaml
version: '3.8'

services:
  # EMQX单机版
  emqx:
    # 建议使用一个具体的稳定版本，而不是 latest
    image: emqx/emqx:5.6.1
    healthcheck:
      test: ["CMD", "/opt/emqx/bin/emqx", "ctl", "status"] # 健康检查
      interval: 5s
      timeout: 25s
      retries: 5
    # 添加以下 volumes 配置
    volumes:
      # 持久化 MQTT 消息、规则引擎数据等
      - volume-demo-emqx-data:/opt/emqx/data
      # 持久化日志，方便排查问题
      - volume-demo-emqx-log:/opt/emqx/log
    # ports:
    #   # MQTT TCP 端口
    #   - "1883:1883"
    #   # MQTT TCP/WebSocket 端口
    #   - "8083:8083"
    #   # MQTT TCP/WebSocket SSL 端口
    #   - "8084:8084"
    #   # MQTT SSL 端口
    #   - "8883:8883"
    #   # EMQX 仪表板端口
    #   - "18083:18083"
    network_mode: host

volumes:
  volume-demo-emqx-data:
  volume-demo-emqx-log:
```

启动服务

```sh
docker compose up -d
```

访问控制台 http://localhost:18083，帐号：admin，密码：public。

## 主流开源可视化的MQTT客户端工具

>提示：学习过程使用MQTTX作为客户端工具。

以下是主流的开源可视化 MQTT 客户端工具列表：

| 工具名称          | 核心技术          | 主要特点                                                    | 最适合的场景                                   |
| :---------------- | :---------------- | :---------------------------------------------------------- | :--------------------------------------------- |
| **MQTTX**         | Electron (跨平台) | **现代化，功能全面，用户体验极佳**。EMQ官方出品，活跃开发。 | **通用首选**，日常开发、测试、调试。           |
| **MQTT Explorer** | Electron (跨平台) | **以主题结构树为核心**，像文件管理器一样浏览MQTT主题。      | **探索未知的MQTT服务器**，快速理解其主题架构。 |
| **MQTT.fx**       | Java (跨平台)     | **经典、老牌**，功能稳定。但目前已停止新功能开发。          | 维护旧项目，或需要经典稳定工具的场景。         |
| **HiveMQ CLI**    | Java (JAR) / Go   | **强大的命令行工具**，Web UI版本功能丰富，社区版免费。      | **企业级测试与监控**，自动化脚本集成。         |
| **Eclipse Paho**  | 多种语言          | 提供的是**客户端库**，但其网页版Demo是很好的简单测试工具。  | 开发者集成MQTT功能到自己的应用中。             |

---

### 详细介绍与对比

#### 1. MQTTX (推荐首选)
- **官网/下载**：https://mqttx.app/
- **简介**：目前最活跃、用户体验最好的开源 MQTT 5.0 客户端工具。由 EMQ 公司维护，是之前的 MQTTX 的升级版。
- **核心优势**：
    - **界面美观直观**：现代化的聊天软件式布局，上手零门槛。
    - **功能强大**：完整支持 MQTT 5.0/3.1.1，SSL/TLS，WebSocket，脚本测试，色彩主题等。
    - **跨平台**：完美的 Windows、macOS、Linux 支持。
    - **生态完整**：除了桌面版，还有命令行版 `mqttx-cli` 和正在开发的移动版。
- **缺点**：对于只想快速浏览整个主题结构的场景，不如 MQTT Explorer 直观。

#### 2. MQTT Explorer
- **官网/下载**：https://github.com/thomasnordquist/MQTT-Explorer
- **简介**：这款工具的设计理念非常独特，它更像一个“MQTT 主题资源管理器”。
- **核心优势**：
    - **主题树状视图**：自动将收到的主题（如 `sensor/room1/temp`， `sensor/room1/humidity`）组织成树形结构，一目了然。
    - **自动发现**：连接到一个陌生的 MQTT 服务器（如公共 Broker）时，可以快速“探索”出所有正在发布数据的主题和其最新值。
    - **消息历史**：可以查看某个主题最后接收到的消息内容。
- **最适合的场景**：当你需要接入一个第三方的 MQTT 服务或者调试一个复杂的、主题繁多的系统时，MQTT Explorer 能帮你快速理清结构。**它是 MQTTX 的完美补充**。

#### 3. MQTT.fx
- **官网/下载**：https://softblade.de/en/download-2/
- **简介**：曾经是最著名、使用最广泛的 MQTT 客户端，非常经典。
- **核心优势**：
    - **历史悠久，极其稳定**：经过无数项目的检验。
    - **功能专业**：支持负载编解码器、图表显示等高级功能。
- **缺点**：
    - **已停止功能更新**：官方在 2019 年后未发布重大更新，对 MQTT 5.0 的支持有限。
    - **Java 依赖**：需要 Java 运行环境。
    - **UI 略显陈旧**。
- **建议**：除非你维护的旧项目一直在用它，否则新用户建议直接选择 MQTTX。

#### 4. HiveMQ Web Client (社区版)
- **在线体验**：https://www.hivemq.com/demos/websocket-client/
- **简介**：HiveMQ 提供的基于 WebSocket 的在线 MQTT 客户端。它本身不是一个需要下载的软件，但非常实用。
- **核心优势**：
    - **无需安装**：打开浏览器即可使用。
    - **纯 WebSocket 连接**：非常适合测试支持 MQTT over WebSocket 的服务器。
    - **简单直观**：界面非常简洁，用于快速验证连接和收发消息。
- **最适合的场景**：快速演示、临时测试，或者在你无法安装软件的电脑上使用。

#### 5. Eclipse Paho WebSocket Client
- **在线体验**：Eclipse Paho 项目也提供了一个简单的网页客户端，功能与 HiveMQ 的类似，适合快速测试。

### 如何选择？决策流程图

1.  **你是新手，或者需要一个功能全面、现代化的日常开发/测试工具？**
    *   **直接选择 MQTTX**。这是目前综合体验最好的选择，能满足 95% 的需求。

2.  **你需要连接到一个陌生的 MQTT 服务器，想快速了解它的主题结构和数据流？**
    *   **首选 MQTT Explorer**。它的主题树功能无可替代。
    *   *补充：你也可以用 MQTTX 订阅通配符主题 `#` 来达到类似效果，但展示方式不如 MQTT Explorer 直观。*

3.  **你只是想快速验证一下 MQTT 服务器能否连通，不想安装任何软件？**
    *   使用 **HiveMQ Web Client** 或 **Eclipse Paho WebSocket Client** 这类在线工具。

4.  **你需要将 MQTT 测试集成到命令行脚本或 CI/CD 流程中？**
    *   使用 **MQTTX CLI** (`mqttx-cli`) 版本。

**总结建议**：
对于大多数开发者和物联网从业者，我推荐 **将 MQTTX 作为主力工具，同时将 MQTT Explorer 作为辅助工具**。两者结合使用，几乎可以应对所有可视化调试场景。

## 运行MQTTX - 桌面应用方式

访问 https://mqttx.app/ 下载对应系统的安装程序安装后运行即可。

## 运行MQTTX - 容器方式

docker-compose.yaml：

```yaml
version: '3.8'

services:
  # MQTTX web客户端
  mqttx:
    image: emqx/mqttx-web:v1.12.1
    # ports:
    #   - "80:80"
    network_mode: host
```

启动服务

```sh
docker compose up -d
```

访问 http://localhost MQTTX桌面图形。

## 配置MQTTX连接EMQX代理

在MQTTX应用中点击新增链接按钮，连接信息如下：

- Name随便填写
- Host为ws://+localhost
- Port为默认值8083
- Client ID为默认自动生成值
- Path为默认值/mqtt

点击连接按钮后即可连接EMQX代理。

登录EMQX http://localhost:18083，帐号：admin，密码：public查看Cluster Overview，此时能够看见一个新的连接。