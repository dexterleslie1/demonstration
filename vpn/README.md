## 异地组网概念

### 一句话概括

**异地组网**，简单来说，就是**将位于不同地理位置的多个本地网络（比如不同城市的办公室、数据中心、家庭网络）通过技术手段安全地连接起来，形成一个统一的、私有的、逻辑上的“大内网”**。

---

### 一个生动的比喻：修建“专属私人高速公路”

想象一下：
*   **每个办公室**就像一个独立的**小区**，小区内部有自己的道路（本地局域网），住户（电脑、打印机、服务器）可以很方便地互相串门。
*   **互联网**就像**遍布全国的公共公路系统**，虽然四通八达，但谁都可以上路，红绿灯多（网络节点），也不够安全。
*   **异地组网**就是在这些公共公路之上，为你和你的公司**修建了一条连接各个小区的“专属私人高速公路”**。

在这条“私人高速公路”上：
*   **直达快捷**：数据包从A小区到B小区，就像直通车，速度更快、延迟更低。
*   **高度安全**：这条路只有你的车辆（经过加密的数据）可以通行，外人无法进入，通信内容不会被窃听。
*   **统一管理**：所有连接起来的小区，感觉就像在一个超大小区里一样。你可以用在内网一样的方式（比如直接输入`192.168.1.100`这样的内网IP）访问另一个城市的服务器或共享文件。

---

### 异地组网主要用来做什么？（应用场景）

这是理解其价值的关键：

1.  **企业分支互联**：这是最经典的场景。公司总部、分公司、办事处之间的网络打通，实现：
    *   **内部系统访问**：分支机构员工可以像在总部一样，安全地访问内部的ERP、OA、财务等系统。
    *   **共享文件/数据库**：直接访问中心机房的文件服务器和数据库，保证数据一致性。
    *   **内部通讯**：使用内网电话、视频会议系统更加流畅稳定。

2.  **远程办公**：员工在家、在咖啡馆或出差时，通过VPN客户端连接到公司网络，安全地访问内部资源，就像坐在办公室里一样。

3.  **数据中心容灾备份**：两个或多个数据中心之间需要实时同步数据，异地组网可以提供稳定、高速、安全的专用通道。

4.  **连锁门店管理**：全国各地的零售店、餐厅将其收银系统、监控录像实时传回总部中心服务器进行统一管理和分析。

5.  **个人与家庭应用**：
    *   **访问家庭NAS**：在外面用手机或电脑，像在家里一样访问自己NAS上的电影、文档。
    *   **远程控制智能家居**：安全地远程控制家里的灯光、摄像头等设备。

---

### 如何实现异地组网？（主流技术）

实现方式主要有以下几种，从传统到现代：

1.  **传统VPN**
    *   **IPSec VPN**：非常成熟稳定，企业级应用广泛，安全性极高。但配置相对复杂。
    *   **SSL VPN**：基于浏览器，使用方便（任何有浏览器的设备都能连），更适合远程办公用户。

2.  **SD-WAN（软件定义广域网）**
    *   这是当前的主流和趋势。它比传统VPN更智能，可以同时利用多条网络链路（如宽带、4G/5G、专线），自动选择最佳路径来传输数据，从而**提升速度和可靠性**。管理和配置也通常在云端进行，非常灵活。

3.  **MPLS（多协议标签交换）**
    *   一种传统的运营商级专线技术，性能稳定、质量高，但**价格非常昂贵**，部署周期长，灵活性差。目前正逐渐被SD-WAN替代或融合。

4.  **新兴的“零信任”网络访问方案**
    *   理念更先进，核心思想是“从不信任，永远验证”。它不强调把用户“拉进”内网，而是根据用户身份和设备状态，动态授予最小权限的访问权限，安全性更高。

---

### 总结：核心价值

| 特性       | 描述                                   | 带来的好处                 |
| :--------- | :------------------------------------- | :------------------------- |
| **统一性** | 将分散的网络整合为一体                 | 方便管理，提高协作效率     |
| **安全性** | 通过加密隧道在公网上传输数据           | 保护商业机密和敏感数据     |
| **便捷性** | 访问远程资源像访问本地一样简单         | 提升工作效率，支持灵活办公 |
| **经济性** | 相比昂贵的物理专线（如MPLS），成本更低 | 尤其对中小企业友好         |

## SD-WAN异地组网概念

### 一句话概括

**SD-WAN异地组网，就是利用软件定义的技术，智能、高效、低成本地将分布在不同地理位置的办公室、数据中心和云服务连接起来，形成一个统一、安全的“专用大内网”。**

---

### 一个生动的比喻：以前的网络是“固定电话”，SD-WAN是“智能手机”

为了更好地理解，我们打个比方：

1.  **传统企业专线（如MPLS VPN）：固定电话时代**
    *   **特点**：稳定、可靠、质量高，但非常**昂贵**，开通慢（需要运营商上门拉线，等几个月）。
    *   **问题**：就像你只能通过一部昂贵的座机打电话。如果要从北京总部联系上海分部，必须用这条昂贵的“专线”。想访问互联网（比如查资料），也得先绕到总部，再出去，速度慢。
    *   **不灵活**：增加一个新分公司，又得拉一条新专线，费时费钱。

2.  **SD-WAN异地组网：智能手机时代**
    *   **特点**：**智能、灵活、高性价比**。它利用任何可用的网络（如便宜的普通宽带、4G/5G、甚至专线）来“组网”。
    *   **核心智能**：你的手机上可以同时用**Wi-Fi、5G流量**。当你走进咖啡馆，手机会自动从5G切换到更快的Wi-Fi。SD-WAN就是这个“智能大脑”。
    *   **具体工作方式**：
        *   **多链路聚合**：SD-WAN设备可以同时接入普通宽带、4G/5G、甚至保留原有的专线。
        *   **智能选路**：当北京的员工要访问上海的公司系统时，SD-WAN会实时检测所有可用的网络路径（宽带1、宽带2、5G），**自动选择当前最快、最稳定、延迟最低的那条路**来传输数据。就像手机在Wi-Fi信号不好时自动切到5G。
        *   **保障重要应用**：可以设置策略，比如“视频会议的数据最优先，走最好的线路；普通网页浏览走便宜的线路”。确保关键业务不卡顿。
        *   **简化管理**：所有分支机构的网络状态都在一个统一的控制台上可视化管理，运维人员点点鼠标就能完成配置，无需跑到每个分公司。

---

### SD-WAN异地组网的核心优势

与传统方案相比，SD-WAN的优势非常突出：

| 特性         | 传统网络（如MPLS专线）           | SD-WAN异地组网                                |
| :----------- | :------------------------------- | :-------------------------------------------- |
| **成本**     | 极高（按带宽收费）               | 低（充分利用廉价互联网宽带）                  |
| **开通速度** | 慢（数周至数月）                 | 快（即插即用，几天甚至几小时）                |
| **灵活性**   | 差，变更困难                     | 极佳，随时增减节点，策略在线调整              |
| **性能**     | 稳定但带宽有限                   | 智能优化，动态提升关键应用体验                |
| **安全性**   | 网络层隔离，但自身无高级安全功能 | 通常集成防火墙、加密等安全功能，实现安全组网  |
| **云访问**   | 访问云应用需绕行总部，延迟高     | 可直接、安全地本地访问云服务（如阿里云、AWS） |

---

### 典型的应用场景

1.  **多分支机构互联**：这是最经典的场景，比如全国有几十家连锁店、银行网点，需要实时将销售数据、监控录像传回总部。
2.  **总部与数据中心互联**：将企业总部的网络和托管在机房的企业服务器安全地连接起来。
3.  **安全访问云服务**（SaaS/IaaS）：让员工能快速、安全地访问Office 365、Salesforce、阿里云等云应用，体验就像在本地一样。
4.  **远程办公**：员工在家或出差时，能通过客户端软件安全地接入公司内网，访问内部资源，实现“随时随地办公”。

### 总结

**SD-WAN异地组网的革命性在于，它不再依赖某种单一的、昂贵的物理线路，而是通过一个“软件定义”的大脑，智能地调度和管理各种廉价、易得的网络资源，最终实现甚至超越传统专线的效果。** 它完美地适应了现代企业移动化、云化、降本增效的需求。

## 为何VPN服务器需要两个网卡呢？

VPN服务器需要两个网卡是为了扮演一个“交通警察”的角色，将两个完全不同的网络世界安全地连接起来。

核心思想是：**内外网分离，各司其职。**

让我们把这两个网卡想象成两个大门：

1.  **第一张网卡（公网卡）：面向互联网的“前门”**
    *   **连接对象：** 整个互联网。
    *   **主要任务：** 监听并接收来自全球各地VPN客户端的连接请求。你的手机、笔记本电脑在咖啡馆或家里，就是通过这张网卡找到并连接到VPN服务器的。
    *   **IP地址：** 通常是一个公共IP地址（公网IP），就像你家的门牌号一样，在互联网上是唯一的、可被寻址的。

2.  **第二张网卡（内网卡）：连接内部网络的“后门”**
    *   **连接对象：** 公司或家庭的内网设备，比如内部文件服务器、打印机、监控系统等。
    *   **主要任务：** 作为内部网络的一员，将来自“前门”（已认证的VPN客户端）的数据流量转发到内部网络的具体设备上。
    *   **IP地址：** 通常是一个私有IP地址（如 `192.168.1.10`），只在内部网络中有意义，外部互联网无法直接访问。

---

### 为什么这种设计是必须的？一个生动的比喻

想象一下一个安全的办公大楼：

*   **公网卡（前门）：** 是大楼的保安亭。任何访客（VPN客户端）都必须先到这里登记身份、验证权限。
*   **内网卡（后门）：** 是保安亭后面那扇通往办公楼内部的门。只有通过保安检查的访客，才被允许通过这扇门进入办公室区域（内网）访问特定的部门（文件服务器）或人员。

**如果只有一张网卡会发生什么？**

这就像让保安亭和办公室共用一个房间。所有访客和内部员工都挤在同一个空间，毫无隔离可言。这会导致几个严重问题：

1.  **安全风险巨大：** 你无法有效隔离受信任的内网和不受信任的公网。一旦VPN服务软件出现漏洞，攻击者可能通过这张网卡直接攻击你的内网，因为没有物理或逻辑上的隔离。
2.  **路由混乱：** 服务器很难清晰地判断一个数据包是应该发给互联网上的VPN客户端，还是应该发给内网的打印机。这会造成网络通信异常不稳定。
3.  **性能瓶颈：** 所有流量（来自互联网的VPN流量和内部网络之间的流量）都挤在同一个网络接口上，容易造成拥堵，影响速度。

---

### 双网卡的具体工作流程（以远程员工访问公司文件为例）

1.  **连接请求：** 你在家打开VPN客户端，输入公司VPN服务器的公网IP地址。你的请求通过互联网发送到VPN服务器的**公网卡**。
2.  **身份验证：** VPN服务器（通过其软件，如OpenVPN、WireGuard）在公网卡上收到请求，验证你的用户名和密码/证书。
3.  **建立隧道：** 验证通过后，在你的电脑和VPN服务器之间建立一条加密的“隧道”。
4.  **访问内网资源：** 你现在想访问公司的文件服务器（IP是 `192.168.1.100`）。
    *   你的电脑将请求数据包通过加密隧道发送给VPN服务器的**公网卡**。
    *   VPN服务器解密数据包，看到目标是 `192.168.1.100`。
    *   服务器知道这个地址属于它的内部网络，于是通过**内网卡**将数据包转发给文件服务器。
5.  **返回数据：** 文件服务器的回复数据包发送到VPN服务器的**内网卡**，服务器再通过加密隧道从**公网卡**发回给你的电脑。

### 总结：双网卡的核心优势

*   **安全性：** 实现了网络隔离。不受信任的公共流量和受信任的内部流量被物理接口分开，即使公网侧被攻破，内网也多一层屏障。
*   **路由清晰：** 数据包路径明确。来自互联网的流量进“前门”，去内网的流量走“后门”，避免了路由冲突。
*   **性能优化：** 流量负载被分担到两个网络接口上，提高了整体吞吐量和稳定性。

因此，为VPN服务器配置两个网卡是一种标准、高效且安全的最佳实践。虽然在一些非常简单的家庭实验室环境中，人们可能会用单网卡配合复杂的路由规则来实现，但这会引入不必要的复杂性和安全风险，不推荐在生产环境中使用。

## 主路由和旁路由概念

### 核心比喻：公司里的两个“门卫”

想象一个公司的前台和安保系统：

*   **主路由** 就像公司的**总大门保安**。
    *   **核心职责**：所有员工和访客要进出公司，都必须经过这个总大门。他的主要工作是：
        1.  **检查出入权限**（网络连接权限，DHCP服务）。
        2.  **指引你去哪个部门**（数据包转发，网关功能）。
        3.  **确保大门通畅**（基础的网络连通，NAT转换）。
    *   **特点**：他的任务很重，要处理所有流量，但功能相对基础，主要保证“能上网”。

*   **旁路由** 就像公司里某个**特殊部门的专员**（比如“海外业务部”的专员）。
    *   **核心职责**：并不是所有人进出公司都要经过他。只有那些需要办理“特殊业务”（如访问国外网站、科学上网、去广告）的员工，才会被总大门保安指引到这个专员这里。
    *   **工作流程**：一个员工想去国外网站，总大门保安一看，说：“这个业务我办不了，你去找海外业务部的专员。” 员工找到专员，专员帮他处理完（比如“科学上网”）后，再通过总大门出去。
    *   **特点**：他不需要连接所有设备，只为有特定需求的设备服务。他的功能可以非常强大和专门化。

---

### 详细解释

#### 1. 主路由

*   **定义**：主路由是家庭或企业网络中的**核心设备**，直接连接互联网（通过光猫），是内网所有设备访问外网的**必经之路**。
*   **主要功能**：
    *   **DHCP 服务**：自动给连接上的设备（手机、电脑、电视等）分配IP地址、网关和DNS。
    *   **NAT 转换**：将内部网络的私有IP地址转换为一个公共IP地址去访问互联网，这是我们能上网的基础。
    *   **无线 Wi-Fi 发射**（如果是无线路由器）。
    *   **端口转发、防火墙**等基础网络管理功能。
*   **特点**：**稳定至上**。它的主要目标是保证网络不断线，所有设备能稳定上网。它的性能和处理能力直接决定了整个网络的基础体验。

#### 2. 旁路由

*   **定义**：旁路由是连接在主路由之下的**辅助性路由设备**。它不取代主路由的位置，内网设备**不一定非要**通过它上网。
*   **工作模式**：
    1.  **旁路由连接到主路由的LAN口**下，就像一台普通的电脑、手机一样，从主路由那里获取一个IP地址（如 192.168.1.2）。
    2.  **需要特殊服务的设备**（比如你的电脑），需要手动将其网络设置中的“默认网关”和“DNS服务器”地址填写为旁路由的IP地址（192.168.1.2）。
    3.  这样，当这台电脑要上网时，数据包就会先发给旁路由，旁路由处理完（如执行科学上网、去广告等规则）后，再转发给主路由（192.168.1.1），最后由主路由发送到互联网。
    4.  返回的数据包则走相反的路径：互联网 -> 主路由 -> 旁路由 -> 你的电脑。
*   **主要功能**（为什么需要它）：
    *   **科学上网/留学**：这是旁路由最常见的用途，安装OpenWrt、ShellClash等系统，实现代理功能。
    *   **广告拦截**：如安装AdGuard Home。
    *   **网络加速**、**DNS优化**、**内网穿透**、**搭建轻量级服务器**等高级功能。
*   **特点**：**功能专一，灵活性强**。
    *   **优点**：即使旁路由宕机或配置出错，你只需要将设备的网关改回主路由的IP，网络就能恢复正常，不影响主路由和其他设备的工作。实现了“功能”和“稳定性”的分离。
    *   **缺点**：需要手动为每个设备指定网关，或者通过主路由的DHCP设置全局下发（有一定风险，设置错误会导致全网上不了网）。

---

### 两种方案的对比

| 特性         | 主路由                               | 旁路由                                 |
| :----------- | :----------------------------------- | :------------------------------------- |
| **网络位置** | 核心，直接连接外网                   | 旁路，连接在主路由之下                 |
| **必要性**   | **必需**，没有它整个网络瘫痪         | **可选**，为了增强功能                 |
| **配置影响** | 配置出错可能导致**全网瘫痪**         | 配置出错只影响**使用它的设备**，风险低 |
| **性能要求** | 要求高，需要稳定转发所有流量         | 要求相对较低，只需处理部分设备的流量   |
| **主要功能** | 提供基础网络连接（DHCP, NAT, Wi-Fi） | 提供高级功能（留学，去广告，DNS等）    |

---

### 总结与选择建议

*   **普通家庭用户**：一个性能不错的**主路由**就完全够用了。追求的是简单和稳定。
*   **进阶用户/极客**：推荐 **“主路由 + 旁路由”** 的方案。
    *   购买一个性能强劲、稳定性极佳的硬路由（如华硕、网件等）作为**主路由**，只负责最基础的网络连接，保证全家网络基石稳固。
    *   用一个功耗低、可玩性高的设备（树莓派、旧笔记本、小型工控机等）刷写OpenWrt等系统作为**旁路由**，专门负责各种高级功能。这样即使你把旁路由“玩坏了”，家人的正常上网也不会受到影响。

简单来说，**主路由是保障“有网”，旁路由是追求“好网”**。这种架构在追求网络功能和稳定性的玩家中非常流行。

## OpenWrt镜像区别

>说明：在ESXi服务器上安装OpenWrt选择generic-ext4-combined-efi.img.gz镜像。

访问 https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/ 得到的镜像列表如下：

```
generic-ext4-combined-efi.img.gz
generic-ext4-combined.img.gz
generic-ext4-rootfs.img.gz
generic-kernel.bin
generic-squashfs-combined-efi.img.gz
generic-squashfs-combined.img.
generic-squashfs-rootfs.img.gz
rootfs.tar.gz
```

这些OpenWrt镜像文件的主要区别在于文件系统类型、分区组合方式以及用途。以下是详细解释：

---

### **1. 文件系统类型**
- **ext4**：
  - 传统读写文件系统，适合需要频繁写入的场景（如安装插件或保存配置）。
  - 镜像文件：
    - `generic-ext4-*.img.gz`
- **squashfs**：
  - 只读压缩文件系统，通过覆盖层（overlay）实现写入，系统更稳定（重启后恢复默认）。
  - 镜像文件：
    - `generic-squashfs-*.img.gz`

---

### **2. 分区组合方式**
- **combined**（完整系统镜像）：
  - 包含启动分区（kernel）和根文件系统（rootfs），可直接刷写到设备。
  - 文件示例：
    - `generic-ext4-combined.img.gz`
    - `generic-squashfs-combined.img.gz`
- **combined-efi**（支持UEFI启动）：
  - 在`combined`基础上增加EFI分区，适用于UEFI启动的设备（如x86虚拟机或新硬件）。
  - 文件示例：
    - `generic-ext4-combined-efi.img.gz`
    - `generic-squashfs-combined-efi.img.gz`
- **rootfs-only**（仅根文件系统）：
  - 仅包含根文件系统（无内核），需搭配内核文件（`generic-kernel.bin`）使用。
  - 文件示例：
    - `generic-ext4-rootfs.img.gz`
    - `generic-squashfs-rootfs.img.gz`

---

### **3. 其他文件**
- **generic-kernel.bin**：
  - 独立的内核文件，需与`rootfs`镜像配合使用（如手动分区或特殊设备）。
- **rootfs.tar.gz**：
  - 根文件系统的压缩包，用于自定义部署（如Docker容器或已有Linux系统上解压使用）。

---

### **如何选择？**
1. **普通设备刷写**：
   - 直接使用`combined`或`combined-efi`镜像（根据设备启动方式选择）。
   - 优先选`squashfs`（稳定性高），如需频繁写入选`ext4`。
2. **自定义分区/升级**：
   - 使用`rootfs.img.gz` + `generic-kernel.bin`。
3. **虚拟化或特殊硬件**：
   - UEFI启动选`combined-efi`，传统BIOS选`combined`。

---

### **总结表**
| 文件名                                 | 文件系统 | 分区组合        | 适用场景               |
| -------------------------------------- | -------- | --------------- | ---------------------- |
| `generic-ext4-combined-efi.img.gz`     | ext4     | 内核+rootfs+EFI | UEFI设备，需读写       |
| `generic-ext4-combined.img.gz`         | ext4     | 内核+rootfs     | 传统设备，需读写       |
| `generic-ext4-rootfs.img.gz`           | ext4     | 仅rootfs        | 手动分区，需读写       |
| `generic-squashfs-combined-efi.img.gz` | squashfs | 内核+rootfs+EFI | UEFI设备，稳定只读     |
| `generic-squashfs-combined.img.gz`     | squashfs | 内核+rootfs     | 传统设备，稳定只读     |
| `generic-squashfs-rootfs.img.gz`       | squashfs | 仅rootfs        | 手动分区，稳定只读     |
| `generic-kernel.bin`                   | -        | 仅内核          | 需搭配rootfs使用       |
| `rootfs.tar.gz`                        | -        | 压缩包          | 自定义部署（非刷写用） |

根据设备类型和需求选择对应镜像即可。

## 路由器DMZ概念

### 一句话概括

**DMZ（Demilitarized Zone，非军事区）是路由器中的一个设置，你可以将局域网内的某一台设备（比如一台电脑或游戏主机）完全暴露给互联网，相当于把它“踢出”路由器的防火墙保护之外。**

---

### 详细解释

为了理解DMZ，我们得先明白家庭或办公室网络通常是怎么工作的。

#### 1. 正常情况（没有DMZ）

*   你的路由器就像一个**保安**，而你的所有设备（电脑、手机、游戏机等）都在一个**安全的内部网络（局域网）** 里。
*   这个保安站在大门口（互联网入口），对所有从外面想进来的数据包进行严格盘查。除非是内部设备主动请求的数据（比如你打开网页），或者是你在路由器里设置了**端口转发**（相当于给保安一份“访客白名单”，告诉他特定的人可以进），否则外部数据一律拦在门外。
*   这层保护就是**防火墙**，它非常关键，能有效防止黑客攻击你的内部设备。

#### 2. 开启DMZ后

*   当你把局域网中的**某台设备**（例如IP地址为 192.168.1.100 的电脑）设置为DMZ主机后，路由器这个“保安”会对这台设备采取特殊对待：
    *   **所有从互联网发来的、目标不明确的数据包，全部都会无条件地转发给这台DMZ主机。**
*   换句话说，这台设备就像被放在了路由器防火墙外面的一个“前厅”里，互联网上的任何“人”都可以直接敲它的门。

**一个简单的比喻：**
*   **正常网络：** 你的家（局域网）有一个大门（路由器防火墙），所有访客必须经过大门确认才能进入。
*   **端口转发：** 你告诉保安（路由器）：“如果有个送披萨的（访问特定端口，如80端口的网页服务），就让他进来送到厨房（某台设备的特定服务）。”
*   **DMZ：** 你直接把厨房（DMZ主机）搬到了大门外面，没有任何阻拦，任何人都可以进出这个厨房。

---

### DMZ的主要用途

1.  **主机类游戏或特殊联机应用：** 一些游戏或软件需要复杂的网络连接，设置端口转发非常麻烦。直接将该游戏主机（如PS5、Xbox）设为DMZ是最简单粗暴的解决方案，可以最大可能解决“NAT类型严格”等问题。
2.  **运行需要被公开访问的服务：** 如果你在某台电脑上架设了一个对公网开放的网站、服务器等，但又没有公网IP（IP地址是运营商分配的大内网地址），DMZ可以方便地让外部用户访问到你的服务。

---

### DMZ的巨大风险（非常重要！）

**将设备设为DMZ主机是极其危险的行为！** 因为它完全移除了该设备的防火墙保护。

*   **黑客的活靶子：** 这台设备将直接面对互联网上所有的恶意扫描和攻击。如果这台设备本身存在安全漏洞（比如操作系统没有更新，软件有漏洞），黑客可以轻而易举地入侵它。
*   **沦为“跳板”：** 一旦这台设备被黑客控制，它可能会成为攻击你内网其他设备的“跳板”，导致整个家庭或公司网络陷入危险。

**因此，除非你非常清楚自己在做什么，并且DMZ主机上的系统非常安全（例如是专门加固过的系统），否则强烈不建议普通用户使用此功能。**

---

### DMZ 与 端口转发 的区别

这是最关键的一点：

| 特性         | **端口转发**                                              | **DMZ**                                                    |
| :----------- | :-------------------------------------------------------- | :--------------------------------------------------------- |
| **安全性**   | **高**                                                    | **极低**                                                   |
| **精确度**   | **精确**。只开放你指定的几个端口。                        | **粗暴**。开放**所有**端口。                               |
| **适用场景** | 需要开放特定服务（如远程桌面、FTP服务器、特定游戏端口）。 | 需要开放大量不确定端口，或懒得设置复杂端口转发的特殊情况。 |
| **比喻**     | 只打开房子的一扇小窗户传递东西。                          | 把整个房间的墙都拆了。                                     |

### 总结与建议

*   **DMZ是什么？** 是一个将内网设备完全暴露给公网的路由器功能。
*   **什么时候用？** 仅在解决特定网络问题（如游戏联机）且其他方法无效时，**临时地** 对游戏机等非关键设备使用。
*   **安全第一：** **绝对不要**将你存放重要资料、进行网上银行交易的日常使用的电脑设为DMZ主机。
*   **优先选择：** 在绝大多数情况下，**端口转发** 是比DMZ更安全、更专业的解决方案。请优先尝试使用端口转发来解决问题。

## 为什么路由表记录与网卡对应

路由表记录需要与网卡对应，是因为**数据包必须通过一个实实在在的物理（或虚拟）接口才能发送出去**。

可以把整个过程想象成寄送快递：

*   **你的电脑** = 一个物流分发中心
*   **数据包** = 需要寄送的包裹
*   **IP地址** = 包裹上的收件地址
*   **路由表** = 物流中心里的“路线规划手册”
*   **网卡** = 物流中心通往不同外部道路的**大门**（比如前门通往市区公路，后门通往高速公路，侧门通往一条小巷）。

现在我们来分解为什么“路线”必须对应“门”。

### 1. 根本原因：数据包的出口

路由表的核心作用是回答一个问题：“当我要发送一个数据包到目标IP X.X.X.X时，我应该把这个包从哪个**接口（网卡）** 扔出去，以及下一跳的地址是什么？”

如果没有指定网卡，操作系统就不知道应该让哪个硬件设备来执行发送操作。是让连接Wi-Fi的无线网卡发，还是让连接网线的有线网卡发？这两个网卡连接的是完全不同的网络路径。

### 2. 具体原因和场景分析

让我们看几个典型的路由表记录例子（以Linux系统为例，Windows/Mac逻辑类似）：

```bash
# 假设你的电脑有两张网卡：
# - eth0: 有线网卡，IP是 192.168.1.100，连接公司内网
# - wlan0: 无线网卡，IP是 10.0.0.5，连接家庭Wi-Fi

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
0.0.0.0         10.0.0.1        0.0.0.0         UG    600    0        0 wlan0
192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     600    0        0 wlan0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eth0
```

**场景一：访问互联网（例如 `8.8.8.8`）**

1.  电脑要访问 `8.8.8.8`。
2.  查询路由表，这个IP不匹配 `192.168.1.0/24`，也不匹配 `10.0.0.0/24`。
3.  它最终匹配到了第一条**默认路由**：`0.0.0.0/0`（意思是“所有其他地址”）。
4.  这条记录明确指出：**通过接口 `eth0`** 发送，并交给网关 `192.168.1.1`。
5.  操作系统于是将数据包交给 `eth0` 网卡驱动程序，由它通过网线将数据包发送出去。

*如果这里没有指定 `Iface`（接口），操作系统就懵了，不知道该用哪个门。*

**场景二：访问同一局域网内的另一台电脑（例如 `192.168.1.50`）**

1.  电脑要访问 `192.168.1.50`。
2.  查询路由表，它匹配到了第三条记录：`192.168.1.0/24`。
3.  这条记录显示：网关是 `0.0.0.0`（表示目标就在同一局域网，无需网关），并且**通过接口 `eth0`** 直接发送。
4.  操作系统会通过 `eth0` 网卡直接在本地网络里“喊话”（ARP广播），寻找 `192.168.1.50` 的MAC地址，然后直接通信。

*这里明确指出了访问 `192.168.1.x` 这个网段的设备，必须走 `eth0` 这个门，走 `wlan0` 是绝对到不了的，因为那是两个不同的网络。*

**场景三：策略路由（多网卡同时上网）**

这是最体现对应关系重要性的场景。你的电脑同时连着有线网络（公司内网，可访问内部服务器）和无线Wi-Fi（用于上外网）。

*   路由表通过 **`Iface`** 字段实现了流量的分离：
    *   所有去往公司服务器（如 `10.10.x.x`）的流量，由指向 `eth0` 的路由记录管理。
    *   所有去往互联网的流量，因为有线路由的**Metric（度量值，100）** 比无线（600）更优，所以会优先走 `eth0`。如果 `eth0` 断开，系统会自动切换到 `wlan0` 的默认路由，实现故障转移。

如果没有与网卡的对应关系，就无法实现这种精细的、基于源IP或目标IP的流量控制。

### 总结

路由表记录与网卡对应是**必然的**，因为：

1.  **物理出口**：网卡是数据包离开主机的唯一物理（或虚拟）通道。
2.  **路径选择**：不同的网卡通常连接到不同的逻辑或物理网络，路由表的核心职责就是为不同目标网络选择正确的出口。
3.  **地址绑定**：在发送数据包时，网卡需要以其自身的IP地址作为源IP。操作系统需要知道从哪个口出去，才能正确封装数据包的源IP地址。
4.  **策略管理**：在多网卡环境下，这种对应关系是实现负载均衡、故障转移和访问控制的基础。

所以，**路由表本质上就是一个“目标网络 -> 出口网卡 + 下一跳网关”的映射表**，与网卡的对应关系是其设计的核心和基础。

## 怎么判断一个网卡是虚拟还是物理的呢？

判断网卡是虚拟还是物理的，有多种方法，可以从操作系统内部查看，也可以从外部硬件推断。

下面我为你整理了从简单到专业的一系列方法，你可以根据你所处的环境和拥有的权限来选择。

### 总结：核心判断依据

*   **物理网卡**：与真实的、看得见摸得着的硬件设备对应。通常有唯一的MAC地址和物理端口（如RJ-45网线接口）。
*   **虚拟网卡**：由操作系统、虚拟化软件（如VMware, Hyper-V, VirtualBox）或网络功能虚拟化（NFV）创建的逻辑网络接口。它没有独立的物理硬件，用于虚拟机内部通信、软件路由、VPN隧道等。

---

### 方法一：在操作系统中通过命令或界面查看（最常用）

这是最直接的方法，无需接触硬件。

#### 1. 在 Windows 系统中

**a) 使用设备管理器**
1.  右键点击“此电脑” -> “管理” -> “设备管理器”。
2.  展开“网络适配器”。
3.  **观察名称**：
    *   **物理网卡**：通常直接显示品牌和型号，如 `Intel(R) Ethernet Connection (7) I219-V`， `Realtek PCIe GbE Family Controller`。
    *   **虚拟网卡**：名称通常包含虚拟化软件或特定功能的关键字：
        *   `VMware Virtual Ethernet Adapter` （VMware相关）
        *   `VirtualBox Host-Only Ethernet Adapter` （VirtualBox相关）
        *   `Hyper-V Virtual Ethernet Adapter` （Hyper-V相关）
        *   `WAN Miniport` （Windows自带的PPPoE、VPN等虚拟适配器）
        *   `TAP-Windows Adapter V9` （OpenVPN等VPN软件使用）

**b) 使用命令行（PowerShell）**
1.  以管理员身份打开 PowerShell。
2.  输入命令：`Get-NetAdapter`
3.  查看返回列表中的 `Name` 和 `InterfaceDescription` 列。判断方法与设备管理器类似，虚拟网卡的描述会包含 `Hyper-V`， `VMware`， `TAP` 等字样。

#### 2. 在 Linux 系统中

Linux下的命名规则更为清晰。

**a) 使用 `ip link` 命令**
1.  打开终端。
2.  输入命令：`ip link`
3.  观察网卡名称（第一列）：
    *   **物理网卡**：传统命名如 `eth0`， `ens33`， `enp0s3`。新的命名规则通常与物理位置相关（如 `ens33`）。
    *   **虚拟网卡**：名称有很强的特征：
        *   `virbr0`， `vnet0` （Libvirt/KVM虚拟化）
        *   `docker0`， `vethxxxxx` （Docker容器虚拟网络）
        *   `wlp0s1` （这是**物理**无线网卡，`wl`代表wireless LAN，不要混淆）
        *   `lo` （环回接口，特殊的虚拟网卡）
        *   `tun0`， `tap0` （VPN隧道接口）

**b) 使用 `lshw` 命令（更详细）**
1.  输入命令：`sudo lshw -class network`
2.  这个命令会显示非常详细的硬件信息。查看每个网卡描述的 `product` 和 `logical name` 字段。
    *   **物理网卡**：`product` 字段会显示具体的硬件型号，如 `Ethernet Connection I217-LM`。
    *   **虚拟网卡**：`product` 字段可能是空的，或者是 `Virtual Ethernet adapter`， `Virtual Ethernet pair` 等。`description` 字段也可能直接说明是虚拟接口。

#### 3. 在 macOS 系统中

1.  打开“系统报告”（关于本机 -> 系统报告）。
2.  在侧边栏选择“网络”。
3.  在右侧列表中，查看每个接口的“类型”或“名称”：
    *   **物理网卡**：如 `Ethernet`， `Wi-Fi`。
    *   **虚拟网卡**：如 `utun0`， `utun1` （VPN或系统服务使用）， `bridge0`。

---

### 方法二：通过MAC地址（OUI）判断

每个网卡的MAC地址前3个字节是**组织唯一标识符（OUI）**，代表制造商。可以查询OUI来判断。

1.  **找到MAC地址**：使用 `ipconfig /all` (Windows) 或 `ip link` (Linux) 找到目标网卡的MAC地址。
2.  **查询OUI**：在网站上（如 https://www.macvendors.com/）输入MAC地址查询。
    *   **物理网卡**：OUI通常对应一个知名的硬件制造商，如 `Intel` (00-15-5D)， `Realtek` (00-13-3A) 等。
    *   **虚拟网卡**：OUI可能属于虚拟化软件厂商：
        *   **VMware**： `00-0C-29`， `00-50-56`
        *   **Microsoft (Hyper-V)**： `00-15-5D` （这个OUI也属于Intel，但微软Hyper-V默认使用这个范围的MAC）
        *   **Parallels (macOS虚拟机)**： `00-1C-42`
        *   **Palo Alto Networks (GlobalProtect VPN)**： 可能使用特定的OUI。

**注意**：这种方法不是100%准确，因为管理员可以手动修改MAC地址（MAC spoofing），但绝大多数情况下是可靠的。

---

### 方法三：物理检查（最终确认）

如果上述方法仍有疑问，或者你有权限接触硬件，这是最可靠的方法。

*   **查看服务器或电脑背部**：是否有对应的RJ-45网络接口指示灯在闪烁。一个物理网卡必定对应一个物理端口。
*   **进入BIOS/UEFI或RAID卡配置界面**：查看硬件设备列表，物理网卡会在这里显示。
*   **对于服务器**：查看主板集成（LOM）或插在PCIe插槽上的网卡。虚拟网卡（如VMXNET3）在宿主机的硬件层面是看不到的。

### 快速判断流程图

```mermaid
graph TD
    A[开始判断网卡类型] --> B{查看网卡名称/描述};
    B -->|包含 VMware/VirtualBox/Hyper-V/TAP 等词| C[大概率是虚拟网卡];
    B -->|是 eth, eno, ens, enp 等| D[大概率是物理网卡];
    C --> E{仍有疑问？};
    D --> E;
    E --> F[查询MAC地址(OUI)];
    F -->|OUI属于虚拟化软件商| C;
    F -->|OUI属于硬件制造商| D;
    E --> G[终极方法：物理检查];
    G -->|有对应物理端口和指示灯| H[确认物理网卡];
    G -->|无对应物理硬件| I[确认虚拟网卡];
```

## 小米路由器AX6000上网设置PPPoE、DHCP、静态IP是什么呢？

想象一下，您的路由器就像一个新搬进小区的住户，它要上网，就需要从“网络运营商”（如电信、联通、移动）那里获取一个“门牌号”（IP地址）和进出小区的权限。这三种上网方式就是获取“门牌号”的不同方法。

---

### 核心比喻：上网就像收快递

*   **宽带账号（家）** = 您家的具体地址（例如：XX小区X栋X单元X室）
*   **IP地址** = 您的门牌号
*   **路由器** = 您家的管家
*   **运营商（ISP）** = 快递公司/物业

---

### 三种上网方式详解

#### 1. PPPoE（宽带拨号）【最常用】

*   **是什么**：这是目前家庭宽带**最主流、最常见**的上网方式。它需要您输入运营商提供给您的**宽带账号和密码**进行“拨号”认证，认证成功后，运营商才会允许您上网并分配一个IP地址。
*   **工作方式**：就像您家装了新的光纤，运营商给您一张单子，上面写着账号和密码。您把这个账号密码告诉“管家”（路由器），管家每次开机后都会主动给物业（运营商）打电话：“你好，我是XX室的住户，我的账号是...，密码是...，我要上网”。验证通过后，网络就通了。
*   **如何判断**：
    *   新办理的家庭宽带基本都是这种方式。
    *   如果您之前用旧路由器，需要输入账号密码才能上网，那么就是PPPoE。
    *   如果您不确定，**可以优先尝试此方式**。账号密码通常写在您办理宽带时的业务受理单上，或者可以直接打电话问运营商客服。
*   **在小米路由器中的设置**：选择PPPoE后，分别填入运营商提供的**宽带账号**和**宽带密码**。

#### 2. DHCP（自动获取IP）【也很常见】

*   **是什么**：这种方式下，路由器不需要输入账号密码，而是像“自动应答”一样。它开机后会向网络大喊一声：“我是新来的，谁能给我个地址上网？” 上层设备（可能是光猫或者小区网络）会自动分配一个IP地址给它。
*   **工作方式**：相当于您住的是酒店或公寓。您一进房间，插上网线，酒店的网络就自动识别了您的设备，并给您分配了一个临时房间号，您就可以直接上网了，不需要任何登记。
*   **适用场景**：
    *   **路由模式改桥接模式**：当您的光猫已经设置成了路由模式，并且已经完成了拨号，那么从光猫接出来的网线插到小米路由器上，路由器就应该用DHCP方式。
    *   **从另一个路由器下接网线**：如果您是从上一级路由器拉网线到小米路由器，也通常用这个模式。
    *   一些校园网、企业网或小区宽带。
*   **在小米路由器中的设置**：选择DHCP（或“自动获取IP”），通常不需要填写任何内容，直接保存即可，最简单。

#### 3. 静态IP（固定IP）【较少见】

*   **是什么**：这种方式需要您手动填写运营商或网络管理员提供给您的所有网络参数，包括IP地址、子网掩码、网关和DNS服务器。这些信息都是固定的，不会改变。
*   **工作方式**：这就像您租用或购买了一个固定的商铺或办公室。这个地址是专门留给您的，不会分配给别人。您需要手动把地址信息登记到物业。
*   **适用场景**：
    *   企业专线宽带。
    *   某些需要对外提供服务的场景（如网站服务器、监控服务器）。
    *   **家庭用户极少使用**，因为费用昂贵。
*   **在小米路由器中的设置**：选择静态IP后，需要准确填写所有网络信息，一个都不能错。

---

### 如何为您的 AX6000 选择？

1.  **首选尝试 PPPoE（宽带拨号）**：
    *   如果您是家庭用户，直接拉光纤入户，并且有运营商给的账号密码，**99% 的概率是这种**。
    *   将上网网线插入AX6000的**WAN口**（通常是蓝色口或旁边有小球标志的口）。

2.  **如果PPPoE不成功，再尝试 DHCP（自动获取IP）**：
    *   如果您家是光猫拨号（即光猫本身已经可以发射Wi-Fi），现在只是想用小米路由器来扩展Wi-Fi或获得更好的信号，那么就应该选这个。
    *   同样，网线插WAN口。

3.  **静态IP（固定IP）**：
    *   **除非运营商或公司网管明确告诉您，并给了您一整套参数，否则不要选这个。**

### 总结表格

| 上网方式             | 通俗比喻               | 是否需要账号密码               | 适用场景                                  | 设置难度   |
| :------------------- | :--------------------- | :----------------------------- | :---------------------------------------- | :--------- |
| **PPPoE（拨号）**    | **打电话登记入户**     | **需要**                       | **绝大多数家庭光纤宽带**                  | 简单       |
| **DHCP（自动获取）** | **酒店自动分配房间**   | **不需要**                     | 光猫已拨号、从其他路由器接出、公司/校园网 | **最简单** |
| **静态IP（固定IP）** | **拥有固定产权的商铺** | **不需要（但需要固定IP参数）** | 企业专线、有特殊网络需求的用户            | 较复杂     |

**给您的最终建议：**

**新装家庭宽带，直接选PPPoE，填入宽带账号和密码。** 这是最正确的选择。如果无法上网，再检查账号密码是否正确，或致电运营商确认。

## ZeroTier总结

如下：

- 不好：尝试查找类似traceroute的方案判断ZeroTier流量经过哪些服务器到达终点，但没有找到这样的方案。
- 不好：ping丢包严重时没有比较好的debug支持判断丢包问题在哪里。
- 不好：在家中ping公司内网丢包比较严重。

## ZeroTier信息

网址：https://my.zerotier.com/（旧版本控制台，新版本控制台不能添加自定义静态路由），使用Github帐号登录。

## ZeroTier入门

>说明：两台异地的Windows11组网使用ZeroTier分配的内网ip地址相互通讯。

### ZeroTier控制台创建网络

登录旧版本ZeroTier控制台 https://my.zerotier.com/，创建一个网络。

### 第一台Windows11配置

下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MSI Installer(x86/x64)，双击Installer根据提示安装即可。

加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID。 

查看网络状态并授权：打开`托盘图标`>`xxx <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络（咨询网络管理员授权）。

再次查看网络为OK状态：打开`托盘图标`>`xxx <网络名称>`>`Status: OK`功能。

### 第二台Windows11配置

配置过程和上面的Windows11一样。

### 测试网络连通

在ZeroTier控制台中查看Windows11自动分配的内网ip地址，在其中一台Windows11尝试ping另外一台Windows11，如果能够ping同说明网络连通。

## ZeroTier+OpenWrt异地组网

>说明：异地的计算机通过ZeroTier网络能够访问公司中任何一台内网的计算机。

登录旧版本ZeroTier控制台 https://my.zerotier.com/，创建一个网络。

配置公司OpenWrt+ZeroTier主机：

1. OpenWrt使用iStoreOS，下载地址 https://fw0.koolcenter.com/iStoreOS/x86_64_efi/istoreos-21.02.1-2022050620-x86-64-generic-squashfs-combined-efi.img.gz

2. 下载 StarWind Converter用于转换iStoreOS镜像为ESXi VMDK镜像，下载地址：https://www.starwindsoftware.com/starwind-v2v-converter#download，填写用户信息后会发送一封邮件包括下载地址。

3. 按照提示安装StarWind Converter并在转换镜像时选择镜像输出格式为VMDK。

4. 在ESXi服务器创建2C2G的OpenWrt虚拟机，上传StarWind Converter转换后的文件istoreos-21.02.1-2022050620-x86-64-generic-squashfs-combined-efi.vmdk和istoreos-21.02.1-2022050620-x86-64-generic-squashfs-combined-efi-flat.vmdk到虚拟机目录中，删除虚拟机现有的硬盘并从刚刚上传的VMDK文件创建新的硬盘，启动OpenWrt虚拟机后就会自动进入系统了。

5. 修改OpenWrt ip地址：

   ```sh
   # 编辑/etc/config/network修改ip地址为192.168.1.38
   config interface 'lan'
           option device 'br-lan'
           option proto 'static'
           option ipaddr '192.168.1.38'
           option netmask '255.255.255.0'
           option ip6assign '60'
           option gateway '192.168.1.1'
           list dns '192.168.1.1'
           list dns '114.114.114.114'
   ```

6. 重启OpenWrt后，访问 http://192.168.1.38 登录OpenWrt控制台，帐号：root，密码：password。

7. 配置OpenWrt默认网关和DNS：

   打开`网络`>`接口`>`LAN br-lan`>`编辑`功能，在`常规设置`>`IPv4网关`填写192.168.1.1，在`高级设置`>`使用自定义的DNS服务器`填写192.168.1.1和114.114.114.114两个DNS服务器。点击`保存`>`保存并应用`按钮后即可生效。

   测试配置是否生效：打开`服务`>`终端`，输入帐号：root，密码：password

   ```sh
   # 能够ping通表示上面的配置正确
   ping www.baidu.com
   ```

8. 安装并配置ZeroTier插件：

   打开`iStore`>`全部软件`功能，输入`zerotier`搜索并点击安装即可。

   打开`VPN`>`ZeroTier`配置ZeroTier插件：

   - 勾选`已启用`。
   - 勾选`自动允许客户端 NAT`。
   - 添加加入网络，信息如下：
     - 勾选`已启用`。
     - ZeroTier网络ID填写之前创建的网络ID。
     - 勾选`允许私有网络路由`。

   点击`保存并应用`按钮。

   登录ZeroTier控制台授权ZeroTier插件接入ZeroTier私有网络。

9. 手动添加ZeroTier私有网络的网络接口：

   打开`网络`>`接口`功能，点击`添加新接口`按钮，接口信息如下：

   - 名称填写`ZEROTIER`。
   - 协议选择`静态地址`。
   - 设备选择zt开头的网开`ztxxx`。
   - IPv4地址填写ZeroTier分配的私有网络ip地址192.168.196.187。
   - IPv4子网掩码填写ZeroTier分配的私有网络子网掩码。
   - IPv4网关为本地局域网网关地址192.168.1.1。
   - `防火墙设置`>`创建/分配防火墙区域`选择`lan`。

   点击`保存`>`保存并应用`按钮。

10. 配置OpenWrt防火墙：

    打开`网络`>`防火墙`功能，设置信息如下：

    - `常规设置`>`转发`选择`接受`。

    - `自定义规则`添加如下防火墙规则：

      ```sh
      # ztxxx修改为ZeroTier网卡名称
      iptables -I FORWARD -i ztxxx -j ACCEPT
      iptables -I FORWARD -o ztxxx -j ACCEPT  
      iptables -t nat -I POSTROUTING -o ztxxx -j MASQUERADE
      ```

    重启OpenWrt路由器。

配置远程客户端：

- 下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MSI Installer(x86/x64)，双击Installer根据提示安装即可。

- 加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID。 

- 查看网络状态并授权：打开`托盘图标`>`xxx <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络。

- 再次查看网络为OK状态：打开`托盘图标`>`xxx <网络名称>`>`Status: OK`功能。

- 测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

  ```sh
  $ ping 192.168.1.1                             
  PING 192.168.1.1 (192.168.1.1): 56 data bytes
  64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
  64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
  64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
  64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
  64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
  64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
  64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
  ```

## ZeroTier Planet和Moon服务器概念

简单来说，**Planet（行星）和 Moon（月球）是为了解决同一个问题而生的两种不同层级的服务器：在无法直接点对点（P2P）连接时，为你的设备提供可靠的中转（Relay）服务。**

让我们来详细分解一下。

### 核心问题：为什么需要服务器？

ZeroTier 的目标是让分布在全球的设备像在同一个局域网里一样通信，它首先会尝试建立直接的 P2P 连接。但现实中，很多网络环境有严格限制（如公司防火墙、运营商NAT），导致 P2P 直连失败。

这时候，就需要一个双方都能访问的“中间人”来转发数据，这个“中间人”就是服务器。

---

### 1. Planet（行星）服务器 - ZeroTier 的官方“根服务器”

*   **身份：** 由 ZeroTier 官方搭建和维护的全球服务器集群。
*   **作用：**
    1.  **身份认证与授权：** 当你加入一个网络时，你的设备会向 Planet 服务器“报到”，Planet 服务器会验证你是否有权限加入该网络，并下发网络配置和成员列表。
    2.  **网络控制器：** 管理所有虚拟网络的成员、IP地址分配（DHCP）、访问规则（Rules）等。你通过 ZeroTier Central 网页进行的操作，最终都是由 Planet 服务器下发给各个节点的。
    3.  **根服务器/星球中继：** 当 P2P 连接失败，且没有自定义的 Moon 服务器时，设备会通过 Planet 服务器进行流量中转。
*   **特点：**
    *   **免费使用：** 对于普通用户，Planet 服务是免费的（有100个设备限制）。
    *   **全球分布：** ZeroTier 在全球多个地点部署了 Planet 节点，以保证延迟和可靠性。
    *   **公共基础设施：** 可以把它想象成互联网的 DNS 根服务器，是 ZeroTier 全球网络的基石。

**局限性：** 由于是公共服务器，全球用户都在使用，在某些网络环境下（尤其是在中国大陆），访问海外的 Planet 服务器可能不稳定、延迟高甚至被干扰，导致整个 ZeroTier 网络体验不佳。

---

### 2. Moon（月球）服务器 - 你的私有“专属中转站”

Moon 就是为了解决 Planet 的局限性而生的。

*   **身份：** **由用户自己搭建**的辅助服务器。它就像是围绕着你私有网络的一颗“月球”，而 ZeroTier 的官方 Planet 则是“地球”。
*   **作用：**
    1.  **降低延迟，提高稳定性：** 如果你在国内有一台云服务器（如阿里云、腾讯云），可以将其配置为 Moon。那么，你的所有国内设备在连接时，会优先通过这个国内的 Moon 服务器进行通信和中转，速度更快、更稳定。
    2.  **提升连接成功率：** 在某些特殊网络环境下，设备可能很难连接上远在海外的 Planet，但可以轻松连接到你本地的 Moon，从而成功接入 ZeroTier 网络。
    3.  **增强私密性（一定程度上）：** 你的大部分协调和中转流量不再必须经过 ZeroTier 官方的 Planet 服务器。
*   **特点：**
    *   **自行搭建：** 需要用户自己有一台具有公网 IP、网络稳定的服务器（VPS）来搭建。
    *   **免费软件：** 搭建 Moon 的功能是 ZeroTier 软件自带的，无需额外付费。
    *   **辅助角色：** Moon 不替代 Planet。设备仍然需要 Planet 来进行最初的认证和授权，但一旦“认识”了 Moon，后续的通信会优先选择 Moon。

---

### 一个生动的比喻

把 ZeroTier 网络比作一个跨国公司的电话系统：

*   **Planet 服务器** 就像是公司的 **总机**。每个员工（设备）入职时都要在总机登记。当美国分部的 Alice 想直接呼叫中国分部的 Bob 时，总机帮他们建立直接连接（P2P）。
*   如果 Alice 和 Bob 之间的国际长途线路不好（防火墙/NAT），直接通话失败。
*   这时，总机说：“别急，我们在中国上海有一个**区域办事处（Moon）**，信号很好。Alice，你把电话打到上海办事处，再由办事处转给 Bob。”
*   这个“上海办事处”就是你自建的 **Moon 服务器**，它专门为你公司的中国区员工提供优质的中转服务。

### 总结对比表

| 特性         | Planet（行星）                   | Moon（月球）                 |
| :----------- | :------------------------------- | :--------------------------- |
| **运营方**   | ZeroTier 官方                    | 用户自己                     |
| **成本**     | 免费（有限额）                   | 需要自备服务器（VPS费用）    |
| **主要作用** | 全球根服务器、身份认证、网络控制 | 区域性中转、加速、提升稳定性 |
| **依赖性**   | 必须存在，是网络的基础           | 可选配件，用于优化体验       |
| **好比**     | 互联网的根DNS服务器              | 你自己搭建的私有CDN节点      |

### 给你的建议

*   **对于大多数普通用户**：如果只是连接少数几台设备，且网络环境不错，直接使用 ZeroTier 官方的 Planet 服务就足够了。
*   **如果你在中国大陆**，并且遇到以下情况，**强烈建议自建一个 Moon**：
    *   设备之间无法直连，且通过 Planet 中转速度很慢、延迟很高。
    *   有时连不上 ZeroTier 网络。
    *   有重要的设备需要稳定、低延迟的组网需求。

## ZeroTier配置Moon服务器

在阿里云创建Ubuntu20.04，防火墙开放UDP协议20378/65000端口。

安装ZeroTier

```sh
curl -s https://install.zerotier.com | sudo bash
```

加入网络

```sh
sudo zerotier-cli join <你的16位网络ID>
```

登录ZeroTier Central授权该节点接入。

把默认端口9993修改为55000

- 创建文件/var/ib/zerotier-one/local.conf

  ```json
  {
    "settings": {
      "primaryPort": 55000
    }
  }
  ```

生成Moon配置文件

```sh
# 切换到 ZeroTier 目录
cd /var/lib/zerotier-one

# 生成月球配置，‘000000’是占位符，会自动被你的节点ID替换
sudo zerotier-idtool initmoon identity.public > moon.json
```

 编辑moon.json配置文件补充公网IP地址

```sh
# 将 "stableEndpoints"修改为你的服务器的公网 IP 和 ZeroTier 端口
# 配置文件中其它信息不需要修改
"stableEndpoints": [ "1.2.3.4/55000" ]
```

编译并签名Moon配置

```sh
# 使用以下命令将 moon.json编译成最终的二进制配置文件 000000xxx.moon
sudo zerotier-idtool genmoon moon.json
```

将Moon配置文件移动到正确位置并重启服务

```sh
# 切换到 ZeroTier 目录
cd /var/lib/zerotier-one

# 创建 moons.d 目录（如果不存在）
sudo mkdir -p moons.d

# 将生成的 .moon 文件移动到 moons.d 目录
sudo mv 000000xxx.moon moons.d/

# 重启 ZeroTier 服务
sudo systemctl restart zerotier-one
```

验证Moon是否运行成功

```sh
sudo zerotier-cli listmoons
```

客户端配置指定使用Moon服务器通讯（iStoreOS中需要提供ZEROTIER_HOME=/etc/config/zero环境变量，否则会报告`zerotier-cli: missing port and zerotier-one.port not found in /var/lib/zerotier-one`错误，例如：ZEROTIER_HOME=/etc/config/zero zerotier-cli xxx）

```sh
# 在 Moon 服务器上运行 zerotier-cli listmoons看到的那个 ID，就是你的 Moon ID
zerotier-cli listmoons

# 在你的电脑上，执行加入命令
# 需要管理员权限
sudo zerotier-cli orbit <Moon-ID> <Moon-ID>

# 在你的电脑上验证客户端是否成功连接至 Moon
zerotier-cli listpeers
# 在输出的对等节点列表中，找到你的 Moon ID 那一行。如果连接成功，你会看到它后面有 MOON标识，并且有延迟信息，例如：
200 listpeers <Moon-ID> <Moon-IP>/9993;1234;1234 105 - MOON
```

## ZeroTier客户端macOS安装

步骤如下：

1. 切换网络：macOS系统连接到手机热点，否则如果连接到公司网络不能更加真实地模拟异地办公。

2. 下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MacOS PKG Installer，双击Installer根据提示安装即可。

3. 加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID（咨询网络管理员获取，目前测试使用：b6079f73c6ec26a7）。 

4. 查看网络状态并授权：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络（咨询网络管理员授权）。

5. 再次查看网络为OK状态：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: OK`功能。

6. 设置客户端流量走私有服务器：打开终端并执行下面命令

   ```sh
   # 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
   $ sudo zerotier-cli orbit 32c336b0cf 32c336b0cf
   200 orbit OK
   
   # 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
   $ sudo zerotier-cli listpeers
   200 listpeers <ztaddr> <path> <latency> <version> <role>
   ...
   200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
   ...
   ```

7. 测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

   ```sh
   $ ping 192.168.1.1                             
   PING 192.168.1.1 (192.168.1.1): 56 data bytes
   64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
   64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
   64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
   64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
   64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
   64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
   64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
   ```


## ZeroTier客户端Windows11安装

步骤如下：

1. 切换网络：Windows11系统连接到手机热点，否则如果连接到公司网络不能更加真实地模拟异地办公。

2. 下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MSI Installer(x86/x64)，双击Installer根据提示安装即可。

3. 加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID（咨询网络管理员获取，目前测试使用：b6079f73c6ec26a7）。 

4. 查看网络状态并授权：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络（咨询网络管理员授权）。

5. 再次查看网络为OK状态：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: OK`功能。

6. 设置客户端流量走私有服务器：打开终端（使用管理员身份打开终端）并执行下面命令

   ```sh
   # 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
   $ zerotier-cli orbit 32c336b0cf 32c336b0cf
   200 orbit OK
   
   # 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
   $ zerotier-cli listpeers
   200 listpeers <ztaddr> <path> <latency> <version> <role>
   ...
   200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
   ...
   ```

7. 测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

   ```sh
   $ ping 192.168.1.1                             
   PING 192.168.1.1 (192.168.1.1): 56 data bytes
   64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
   64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
   64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
   64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
   64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
   64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
   64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
   ```


## ZeroTier客户端Ubuntu20.04安装

安装ZeroTier客户端

```sh
curl -s https://install.zerotier.com | sudo bash

# 查看ZeroTier服务状态为running状态
sudo systemctl status zerotier-one
```

加入网络

```sh
sudo zerotier-cli join b6079f73c6ec26a7
```

查看当前网络状态为ACCESS_DENIED

```sh
$ sudo zerotier-cli listnetworks
200 listnetworks <nwid> <name> <mac> <status> <type> <dev> <ZT assigned ips>
200 listnetworks b6079f73c6ec26a7  a6:95:37:0d:bd:b0 ACCESS_DENIED PRIVATE ztyxaxgvlb -
```

登录ZeroTier控制台授权客户端接入。

再次查看网络状态变为OK

```sh
$ sudo zerotier-cli listnetworks
200 listnetworks <nwid> <name> <mac> <status> <type> <dev> <ZT assigned ips>
200 listnetworks b6079f73c6ec26a7 dexterleslie's 1st network a6:95:37:0d:bd:b0 OK PRIVATE ztyxaxgvlb 10.244.97.154/16
```

设置客户端流量走私有服务器：打开终端并执行下面命令

```sh
# 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
$ sudo zerotier-cli orbit 32c336b0cf 32c336b0cf
200 orbit OK

# 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
$ sudo zerotier-cli listpeers
200 listpeers <ztaddr> <path> <latency> <version> <role>
...
200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
...
```

测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

```sh
$ ping 192.168.1.1                             
PING 192.168.1.1 (192.168.1.1): 56 data bytes
64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
```

## TailScale总结

## TailScale信息

访问 https://tailscale.com/ 使用GitHub登录TailScale。

## TailScale概念

### 核心一句话概括

**Tailscale 是一个基于 WireGuard 的零信任网络平台，它能让你像在一个安全的局域网里一样，轻松连接和管理你分布在世界各地的任何设备。**

---

### 用一个生动的比喻来理解

想象一下，你的所有设备（公司电脑、家里电脑、云服务器、甚至你的手机）本来都散落在世界各地，像一个个孤岛。

*   **传统方式（如端口转发、VPN）：** 你需要在每个岛之间手动搭建坚固的桥梁，配置非常复杂，而且维护起来很麻烦。
*   **Tailscale 的方式：** Tailscale 像一位“魔法师”，它用一个安全的、隐形的隧道把所有岛屿都连接起来，组成了一个私有的“魔法网络”。在这个网络里，所有设备无论物理位置在哪，都感觉像是在同一个房间里，可以直接用内网IP地址互相访问。

---

### Tailscale 的核心工作原理

1.  **基于 WireGuard**：Tailscale 使用 WireGuard 这个现代、快速、极其安全的 VPN 协议作为底层技术。这意味着连接速度很快，加密强度很高。
2.  **零信任安全模型**：默认情况下，设备之间不能互相访问。你必须明确授权“谁可以访问什么”。
3.  **基于身份认证**：你不需要记复杂的IP地址或密码。你使用一个已有的身份（如 Google、Microsoft、GitHub 账户，或企业版的 Okta 等）登录 Tailscale 客户端。设备访问权限直接和你的身份绑定。
4.  **NAT 穿透**：这是 Tailscale 的“魔法”所在。它能够智能地让两个在各自防火墙后面的设备直接建立点对点连接，而无需手动配置路由器或设置公网IP。这大大简化了部署。

---

### Tailscale 的主要功能和优势

*   **极其简单易用**：通常在设备上安装客户端，登录账号，设备就自动上线并可以互相发现了。几乎没有学习成本。
*   **无需公网IP，无需配置路由器**：彻底解决了家庭宽带没有公网IP的难题。
*   **跨平台支持**：几乎支持所有主流平台：Windows, macOS, Linux, iOS, Android, Raspberry Pi，甚至可以在路由器、NAS 和云服务器上运行。
*   **安全的节点间通信**：只有你授权网络里的设备才能相互通信，通信过程全程加密。
*   **子网路由**：可以让 Tailscale 网络中的设备访问你家中或公司里整个物理局域网的其他设备，非常强大。
*   **出口节点**：可以将某个设备（如家中的服务器）设置为出口节点，其他设备（如你在咖啡馆的笔记本）可以通过它来上网，这样你的网络流量就会从家中出口，更加安全。

---

### 常见的应用场景

1.  **远程访问家庭或公司内部服务**：在外面用笔记本或手机，直接访问家里的 NAS、打印机、路由器管理界面，或者访问公司内网的开发服务器、数据库。
2.  **访问云服务器**：将你在阿里云、腾讯云、AWS 上的服务器轻松加入你的私有网络，用内网IP直接管理，无需暴露SSH等端口到公网。
3.  **组建虚拟局域网玩游戏**：和朋友组建一个虚拟局域网，玩一些只支持局域网联机的经典游戏。
4.  **移动办公**：安全地访问企业的内部系统，体验就像坐在办公室里一样。
5.  **设备间文件共享**：直接在手机、电脑、平板之间用内网IP传输文件，速度快且安全。

---

### 收费模式

*   **个人版**：对个人用户和最多 3 个用户的小团队**免费**，功能已经非常强大，完全够用。
*   **付费版**：提供更高级的功能，如单点登录、更多的策略控制、审计日志等，主要面向企业用户。

### 总结

**Tailscale 的核心价值在于，它用极简的操作，解决了复杂的网络连接问题，同时提供了企业级的安全性。** 它让组建和维护一个安全的私有网络变得像登录微信一样简单。如果你有远程访问设备的需求，Tailscale 绝对是一个值得尝试的神器。

## TailScale入门

>说明：演示远程的Windows11和公司的Windows11内网通信。
>
>官方参考链接：https://tailscale.com/kb/1017/install

访问 https://tailscale.com/ 使用GitHub登录。

家中Windows11安装并配置TailScale客户端：在`Let’s add your first device.`向导选择Windows下载客户端软件，手动安装客户端（使用非管理员身份运行客户端安装程序）后点击TailScale`托盘图标`>`Log in...`功能，此时会自动打开浏览器并跳转到TailScale登录页面，复制登录链接到平时经常访问GitHub等浏览器中并授权客户端设备连接到TailScale网络中。

公司Windows11安装并配置TailScale客户端：参考上面步骤安装并配置客户端即可。

测试ping：添加公司Windows11客户端后，TailScale控制台会自动跳转到`Done! Your devices can now connect from anywhere.`向导页面，点击`copy command`复制ping命令测试网络连通性：

```sh
ping 100.72.48.8
```

点击`Success,it works`按钮跳转到TailScale控制台。

禁用key过期：点击对应主机后的`Disable key expiry`功能即可禁用。

## TailScale异地组网

>说明：组网方案为TailScale官方控制台+自建DERP服务器。
>
>DERP服务器搭建过程参考链接：https://www.cnblogs.com/ivwv/p/18499012
>
>网络调试参考链接：https://headscale.net/stable/ref/debug/
>
>DERP服务器：https://headscale.net/stable/ref/derp/

参考上面的“TailScale入门配置“先配置两台Windows11通过TailScale网络能够相互ping通对方。

参考 https://tailscale.com/kb/1406/quick-guide-subnets 在公司的Ubuntu上配置子网路由为公司网络192.168.1.0/24，步骤如下：

1. 公司Ubuntu异地组网主机安装TailScale

   安装TailScale客户端

   ```sh
   curl -fsSL https://tailscale.com/install.sh | sh
   ```

   启动TailScale客户端

   ```sh
   sudo tailscale up
   ```

   复制链接 https://login.tailscale.com/a/xxx 授权TailScale客户端接入TailScale网络。

2. 启用IP转发

   ```sh
   echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
   echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
   sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
   ```

3. 为公司Ubuntu主机发布子网路由。将以下示例中的子网替换为您网络中的子网。

   ```sh
   sudo tailscale set --advertise-routes=192.168.1.0/24
   ```

4. 转到管理控制台的[Machines](https://login.tailscale.com/admin/machines)页面，并在列表中找到该设备。它应该会显示**Subnets**徽章。

5. 选择`...`图标菜单，然后选择**Edit route settings**。

6. 选中与要通告的子网路由对应的 IP 地址范围框，然后选择**Save**。

在家中的Windows11测试公司子网的连通性

```cmd
ping 192.168.1.1 -t
```

自建DERP服务器：

1. 访问 https://go.dev/dl/go1.23.2.linux-amd64.tar.gz 下载go安装包

2. 解压go安装包

   ```sh
   rm -rf /usr/local/go && tar -C /usr/local -xzf go1.23.2.linux-amd64.tar.gz
   ```

3. 创建/etc/profile.d/go.sh文件内容如下：

   ```sh
   #!/bin/bash
   
   export GOPROXY=https://goproxy.cn
   export GO111MODULE=on
   export PATH=$PATH:/usr/local/go/bin
   ```

4. 加载/etc/profile.d/go.sh配置查看go版本

   ```sh
   source /etc/profile.d/go.sh
   go version
   ```

5. 拉取derper源代码

   ```sh
   # v1.90.1版本
   go install tailscale.com/cmd/derper@75b0c6f
   ```

6. 修改derper源代码以支持https自签名证书

   ```sh
   # 进入到编译好的文件夹(不要直接复制命令，按实际情况填写,配合 Tab 按键补全路径)
   cd /root/go/pkg/mod/tailscale.com@@v1.90.1/cmd/derper/
   
   # 编辑 cert.go 文件
   vim cert.go
   
   # 找到以下内容并将部分代码注释
   // 原始代码
   func (m *manualCertManager) getCertificate(hi *tls.ClientHelloInfo) (*tls.Certificate, error) {
       if hi.ServerName != m.hostname {
           return nil, fmt.Errorf("cert mismatch with hostname: %q", hi.ServerName)
       }
       
   // 改为
   func (m *manualCertManager) getCertificate(hi *tls.ClientHelloInfo) (*tls.Certificate, error) {
       // if hi.ServerName != m.hostname {
       //     return nil, fmt.Errorf("cert mismatch with hostname: %q", hi.ServerName)
       // }
   ```

7. 编译并输出到 /etc/derp/

   ```sh
   go build -o /etc/derp/derper
   ```

8. 查看是否存在 derper 文件

   ```sh
   ls /etc/derp
   ```

9. 自签证书(derp.myself.com可随意编写，命令中四处需要一致)

   ```sh
   cd /etc/derp
   
   openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes -keyout /etc/derp/derp.myself.com.key -out /etc/derp/derp.myself.com.crt -subj "/CN=derp.myself.com" -addext "subjectAltName=DNS:derp.myself.com"
   ```

10. 防火墙开放33445(tcp)、3478(udp)端口

11. 设置开机自启，创建/etc/systemd/system/derp.service内容如下：

    ```ini
    [Unit]
    Description=TS Derper
    After=network.target
    Wants=network.target
    
    [Service]
    User=root
    Restart=always
    ExecStart=/etc/derp/derper -hostname derp.myself.com -a :33445 -stun -stun-port 3478 -http-port 33446 -certmode manual -certdir /etc/derp
    RestartPreventExitStatus=1
    
    [Install]
    WantedBy=multi-user.target
    
    ```

12. 设置开机自启

    ```sh
    systemctl enable derp && systemctl start derp
    ```

13. 验证 DERP 服务，浏览器打开：https://ip:33445 页面正常显示 DERP 即可

14. 修改 Tailscale 配置文件

    打开 Tailscale 控制台 https://login.tailscale.com/admin/acls/file，添加以下内容：

    - IPv4 修改为自己服务器的 IP
    - RegionCode 自定义即可
    - RegionName 自定义即可

    ```json
    "derpMap": {
    		"OmitDefaultRegions": true,
    		"Regions": {
    			"901": {
    				"RegionID":   901,
    				"RegionCode": "myderp",
    				"RegionName": "My Derper",
    				"Nodes": [
    					{
    						"Name":             "901",
    						"RegionID":         901,
    						"IPv4":             "x.x.x.x",
    						"DERPPort":         33445,
    						"STUNPort":         3478,
    						"InsecureForTests": true,
    					},
    				],
    			},
    		},
    	},
    ```

15. 检查可用性

    在任意链接 Tailscale 的电脑上终端输入

    ```sh
    $ tailscale netcheck
    2025/11/23 13:09:56 portmap: monitor: gateway and self IP changed: gw=192.168.3.1 self=192.168.3.2
    
    Report:
            * Time: 2025-11-23T05:09:56.8883279Z
            * UDP: true
            * IPv4: yes, x.x.x.x:1211
            * IPv6: no, but OS has support
            * MappingVariesByDestIP:
            * PortMapping:
            * Nearest DERP: My Derper
            * DERP latency:
                    - myderp: 36.9ms  (My Derper)
                    
    $ tailscale status
    100.88.180.26  mywindows11           dexterleslie1@  windows  -
    100.79.178.86  ubuntu-subnet-office  dexterleslie1@  linux    active; relay "myderp", tx 34637196 rx 712989676
    100.72.248.83  windows11home-vm      dexterleslie1@  windows  offline, last seen 1h ago
    
    # Health check:
    #     - Tailscale can't reach the configured DNS servers. Internet connectivity may be affected.
    #     - Tailscale could not establish an encrypted connection with '""': likely intercepted connection; certificate is self-signed by O=Internet Widgits Pty Ltd,ST=Some-State,C=AU
    ```

## TailScale安装 - macOS

访问 https://tailscale.com/download/mac 下载TailScale客户端并根据提示安装（授予安装过程提示的权限）。

加入TailScale网络：打开Terminal执行下面命令

```sh
/Applications/Tailscale.app/Contents/MacOS/Tailscale login --auth-key tskey-auth-xxx --accept-routes
```

测试公司内网的连通性

```sh
ping 192.168.1.1
```

## TailScale命令 - netcheck

`tailscale netcheck` 是一个非常有用的诊断命令，它的主要作用是**全面检测当前设备与 Tailscale 网络环境的连接状况**。

### 主要作用

#### 1. **网络连接诊断**
检测设备能否正常访问 Tailscale 的网络基础设施，包括：
- Derper 中继服务器（Relay Server）
- 控制服务器（Control Plane）
- DNS 服务器

#### 2. **NAT 和防火墙检测**
分析设备的网络环境：
- NAT 类型（对称型、锥型等）
- UDP 是否被阻止
- IPv6 支持情况
- UPNP 是否可用

#### 3. **最佳路径发现**
帮助 Tailscale 确定设备间的最优通信路径：
- 是否可以直接点对点连接（P2P）
- 是否需要通过中继服务器
- 网络延迟和带宽状况

### 命令输出详解

运行 `tailscale netcheck` 的典型输出：

```bash
$ tailscale netcheck

Report:
	* UDP: true
	* IPv4: yes, 123.45.67.89:54321
	* IPv6: no
	* MappingVariesByDestIP: false
	* HairPinning: false
	* PortMapping: 
	* CaptivePortal: false
	* Nearest DERP: San Francisco
	* DERP latency:
		- sfo: 12.3ms  (San Francisco)
		- nyc: 65.4ms  (New York)
		- lhr: 125.1ms (London)
		- tok: 158.9ms (Tokyo)
```

### 各字段含义

| 字段                      | 含义                 | 重要性                       |
| ------------------------- | -------------------- | ---------------------------- |
| **UDP**                   | 是否支持 UDP 协议    | 关键，Tailscale 主要依赖 UDP |
| **IPv4/IPv6**             | 支持的 IP 协议版本   | 影响连接方式                 |
| **MappingVariesByDestIP** | NAT 对称性检测       | 影响 P2P 连接能力            |
| **HairPinning**           | NAT 回环支持         | 影响本地网络访问             |
| **Nearest DERP**          | 最近的中继服务器     | 了解网络优化情况             |
| **DERP latency**          | 到各中继服务器的延迟 | 诊断跨国连接问题             |

### 实际应用场景

#### 场景1：连接问题诊断
```bash
# 当 Tailscale 连接异常时，首先运行：
tailscale netcheck
# 如果 UDP 显示为 false，说明网络阻止了 UDP 协议
```

#### 场景2：网络环境变化检测
```bash
# 从公司网络切换到家庭网络后检查
tailscale netcheck
# 查看 NAT 类型和 DERP 延迟变化
```

#### 场景3：服务器部署前检查
```bash
# 在云服务器上部署 Tailscale 前验证网络配置
tailscale netcheck
# 确保 UDP 未被防火墙阻止
```

### 常见问题排查

#### 问题1：UDP 被阻止
```
UDP: false
```
**解决方案**：检查防火墙是否允许 UDP 协议，或配置 Tailscale 使用 HTTP 代理。

#### 问题2：高延迟
```
DERP latency:
  - sfo: 350ms
  - nyc: 450ms  
```
**解决方案**：可能是网络拥塞或路由问题，尝试切换网络环境。

#### 问题3：对称型 NAT
```
MappingVariesByDestIP: true
```
**解决方案**：这种 NAT 类型会阻止直接 P2P 连接，设备将通过 DERP 中继通信。

### 高级用法

#### 指定检查服务器
```bash
# 检查特定区域的 DERP 服务器
tailscale netcheck --derp=nyc
```

#### 详细模式
```bash
# 显示更详细的检测信息
tailscale netcheck --verbose
```

#### 结合其他命令
```bash
# 完整网络诊断组合
tailscale status
tailscale netcheck
tailscale ping <peer-ip>
```

### 总结

`tailscale netcheck` 是：
- ✅ **连接问题的一线诊断工具**
- ✅ **网络环境分析的利器**  
- ✅ **P2P 连接能力的检测器**
- ✅ **Tailscale 运维的必备命令**

当遇到 Tailscale 连接问题时，**第一个应该运行的命令就是 `tailscale netcheck`**，它能快速定位大部分网络层面的问题。

### 示例

在公司网络中运行下面命令：

```sh
$ tailscale netcheck
2025/11/19 13:59:16 portmap: monitor: gateway and self IP changed: gw=192.168.235.2 self=192.168.235.133

Report:
        * Time: 2025-11-19T05:59:21.2369527Z
        * UDP: true
        * IPv4: yes, 14.19.193.124:54599
        * IPv6: no, but OS has support
        * MappingVariesByDestIP: false
        * PortMapping:
        * CaptivePortal: false
        * Nearest DERP: Hong Kong
        * DERP latency:
                - hkg: 160.6ms (Hong Kong)
                - sfo: 170.6ms (San Francisco)
                - sea: 180.1ms (Seattle)
                - nue: 180.1ms (Nuremberg)
                - den: 188.5ms (Denver)
                - lax: 191.1ms (Los Angeles)
                - dfw: 210ms   (Dallas)
                - hel: 210ms   (Helsinki)
                - hnl: 217.8ms (Honolulu)
                - tok: 220.7ms (Tokyo)
                - tor: 220.7ms (Toronto)
                - mia: 226.2ms (Miami)
                - ord: 234.9ms (Chicago)
                - nyc: 238.6ms (New York City)
                - iad: 240.6ms (Ashburn)
                - lhr: 249.1ms (London)
                - ams: 255.9ms (Amsterdam)
                - sin: 260.6ms (Singapore)
                - fra: 260.6ms (Frankfurt)
                - mad: 264.3ms (Madrid)
                - waw: 270.5ms (Warsaw)
                - par: 271.2ms (Paris)
                - syd: 320.1ms (Sydney)
                - blr: 347.5ms (Bangalore)
                - sao: 367.1ms (São Paulo)
                - nai: 380.8ms (Nairobi)
                - jnb: 417.2ms (Johannesburg)
                - dbi: 417.9ms (Dubai)

```

## TailScale命令 - ping

`tailscale ping` 是一个重要的网络诊断命令，用于**测试与 Tailscale 网络中其他设备的连接性和网络路径**。

### 主要作用

#### 1. **基础连通性测试**
检查当前设备能否成功到达 Tailscale 网络中的其他设备。

#### 2. **连接路径分析**
显示数据包实际经过的网络路径（直接 P2P 或通过中继）。

#### 3. **网络性能测量**
测量到目标设备的往返延迟（RTT）和连接稳定性。

### 基本语法

```bash
# 使用目标设备的 Tailscale IP
tailscale ping 100.100.100.100

# 使用 MagicDNS 主机名
tailscale ping my-computer

# 使用机器名
tailscale ping office-server

# 使用域名（如果配置了）
tailscale ping mypc.example.com
```

### 命令输出详解

#### 成功连接示例
```bash
$ tailscale ping 100.101.102.103
pong from office-pc (100.101.102.103) via DFR(nyc) in 35ms
pong from office-pc (100.101.102.103) via DFR(nyc) in 32ms
pong from office-pc (100.101.102.103) via DFR(nyc) in 31ms
```

#### 输出字段含义
- **pong from office-pc**: 目标设备名称
- **(100.101.102.103)**: 目标设备的 Tailscale IP
- **via DFR(nyc)**: 连接路径（通过纽约中继服务器）
- **in 35ms**: 往返延迟时间

### 连接路径类型

#### 1. **直接 P2P 连接**
```
pong from laptop (100.100.100.100) via [直接连接] in 12ms
```
**最佳情况**：设备间建立直接点对点连接，延迟最低。

#### 2. **DERP 中继连接**
```
pong from server (100.100.100.200) via DFR(sfo) in 45ms
```
**via DFR(地区代码)**: 通过 Tailscale 的中继服务器转发。

#### 3. **出口节点连接**
```
pong from remote-server (100.100.100.150) via exit-node(nyc) in 65ms
```
通过出口节点路由流量。

### 实际应用场景

#### 场景1：基础连通性检查
```bash
# 检查能否访问办公室服务器
tailscale ping office-server

# 检查特定 IP 的设备
tailscale ping 100.101.102.103
```

#### 场景2：网络路径诊断
```bash
# 查看连接是否走中继
tailscale ping remote-colleague
# 如果显示 via DFR(...)，说明是中继连接
```

#### 场景3：延迟测试
```bash
# 持续测试网络质量
tailscale ping -c 10 file-server
# 发送10个ping包测试稳定性
```

### 常用参数选项

#### `-c` 指定ping次数
```bash
# 只发送5个ping包后停止
tailscale ping -c 5 100.100.100.100
```

#### `-verbose` 详细模式
```bash
# 显示更详细的连接信息
tailscale ping -verbose my-server
```

#### `-until-direct` 直到直连
```bash
# 持续ping直到建立直接连接
tailscale ping -until-direct remote-device
```

### 故障排查示例

#### 问题1：无法解析主机名
```bash
$ tailscale ping unknown-host
ping failed: tailscale.com/tsd/hosts.localhost: unknown host
```
**解决方案**：检查设备名拼写，或使用 IP 地址。

#### 问题2：连接超时
```bash
$ tailscale ping 100.100.100.100
timeout waiting for ping response
```
**解决方案**：目标设备可能离线或防火墙阻止。

#### 问题3：高延迟中继连接
```bash
pong from server via DFR(sgp) in 285ms
```
**解决方案**：尝试优化 NAT 穿透或检查网络配置。

### 与其他命令结合使用

#### 完整诊断流程
```bash
# 1. 检查设备状态
tailscale status

# 2. 网络环境检测
tailscale netcheck

# 3. 测试到特定设备的连接
tailscale ping target-device

# 4. 详细路径跟踪
tailscale ping -verbose target-device
```

#### 批量测试脚本
```bash
#!/bin/bash
# 测试到多个关键设备的连接性
DEVICES=("100.101.102.103" "db-server" "web-server")

for device in "${DEVICES[@]}"; do
    echo "Testing connection to $device:"
    tailscale ping -c 3 $device
    echo "---"
done
```

### 高级用法

#### 自动化监控
```bash
# 定期检查关键连接并记录结果
while true; do
    echo "$(date): $(tailscale ping -c 1 monitor-server | grep -o 'in [0-9]*ms')" >> ping-log.txt
    sleep 60
done
```

#### 结合调试模式
```bash
# 启用详细日志进行深度诊断
tailscale ping -verbose -c 5 problem-device
```

### 总结

`tailscale ping` 是 Tailscale 网络运维中不可或缺的工具：

- ✅ **快速验证设备间连通性**
- ✅ **诊断连接路径问题**  
- ✅ **测量网络性能指标**
- ✅ **识别 NAT 穿透成功与否**
- ✅ **监控网络质量变化**

当遇到 Tailscale 连接问题时，结合 `tailscale netcheck` 和 `tailscale ping` 可以快速定位大部分网络层面的故障。

### 示例

从手机热点网络ping公司服务器，说明流量走三番市DERP中继服务器。

```sh
$ tailscale ping windows11office
pong from windows11office (100.72.48.8) via DERP(sfo) in 432ms
pong from windows11office (100.72.48.8) via DERP(sfo) in 474ms
pong from windows11office (100.72.48.8) via DERP(sfo) in 1.197s
```

从公司网络ping公司服务器，说明流量p2p连接。

```sh
$ tailscale ping windows11office
pong from windows11office (100.72.48.8) via 192.168.1.41:41641 in 3ms
```

## TailScale命令 - status

`tailscale status` 命令用于**查看当前 Tailscale 网络的状态信息**，它提供了一个清晰的概览，告诉你哪些设备在线、它们是如何连接的，以及你的设备在虚拟网络中的情况。

---

### 命令的主要作用

简单来说，这个命令回答以下几个核心问题：
1.  **我的 Tailscale 网络里现在有哪些设备？**
2.  **这些设备是在线（Online）还是离线（Offline）？**
3.  **它们各自的 IP 地址是什么？**
4.  **我是如何连接到它们的？（是直接点对点连接，还是通过中继服务器？）**

---

### 输出结果详解

运行 `tailscale status` 会得到类似下面的输出：

```bash
$ tailscale status
100.101.102.103   your-laptop            user@example.com   linux   active
100.98.76.54      office-desktop         user@example.com   windows active; relay "nyc"
100.105.105.105   aws-server             user@example.com   linux   active; direct 192.168.1.1:41641
```

每一行代表一台设备，通常包含以下几列信息：

1.  **Tailscale IP 地址**：设备在 Tailscale 虚拟网络中的唯一 IP 地址（以 `100.x.x.x` 开头）。这是你在设备间通信时使用的地址。
2.  **主机名**：设备的名称。
3.  **用户账户**：该设备所属的 Tailscale 账户。
4.  **操作系统**：设备运行的操作系统，如 `linux`、`windows`、`darwin`（macOS）、`ios`、`android` 等。
5.  **状态和连接信息**：这是最关键的部分，可能有以下几种情况：
    *   **`active`**：设备在线，但没有显示具体的连接方式（可能是在同一局域网内或连接非常简单）。
    *   **`active; direct`**：**最佳状态**。表示你的设备与目标设备之间建立了**直接的点对点（P2P）连接**。这通常延迟最低、速度最快。后面的 IP 和端口是 NAT 穿透后使用的地址。
    *   **`active; relay "nyc"`**：表示直接连接失败，双方通过 Tailscale 的**中继服务器（DERP）** 进行通信。这通常发生在复杂的网络环境（如对称型 NAT、严格防火墙）下。延迟会稍高，速度可能不如直接连接。
    *   **`offline`**：设备离线（未运行 Tailscale 或网络不通）。

---

### 常用选项

*   `tailscale status --json`：以 JSON 格式输出结果，便于其他脚本或程序解析。
*   `tailscale status --active`：只显示在线的设备。
*   `tailscale status --self`：只显示当前设备的状态信息。
*   `tailscale status --peers`：显示对等设备（其他设备）的详细信息。

---

### 使用场景举例

1.  **快速诊断连接问题**：如果你无法连接到另一台设备，首先运行 `tailscale status`。如果看到目标设备的状态是 `offline`，说明对方没开机或 Tailscale 未运行。如果状态是 `relay`，说明网络环境导致无法直连，但至少可以通信。
2.  **查看设备的 Tailscale IP**：当你想用 SSH 连接某台设备或配置服务时，需要知道它的 Tailscale IP。
3.  **确认网络拓扑**：了解所有设备是否都正常上线，以及它们之间的连接是否是最优的直接连接。

### 总结

`tailscale status` 是管理 Tailscale 网络时最基础、最常用的命令之一，相当于你的 **Tailscale 网络“仪表盘”**，可以让你一目了然地掌握整个私有网络的实时状态。

## TailScale命令 - set

修改TailScale的主机名称

```sh
tailscale set --hostname=windows11home
```

创建子网

>参考链接：https://headscale.net/stable/ref/routes/#configure-a-node-as-subnet-router

```sh
# 在公司的tailscale主机中执行下面命令创建子网
sudo tailscale set --advertise-routes=192.168.1.0/24
```

## TailScale命令 - logout

退出当前登录用户

```sh
tailscale logout
```

## TailScale命令 - debug

调试名为headscale的derp服务器网络

```sh
tailscale debug derp headscale
```

## TailScale命令 - login

自动授权并登录TailScale客户端：

1. 登录TailScale控制台 https://login.tailscale.com/admin/settings/keys 点击`Generate auth key...`按钮创建授权key

2. TailScale客户端自动登录

   ```sh
   tailscale login --auth-key tskey-auth-xxx --accept-routes
   ```

## HeadScale概念

它是一个开源、自托管的 **Tailscale 控制服务器**。

要完全理解 HeadScale，我们得先快速了解一下 **Tailscale** 是什么。

---

### 第一步：理解 Tailscale

**Tailscale 是一个基于 WireGuard 的零信任网络解决方案。**

*   **核心功能**：它能让你将分布在世界各地的设备（公司服务器、家庭电脑、云上虚拟机、甚至你的笔记本电脑和手机）安全、便捷地组建成一个**私有的虚拟局域网（VPN）**。
*   **工作原理**：它使用了一个名为 **WireGuard** 的、非常先进且高效的 VPN 协议作为底层隧道技术。
*   **便捷性**：Tailscale 最大的卖点是其易用性。你只需要在每个设备上安装 Tailscale 客户端，然后用你的 Google、Microsoft 等单点登录（SSO）账户登录，这些设备就能自动发现对方并建立安全的点对点（P2P）连接。你几乎不需要配置复杂的防火墙规则或网络设置。
*   **商业模式**：Tailscale 公司提供了一个免费的增值模式。免费版适用于个人或小团队。但其核心基础设施（尤其是协调设备发现的控制服务器）是由 Tailscale 公司托管和控制的。

---

### 第二步：HeadScale 的角色

**HeadScale 的出现，解决了 Tailscale 的一个“痛点”：对官方控制服务器的依赖。**

*   **自托管控制平面**：HeadScale 实现了 Tailscale 控制服务器的功能。这意味着你可以**在自己的服务器上**运行 HeadScale，完全掌控你的虚拟网络，不依赖任何第三方服务。
*   **开源**：它是 100% 开源的，你可以审查代码、自行修改和部署。
*   **兼容性**：HeadScale 实现了 Tailscale 的协议，因此它可以与官方的 Tailscale 客户端完美配合工作。

**简单比喻：**

*   **Tailscale 网络** 就像一个私人俱乐部，设备是会员。
*   **Tailscale 官方的控制服务器** 就像是俱乐部**总部管理的会员登记处**。所有会员都需要到总部登记，才能彼此认识并联系。
*   **HeadScale** 则允许你**自己开一个私人俱乐部，并自己担任登记处的管理员**。你的设备都到你这个自建的登记处来注册和协调。

---

### 三、为什么人们需要 HeadScale？主要优势

1.  **数据自主与控制**：所有设备的认证、策略和协调信息都保存在你自己的服务器上，满足了数据隐私和合规性要求极高的场景（如企业内网、敏感数据环境）。
2.  **完全免费，无限制**：Tailscale 免费版有设备数量限制。而使用 HeadScale，你可以管理任意数量的设备，没有硬性限制，成本仅为托管它的一台小服务器的费用。
3.  **绕过封锁**：在某些网络环境下，连接 Tailscale 的官方服务器可能不稳定或被阻断。自建 HeadScale 服务器可以灵活选择网络环境和出口，提高稳定性。
4.  **高度可定制**：你可以深度定制网络策略、访问规则，并与你现有的认证系统（如 LDAP/AD）集成。

---

### 四、典型使用场景

*   **家庭实验室（Homelab）**：这是 HeadScale 最流行的应用场景。通过它，可以安全地从外部网络访问家里的 NAS、软路由、Proxmox 管理界面等所有设备，就像坐在家里一样。
*   **中小企业组网**：将公司总部、分公司和员工家庭办公室的设备和服务器组成一个安全内网，替代传统的、配置复杂的 VPN。
*   **混合云连接**：安全地连接公有云（如 AWS、Azure）上的虚拟机和你本地数据中心的服务器。
*   **开发与测试**：为开发团队提供一个隔离的、安全的网络环境，用于微服务通信和测试。

---

### 五、HeadScale 与 Proxmox 的关系

这两个技术非常契合，常常一起使用：

1.  **在 Proxmox 虚拟机/容器中运行 HeadScale**：你可以在 Proxmox 上创建一个轻量的 Linux 虚拟机或 LXC 容器，专门用来安装和运行 HeadScale 服务。这样它就成为了你整个虚拟化环境的核心网络协调器。
2.  **安全访问 Proxmox 管理界面**：你可以将运行 Proxmox 的物理服务器和你的办公电脑都加入 HeadScale 网络。这样，你就可以在**世界任何地方**，通过安全的 Tailscale 虚拟 IP 地址，访问 Proxmox 的 Web 管理界面（默认端口 8006），而无需将管理端口暴露在公网上。
3.  **连接不同 Proxmox 节点**：如果你有一个 Proxmox 集群，节点可能分布在不同的物理位置。通过为每个节点安装 Tailscale 客户端并加入同一个 HeadScale 网络，可以简化它们之间的通信，特别适合构建跨数据中心的集群。

### 总结

**HeadScale 是一个能让你自己掌控全局的“网络大脑”。** 它剥离了 Tailscale 服务中“控制面板”的部分并将其开源，让你能搭建一个完全属于自己、不受限制、安全高效的虚拟专用网络。

### 搭建

>说明：HeadScale成功搭建，但是因为HeadScale没有支持https导致内置的DERP服务不能成功地为异地主机提供能数据运输服务。
>
>参考 https://sevnday.blog.csdn.net/article/details/154946506、https://cloud.tencent.com/developer/article/2457464 安装HeadScale
>
>HeadScale详细搭建过程请参考本站示例：https://gitee.com/dexterleslie/demonstration/tree/main/vpn

HeadScale创建用户

```sh
headscale user create myuser
```

TailScale客户端指定HeadScale

>参考链接：https://tailscale.com/kb/1507/custom-control-server?tab=windows

```sh
sudo tailscale login --login-server=http://x.x.x.x:8080
```

HeadScale主机确认子网创建请求

>参考链接：https://headscale.net/stable/ref/routes/#configure-a-node-as-subnet-router

```sh
headscale nodes approve-routes --identifier 2 --routes 192.168.1.0/24
```

## DERP概念

### 一句话概括

**Tailscale DERP 是一个由 Tailscale 官方和社区提供的、全球分布的中继服务器网络。当两个设备无法直接建立点对点连接时，它就充当一个“智能中转站”或“中继服务器”，帮助它们可靠地传输数据。**

---

### 详细解释

为了更好地理解，我们把它拆解开来：

#### 1. 核心目标：建立点对点连接

Tailscale 的核心魔力是让两个设备（比如你的笔记本电脑和公司的服务器）尽可能直接连接，也就是所谓的 **NAT 穿透**。这种直接连接延迟最低、速度最快。

#### 2. 问题：当直接连接失败时

但在某些网络环境下（例如在严格的企业防火墙、机场/酒店公共Wi-Fi、或者复杂的多层NAT后），NAT 穿透会失败。两个设备“看”不到对方，无法直接“握手”。

**这时候就需要一个双方都能访问的“中间人”来帮忙传话。**

#### 3. 解决方案：DERP 登场

DERP 就是这个“中间人”。它的全称是 **D** ERP **E** ndpoint **R** elay **P** rotocol。

*   **中继：** DERP 服务器的核心工作就是中继流量。设备A把数据包发给 DERP 服务器，DERP 服务器再转发给设备B，反之亦然。
*   **协议：** 它使用标准的 HTTP/2 协议进行通信，这有一个巨大的好处：HTTP/2 流量（通常走 443 端口）在绝大多数网络环境中都是被允许的，因为它看起来就像普通的 HTTPS 网页流量。这极大地提高了连接成功率。
*   **全球分布：** Tailscale 在世界各地（北美、欧洲、亚洲等）部署了许多 DERP 服务器。你的 Tailscale 客户端会自动选择延迟最低的服务器进行连接。


*上图简化地展示了数据如何通过 DERP 服务器中继。实际上，两个设备会连接到同一个 DERP 服务器进行通信。*

#### 4. DERP 是“保底方案”

非常重要的一点是：**DERP 是 Tailscale 连接建立的最后手段。**

Tailscale 的连接建立过程非常智能，遵循一个“优先级”：
1.  **最高优先级：直接点对点连接** - 尝试各种 NAT 穿透技术（如 UDP hole punching）。
2.  **中等优先级：通过公共 IP 的节点中继** - 如果你有一个有公网IP的设备（如家庭服务器），其他设备可以通过它中继。
3.  **保底方案：使用 DERP 服务器** - 只有当以上所有方法都失败时，才会 fallback（回退）到使用 DERP。

这意味着，在大多数情况下，你的连接是直接的、高效的。只有在网络条件最苛刻时，才会使用 DERP，虽然延迟和速度会受一些影响，但保证了连接的成功和稳定。

#### 5. DERP 的其他重要特性

*   **加密：** 尽管流量经过 DERP 服务器，但它仍然是完全加密的。DERP 服务器只是一个“信使”，它无法解密你设备之间传输的实际数据内容（因为它没有你的私钥）。这得益于 Tailscale 使用的 WireGuard 协议。
*   **自定义 DERP 服务器：** 对于企业用户或对性能有极高要求的用户，可以搭建自己的私有 DERP 服务器，并配置 Tailscale 优先使用。这在需要低延迟中继的场景（例如在同一国家内）非常有用。

### 一个生动的比喻

想象一下有两个特工（**设备A**和**设备B**）在敌后工作，他们想秘密接头：

1.  **理想情况（NAT穿透）：** 他们发现了一个双方都能到达的、隐蔽的小巷子（直接P2P连接），于是直接在那里交换情报，最快最安全。
2.  **困难情况（需要DERP）：** 但他们发现，由于严密的封锁，他们根本无法到达同一个地点。于是，他们决定使用一个**中立国的公共邮局（DERP服务器）**。
    *   特工A把加密的情报（加密流量）寄到邮局。
    *   特工B也连接到这个邮局。
    *   邮局的工作只是把特工A的信件转交给特工B，反之亦然。
    *   邮局的工作人员（DERP服务器）看不到信的内容（数据加密），他们只负责传递。
    *   虽然比直接接头慢一点，但情报传递的通道是100%可靠的。

### 总结

| 特性         | 描述                                                         |
| :----------- | :----------------------------------------------------------- |
| **是什么**   | 一个全球中继服务器网络，是 Tailscale 的连接保底机制。        |
| **何时使用** | 当两个设备无法建立直接点对点连接时。                         |
| **工作原理** | 通过 HTTP/2 协议中继加密的流量，伪装成普通HTTPS流量以绕过防火墙。 |
| **优点**     | **可靠性极高**，几乎能在任何网络环境下建立连接。             |
| **缺点**     | 相比直接P2P连接，延迟稍高，速度可能稍慢（但对于大多数应用足够好）。 |

## TailScale网络权限控制

>说明：使用grants https://tailscale.com/kb/1324/grants 控制网络权限。
>
>autogroups参考：https://tailscale.com/kb/1337/policy-syntax#autogroups
>
>tests断言参考：https://tailscale.com/kb/1337/policy-syntax#tests

控制所有用户只能访问子网192.168.1.182，不能访问其他主机。

```json
// Example/default ACLs for unrestricted connections.
{
	// Define grants that govern access for users, groups, autogroups, tags,
	// Tailscale IP addresses, and subnet ranges.
	"grants": [
		// Allow all connections.
		// Comment this section out if you want to define specific restrictions.
		// 允许访问所有主机
		// {
		// 	"src": ["*"],
		// 	"dst": ["*"],
		// 	"ip":  ["*"],
		// },

         // 允许访问192.168.1.182
		{
			"src": ["*"],
			"dst": ["192.168.1.182"],
			"ip":  ["*"],
		}
	],

	// 测试部分允许您编写关于访问控制策略（授权和 ACL）的断言，这些断言会在每次 TailNet 策略文件更改时作为检查运行。
	// 如果断言失败，Tailscale 将拒绝更新后的 TailNet 策略文件并返回错误。错误消息会指出失败的测试。
	// 测试可确保您不会意外撤销重要权限或暴露关键系统。
	// 断言只能访问192.168.1.182，不能访问192.168.1.51，否则配置不生效
	"tests": [
		{
			"src": "group:autogroup:member",
			// 能够访问192.168.1.182:22
			"accept": ["192.168.1.182:22"],
			// 不能访问192.168.1.51:22
			"deny": ["192.168.1.51:22"],
		},
	],
}

```

