## 异地组网概念

### 一句话概括

**异地组网**，简单来说，就是**将位于不同地理位置的多个本地网络（比如不同城市的办公室、数据中心、家庭网络）通过技术手段安全地连接起来，形成一个统一的、私有的、逻辑上的“大内网”**。

---

### 一个生动的比喻：修建“专属私人高速公路”

想象一下：
*   **每个办公室**就像一个独立的**小区**，小区内部有自己的道路（本地局域网），住户（电脑、打印机、服务器）可以很方便地互相串门。
*   **互联网**就像**遍布全国的公共公路系统**，虽然四通八达，但谁都可以上路，红绿灯多（网络节点），也不够安全。
*   **异地组网**就是在这些公共公路之上，为你和你的公司**修建了一条连接各个小区的“专属私人高速公路”**。

在这条“私人高速公路”上：
*   **直达快捷**：数据包从A小区到B小区，就像直通车，速度更快、延迟更低。
*   **高度安全**：这条路只有你的车辆（经过加密的数据）可以通行，外人无法进入，通信内容不会被窃听。
*   **统一管理**：所有连接起来的小区，感觉就像在一个超大小区里一样。你可以用在内网一样的方式（比如直接输入`192.168.1.100`这样的内网IP）访问另一个城市的服务器或共享文件。

---

### 异地组网主要用来做什么？（应用场景）

这是理解其价值的关键：

1.  **企业分支互联**：这是最经典的场景。公司总部、分公司、办事处之间的网络打通，实现：
    *   **内部系统访问**：分支机构员工可以像在总部一样，安全地访问内部的ERP、OA、财务等系统。
    *   **共享文件/数据库**：直接访问中心机房的文件服务器和数据库，保证数据一致性。
    *   **内部通讯**：使用内网电话、视频会议系统更加流畅稳定。

2.  **远程办公**：员工在家、在咖啡馆或出差时，通过VPN客户端连接到公司网络，安全地访问内部资源，就像坐在办公室里一样。

3.  **数据中心容灾备份**：两个或多个数据中心之间需要实时同步数据，异地组网可以提供稳定、高速、安全的专用通道。

4.  **连锁门店管理**：全国各地的零售店、餐厅将其收银系统、监控录像实时传回总部中心服务器进行统一管理和分析。

5.  **个人与家庭应用**：
    *   **访问家庭NAS**：在外面用手机或电脑，像在家里一样访问自己NAS上的电影、文档。
    *   **远程控制智能家居**：安全地远程控制家里的灯光、摄像头等设备。

---

### 如何实现异地组网？（主流技术）

实现方式主要有以下几种，从传统到现代：

1.  **传统VPN**
    *   **IPSec VPN**：非常成熟稳定，企业级应用广泛，安全性极高。但配置相对复杂。
    *   **SSL VPN**：基于浏览器，使用方便（任何有浏览器的设备都能连），更适合远程办公用户。

2.  **SD-WAN（软件定义广域网）**
    *   这是当前的主流和趋势。它比传统VPN更智能，可以同时利用多条网络链路（如宽带、4G/5G、专线），自动选择最佳路径来传输数据，从而**提升速度和可靠性**。管理和配置也通常在云端进行，非常灵活。

3.  **MPLS（多协议标签交换）**
    *   一种传统的运营商级专线技术，性能稳定、质量高，但**价格非常昂贵**，部署周期长，灵活性差。目前正逐渐被SD-WAN替代或融合。

4.  **新兴的“零信任”网络访问方案**
    *   理念更先进，核心思想是“从不信任，永远验证”。它不强调把用户“拉进”内网，而是根据用户身份和设备状态，动态授予最小权限的访问权限，安全性更高。

---

### 总结：核心价值

| 特性       | 描述                                   | 带来的好处                 |
| :--------- | :------------------------------------- | :------------------------- |
| **统一性** | 将分散的网络整合为一体                 | 方便管理，提高协作效率     |
| **安全性** | 通过加密隧道在公网上传输数据           | 保护商业机密和敏感数据     |
| **便捷性** | 访问远程资源像访问本地一样简单         | 提升工作效率，支持灵活办公 |
| **经济性** | 相比昂贵的物理专线（如MPLS），成本更低 | 尤其对中小企业友好         |

## SD-WAN异地组网概念

### 一句话概括

**SD-WAN异地组网，就是利用软件定义的技术，智能、高效、低成本地将分布在不同地理位置的办公室、数据中心和云服务连接起来，形成一个统一、安全的“专用大内网”。**

---

### 一个生动的比喻：以前的网络是“固定电话”，SD-WAN是“智能手机”

为了更好地理解，我们打个比方：

1.  **传统企业专线（如MPLS VPN）：固定电话时代**
    *   **特点**：稳定、可靠、质量高，但非常**昂贵**，开通慢（需要运营商上门拉线，等几个月）。
    *   **问题**：就像你只能通过一部昂贵的座机打电话。如果要从北京总部联系上海分部，必须用这条昂贵的“专线”。想访问互联网（比如查资料），也得先绕到总部，再出去，速度慢。
    *   **不灵活**：增加一个新分公司，又得拉一条新专线，费时费钱。

2.  **SD-WAN异地组网：智能手机时代**
    *   **特点**：**智能、灵活、高性价比**。它利用任何可用的网络（如便宜的普通宽带、4G/5G、甚至专线）来“组网”。
    *   **核心智能**：你的手机上可以同时用**Wi-Fi、5G流量**。当你走进咖啡馆，手机会自动从5G切换到更快的Wi-Fi。SD-WAN就是这个“智能大脑”。
    *   **具体工作方式**：
        *   **多链路聚合**：SD-WAN设备可以同时接入普通宽带、4G/5G、甚至保留原有的专线。
        *   **智能选路**：当北京的员工要访问上海的公司系统时，SD-WAN会实时检测所有可用的网络路径（宽带1、宽带2、5G），**自动选择当前最快、最稳定、延迟最低的那条路**来传输数据。就像手机在Wi-Fi信号不好时自动切到5G。
        *   **保障重要应用**：可以设置策略，比如“视频会议的数据最优先，走最好的线路；普通网页浏览走便宜的线路”。确保关键业务不卡顿。
        *   **简化管理**：所有分支机构的网络状态都在一个统一的控制台上可视化管理，运维人员点点鼠标就能完成配置，无需跑到每个分公司。

---

### SD-WAN异地组网的核心优势

与传统方案相比，SD-WAN的优势非常突出：

| 特性         | 传统网络（如MPLS专线）           | SD-WAN异地组网                                |
| :----------- | :------------------------------- | :-------------------------------------------- |
| **成本**     | 极高（按带宽收费）               | 低（充分利用廉价互联网宽带）                  |
| **开通速度** | 慢（数周至数月）                 | 快（即插即用，几天甚至几小时）                |
| **灵活性**   | 差，变更困难                     | 极佳，随时增减节点，策略在线调整              |
| **性能**     | 稳定但带宽有限                   | 智能优化，动态提升关键应用体验                |
| **安全性**   | 网络层隔离，但自身无高级安全功能 | 通常集成防火墙、加密等安全功能，实现安全组网  |
| **云访问**   | 访问云应用需绕行总部，延迟高     | 可直接、安全地本地访问云服务（如阿里云、AWS） |

---

### 典型的应用场景

1.  **多分支机构互联**：这是最经典的场景，比如全国有几十家连锁店、银行网点，需要实时将销售数据、监控录像传回总部。
2.  **总部与数据中心互联**：将企业总部的网络和托管在机房的企业服务器安全地连接起来。
3.  **安全访问云服务**（SaaS/IaaS）：让员工能快速、安全地访问Office 365、Salesforce、阿里云等云应用，体验就像在本地一样。
4.  **远程办公**：员工在家或出差时，能通过客户端软件安全地接入公司内网，访问内部资源，实现“随时随地办公”。

### 总结

**SD-WAN异地组网的革命性在于，它不再依赖某种单一的、昂贵的物理线路，而是通过一个“软件定义”的大脑，智能地调度和管理各种廉价、易得的网络资源，最终实现甚至超越传统专线的效果。** 它完美地适应了现代企业移动化、云化、降本增效的需求。

## 为何VPN服务器需要两个网卡呢？

VPN服务器需要两个网卡是为了扮演一个“交通警察”的角色，将两个完全不同的网络世界安全地连接起来。

核心思想是：**内外网分离，各司其职。**

让我们把这两个网卡想象成两个大门：

1.  **第一张网卡（公网卡）：面向互联网的“前门”**
    *   **连接对象：** 整个互联网。
    *   **主要任务：** 监听并接收来自全球各地VPN客户端的连接请求。你的手机、笔记本电脑在咖啡馆或家里，就是通过这张网卡找到并连接到VPN服务器的。
    *   **IP地址：** 通常是一个公共IP地址（公网IP），就像你家的门牌号一样，在互联网上是唯一的、可被寻址的。

2.  **第二张网卡（内网卡）：连接内部网络的“后门”**
    *   **连接对象：** 公司或家庭的内网设备，比如内部文件服务器、打印机、监控系统等。
    *   **主要任务：** 作为内部网络的一员，将来自“前门”（已认证的VPN客户端）的数据流量转发到内部网络的具体设备上。
    *   **IP地址：** 通常是一个私有IP地址（如 `192.168.1.10`），只在内部网络中有意义，外部互联网无法直接访问。

---

### 为什么这种设计是必须的？一个生动的比喻

想象一下一个安全的办公大楼：

*   **公网卡（前门）：** 是大楼的保安亭。任何访客（VPN客户端）都必须先到这里登记身份、验证权限。
*   **内网卡（后门）：** 是保安亭后面那扇通往办公楼内部的门。只有通过保安检查的访客，才被允许通过这扇门进入办公室区域（内网）访问特定的部门（文件服务器）或人员。

**如果只有一张网卡会发生什么？**

这就像让保安亭和办公室共用一个房间。所有访客和内部员工都挤在同一个空间，毫无隔离可言。这会导致几个严重问题：

1.  **安全风险巨大：** 你无法有效隔离受信任的内网和不受信任的公网。一旦VPN服务软件出现漏洞，攻击者可能通过这张网卡直接攻击你的内网，因为没有物理或逻辑上的隔离。
2.  **路由混乱：** 服务器很难清晰地判断一个数据包是应该发给互联网上的VPN客户端，还是应该发给内网的打印机。这会造成网络通信异常不稳定。
3.  **性能瓶颈：** 所有流量（来自互联网的VPN流量和内部网络之间的流量）都挤在同一个网络接口上，容易造成拥堵，影响速度。

---

### 双网卡的具体工作流程（以远程员工访问公司文件为例）

1.  **连接请求：** 你在家打开VPN客户端，输入公司VPN服务器的公网IP地址。你的请求通过互联网发送到VPN服务器的**公网卡**。
2.  **身份验证：** VPN服务器（通过其软件，如OpenVPN、WireGuard）在公网卡上收到请求，验证你的用户名和密码/证书。
3.  **建立隧道：** 验证通过后，在你的电脑和VPN服务器之间建立一条加密的“隧道”。
4.  **访问内网资源：** 你现在想访问公司的文件服务器（IP是 `192.168.1.100`）。
    *   你的电脑将请求数据包通过加密隧道发送给VPN服务器的**公网卡**。
    *   VPN服务器解密数据包，看到目标是 `192.168.1.100`。
    *   服务器知道这个地址属于它的内部网络，于是通过**内网卡**将数据包转发给文件服务器。
5.  **返回数据：** 文件服务器的回复数据包发送到VPN服务器的**内网卡**，服务器再通过加密隧道从**公网卡**发回给你的电脑。

### 总结：双网卡的核心优势

*   **安全性：** 实现了网络隔离。不受信任的公共流量和受信任的内部流量被物理接口分开，即使公网侧被攻破，内网也多一层屏障。
*   **路由清晰：** 数据包路径明确。来自互联网的流量进“前门”，去内网的流量走“后门”，避免了路由冲突。
*   **性能优化：** 流量负载被分担到两个网络接口上，提高了整体吞吐量和稳定性。

因此，为VPN服务器配置两个网卡是一种标准、高效且安全的最佳实践。虽然在一些非常简单的家庭实验室环境中，人们可能会用单网卡配合复杂的路由规则来实现，但这会引入不必要的复杂性和安全风险，不推荐在生产环境中使用。

## 主路由和旁路由概念

### 核心比喻：公司里的两个“门卫”

想象一个公司的前台和安保系统：

*   **主路由** 就像公司的**总大门保安**。
    *   **核心职责**：所有员工和访客要进出公司，都必须经过这个总大门。他的主要工作是：
        1.  **检查出入权限**（网络连接权限，DHCP服务）。
        2.  **指引你去哪个部门**（数据包转发，网关功能）。
        3.  **确保大门通畅**（基础的网络连通，NAT转换）。
    *   **特点**：他的任务很重，要处理所有流量，但功能相对基础，主要保证“能上网”。

*   **旁路由** 就像公司里某个**特殊部门的专员**（比如“海外业务部”的专员）。
    *   **核心职责**：并不是所有人进出公司都要经过他。只有那些需要办理“特殊业务”（如访问国外网站、科学上网、去广告）的员工，才会被总大门保安指引到这个专员这里。
    *   **工作流程**：一个员工想去国外网站，总大门保安一看，说：“这个业务我办不了，你去找海外业务部的专员。” 员工找到专员，专员帮他处理完（比如“科学上网”）后，再通过总大门出去。
    *   **特点**：他不需要连接所有设备，只为有特定需求的设备服务。他的功能可以非常强大和专门化。

---

### 详细解释

#### 1. 主路由

*   **定义**：主路由是家庭或企业网络中的**核心设备**，直接连接互联网（通过光猫），是内网所有设备访问外网的**必经之路**。
*   **主要功能**：
    *   **DHCP 服务**：自动给连接上的设备（手机、电脑、电视等）分配IP地址、网关和DNS。
    *   **NAT 转换**：将内部网络的私有IP地址转换为一个公共IP地址去访问互联网，这是我们能上网的基础。
    *   **无线 Wi-Fi 发射**（如果是无线路由器）。
    *   **端口转发、防火墙**等基础网络管理功能。
*   **特点**：**稳定至上**。它的主要目标是保证网络不断线，所有设备能稳定上网。它的性能和处理能力直接决定了整个网络的基础体验。

#### 2. 旁路由

*   **定义**：旁路由是连接在主路由之下的**辅助性路由设备**。它不取代主路由的位置，内网设备**不一定非要**通过它上网。
*   **工作模式**：
    1.  **旁路由连接到主路由的LAN口**下，就像一台普通的电脑、手机一样，从主路由那里获取一个IP地址（如 192.168.1.2）。
    2.  **需要特殊服务的设备**（比如你的电脑），需要手动将其网络设置中的“默认网关”和“DNS服务器”地址填写为旁路由的IP地址（192.168.1.2）。
    3.  这样，当这台电脑要上网时，数据包就会先发给旁路由，旁路由处理完（如执行科学上网、去广告等规则）后，再转发给主路由（192.168.1.1），最后由主路由发送到互联网。
    4.  返回的数据包则走相反的路径：互联网 -> 主路由 -> 旁路由 -> 你的电脑。
*   **主要功能**（为什么需要它）：
    *   **科学上网/留学**：这是旁路由最常见的用途，安装OpenWrt、ShellClash等系统，实现代理功能。
    *   **广告拦截**：如安装AdGuard Home。
    *   **网络加速**、**DNS优化**、**内网穿透**、**搭建轻量级服务器**等高级功能。
*   **特点**：**功能专一，灵活性强**。
    *   **优点**：即使旁路由宕机或配置出错，你只需要将设备的网关改回主路由的IP，网络就能恢复正常，不影响主路由和其他设备的工作。实现了“功能”和“稳定性”的分离。
    *   **缺点**：需要手动为每个设备指定网关，或者通过主路由的DHCP设置全局下发（有一定风险，设置错误会导致全网上不了网）。

---

### 两种方案的对比

| 特性         | 主路由                               | 旁路由                                 |
| :----------- | :----------------------------------- | :------------------------------------- |
| **网络位置** | 核心，直接连接外网                   | 旁路，连接在主路由之下                 |
| **必要性**   | **必需**，没有它整个网络瘫痪         | **可选**，为了增强功能                 |
| **配置影响** | 配置出错可能导致**全网瘫痪**         | 配置出错只影响**使用它的设备**，风险低 |
| **性能要求** | 要求高，需要稳定转发所有流量         | 要求相对较低，只需处理部分设备的流量   |
| **主要功能** | 提供基础网络连接（DHCP, NAT, Wi-Fi） | 提供高级功能（留学，去广告，DNS等）    |

---

### 总结与选择建议

*   **普通家庭用户**：一个性能不错的**主路由**就完全够用了。追求的是简单和稳定。
*   **进阶用户/极客**：推荐 **“主路由 + 旁路由”** 的方案。
    *   购买一个性能强劲、稳定性极佳的硬路由（如华硕、网件等）作为**主路由**，只负责最基础的网络连接，保证全家网络基石稳固。
    *   用一个功耗低、可玩性高的设备（树莓派、旧笔记本、小型工控机等）刷写OpenWrt等系统作为**旁路由**，专门负责各种高级功能。这样即使你把旁路由“玩坏了”，家人的正常上网也不会受到影响。

简单来说，**主路由是保障“有网”，旁路由是追求“好网”**。这种架构在追求网络功能和稳定性的玩家中非常流行。

## OpenWrt镜像区别

>说明：在ESXi服务器上安装OpenWrt选择generic-ext4-combined-efi.img.gz镜像。

访问 https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/ 得到的镜像列表如下：

```
generic-ext4-combined-efi.img.gz
generic-ext4-combined.img.gz
generic-ext4-rootfs.img.gz
generic-kernel.bin
generic-squashfs-combined-efi.img.gz
generic-squashfs-combined.img.
generic-squashfs-rootfs.img.gz
rootfs.tar.gz
```

这些OpenWrt镜像文件的主要区别在于文件系统类型、分区组合方式以及用途。以下是详细解释：

---

### **1. 文件系统类型**
- **ext4**：
  - 传统读写文件系统，适合需要频繁写入的场景（如安装插件或保存配置）。
  - 镜像文件：
    - `generic-ext4-*.img.gz`
- **squashfs**：
  - 只读压缩文件系统，通过覆盖层（overlay）实现写入，系统更稳定（重启后恢复默认）。
  - 镜像文件：
    - `generic-squashfs-*.img.gz`

---

### **2. 分区组合方式**
- **combined**（完整系统镜像）：
  - 包含启动分区（kernel）和根文件系统（rootfs），可直接刷写到设备。
  - 文件示例：
    - `generic-ext4-combined.img.gz`
    - `generic-squashfs-combined.img.gz`
- **combined-efi**（支持UEFI启动）：
  - 在`combined`基础上增加EFI分区，适用于UEFI启动的设备（如x86虚拟机或新硬件）。
  - 文件示例：
    - `generic-ext4-combined-efi.img.gz`
    - `generic-squashfs-combined-efi.img.gz`
- **rootfs-only**（仅根文件系统）：
  - 仅包含根文件系统（无内核），需搭配内核文件（`generic-kernel.bin`）使用。
  - 文件示例：
    - `generic-ext4-rootfs.img.gz`
    - `generic-squashfs-rootfs.img.gz`

---

### **3. 其他文件**
- **generic-kernel.bin**：
  - 独立的内核文件，需与`rootfs`镜像配合使用（如手动分区或特殊设备）。
- **rootfs.tar.gz**：
  - 根文件系统的压缩包，用于自定义部署（如Docker容器或已有Linux系统上解压使用）。

---

### **如何选择？**
1. **普通设备刷写**：
   - 直接使用`combined`或`combined-efi`镜像（根据设备启动方式选择）。
   - 优先选`squashfs`（稳定性高），如需频繁写入选`ext4`。
2. **自定义分区/升级**：
   - 使用`rootfs.img.gz` + `generic-kernel.bin`。
3. **虚拟化或特殊硬件**：
   - UEFI启动选`combined-efi`，传统BIOS选`combined`。

---

### **总结表**
| 文件名                                 | 文件系统 | 分区组合        | 适用场景               |
| -------------------------------------- | -------- | --------------- | ---------------------- |
| `generic-ext4-combined-efi.img.gz`     | ext4     | 内核+rootfs+EFI | UEFI设备，需读写       |
| `generic-ext4-combined.img.gz`         | ext4     | 内核+rootfs     | 传统设备，需读写       |
| `generic-ext4-rootfs.img.gz`           | ext4     | 仅rootfs        | 手动分区，需读写       |
| `generic-squashfs-combined-efi.img.gz` | squashfs | 内核+rootfs+EFI | UEFI设备，稳定只读     |
| `generic-squashfs-combined.img.gz`     | squashfs | 内核+rootfs     | 传统设备，稳定只读     |
| `generic-squashfs-rootfs.img.gz`       | squashfs | 仅rootfs        | 手动分区，稳定只读     |
| `generic-kernel.bin`                   | -        | 仅内核          | 需搭配rootfs使用       |
| `rootfs.tar.gz`                        | -        | 压缩包          | 自定义部署（非刷写用） |

根据设备类型和需求选择对应镜像即可。

## 路由器DMZ概念

### 一句话概括

**DMZ（Demilitarized Zone，非军事区）是路由器中的一个设置，你可以将局域网内的某一台设备（比如一台电脑或游戏主机）完全暴露给互联网，相当于把它“踢出”路由器的防火墙保护之外。**

---

### 详细解释

为了理解DMZ，我们得先明白家庭或办公室网络通常是怎么工作的。

#### 1. 正常情况（没有DMZ）

*   你的路由器就像一个**保安**，而你的所有设备（电脑、手机、游戏机等）都在一个**安全的内部网络（局域网）** 里。
*   这个保安站在大门口（互联网入口），对所有从外面想进来的数据包进行严格盘查。除非是内部设备主动请求的数据（比如你打开网页），或者是你在路由器里设置了**端口转发**（相当于给保安一份“访客白名单”，告诉他特定的人可以进），否则外部数据一律拦在门外。
*   这层保护就是**防火墙**，它非常关键，能有效防止黑客攻击你的内部设备。

#### 2. 开启DMZ后

*   当你把局域网中的**某台设备**（例如IP地址为 192.168.1.100 的电脑）设置为DMZ主机后，路由器这个“保安”会对这台设备采取特殊对待：
    *   **所有从互联网发来的、目标不明确的数据包，全部都会无条件地转发给这台DMZ主机。**
*   换句话说，这台设备就像被放在了路由器防火墙外面的一个“前厅”里，互联网上的任何“人”都可以直接敲它的门。

**一个简单的比喻：**
*   **正常网络：** 你的家（局域网）有一个大门（路由器防火墙），所有访客必须经过大门确认才能进入。
*   **端口转发：** 你告诉保安（路由器）：“如果有个送披萨的（访问特定端口，如80端口的网页服务），就让他进来送到厨房（某台设备的特定服务）。”
*   **DMZ：** 你直接把厨房（DMZ主机）搬到了大门外面，没有任何阻拦，任何人都可以进出这个厨房。

---

### DMZ的主要用途

1.  **主机类游戏或特殊联机应用：** 一些游戏或软件需要复杂的网络连接，设置端口转发非常麻烦。直接将该游戏主机（如PS5、Xbox）设为DMZ是最简单粗暴的解决方案，可以最大可能解决“NAT类型严格”等问题。
2.  **运行需要被公开访问的服务：** 如果你在某台电脑上架设了一个对公网开放的网站、服务器等，但又没有公网IP（IP地址是运营商分配的大内网地址），DMZ可以方便地让外部用户访问到你的服务。

---

### DMZ的巨大风险（非常重要！）

**将设备设为DMZ主机是极其危险的行为！** 因为它完全移除了该设备的防火墙保护。

*   **黑客的活靶子：** 这台设备将直接面对互联网上所有的恶意扫描和攻击。如果这台设备本身存在安全漏洞（比如操作系统没有更新，软件有漏洞），黑客可以轻而易举地入侵它。
*   **沦为“跳板”：** 一旦这台设备被黑客控制，它可能会成为攻击你内网其他设备的“跳板”，导致整个家庭或公司网络陷入危险。

**因此，除非你非常清楚自己在做什么，并且DMZ主机上的系统非常安全（例如是专门加固过的系统），否则强烈不建议普通用户使用此功能。**

---

### DMZ 与 端口转发 的区别

这是最关键的一点：

| 特性         | **端口转发**                                              | **DMZ**                                                    |
| :----------- | :-------------------------------------------------------- | :--------------------------------------------------------- |
| **安全性**   | **高**                                                    | **极低**                                                   |
| **精确度**   | **精确**。只开放你指定的几个端口。                        | **粗暴**。开放**所有**端口。                               |
| **适用场景** | 需要开放特定服务（如远程桌面、FTP服务器、特定游戏端口）。 | 需要开放大量不确定端口，或懒得设置复杂端口转发的特殊情况。 |
| **比喻**     | 只打开房子的一扇小窗户传递东西。                          | 把整个房间的墙都拆了。                                     |

### 总结与建议

*   **DMZ是什么？** 是一个将内网设备完全暴露给公网的路由器功能。
*   **什么时候用？** 仅在解决特定网络问题（如游戏联机）且其他方法无效时，**临时地** 对游戏机等非关键设备使用。
*   **安全第一：** **绝对不要**将你存放重要资料、进行网上银行交易的日常使用的电脑设为DMZ主机。
*   **优先选择：** 在绝大多数情况下，**端口转发** 是比DMZ更安全、更专业的解决方案。请优先尝试使用端口转发来解决问题。

## 为什么路由表记录与网卡对应

路由表记录需要与网卡对应，是因为**数据包必须通过一个实实在在的物理（或虚拟）接口才能发送出去**。

可以把整个过程想象成寄送快递：

*   **你的电脑** = 一个物流分发中心
*   **数据包** = 需要寄送的包裹
*   **IP地址** = 包裹上的收件地址
*   **路由表** = 物流中心里的“路线规划手册”
*   **网卡** = 物流中心通往不同外部道路的**大门**（比如前门通往市区公路，后门通往高速公路，侧门通往一条小巷）。

现在我们来分解为什么“路线”必须对应“门”。

### 1. 根本原因：数据包的出口

路由表的核心作用是回答一个问题：“当我要发送一个数据包到目标IP X.X.X.X时，我应该把这个包从哪个**接口（网卡）** 扔出去，以及下一跳的地址是什么？”

如果没有指定网卡，操作系统就不知道应该让哪个硬件设备来执行发送操作。是让连接Wi-Fi的无线网卡发，还是让连接网线的有线网卡发？这两个网卡连接的是完全不同的网络路径。

### 2. 具体原因和场景分析

让我们看几个典型的路由表记录例子（以Linux系统为例，Windows/Mac逻辑类似）：

```bash
# 假设你的电脑有两张网卡：
# - eth0: 有线网卡，IP是 192.168.1.100，连接公司内网
# - wlan0: 无线网卡，IP是 10.0.0.5，连接家庭Wi-Fi

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
0.0.0.0         10.0.0.1        0.0.0.0         UG    600    0        0 wlan0
192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     600    0        0 wlan0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eth0
```

**场景一：访问互联网（例如 `8.8.8.8`）**

1.  电脑要访问 `8.8.8.8`。
2.  查询路由表，这个IP不匹配 `192.168.1.0/24`，也不匹配 `10.0.0.0/24`。
3.  它最终匹配到了第一条**默认路由**：`0.0.0.0/0`（意思是“所有其他地址”）。
4.  这条记录明确指出：**通过接口 `eth0`** 发送，并交给网关 `192.168.1.1`。
5.  操作系统于是将数据包交给 `eth0` 网卡驱动程序，由它通过网线将数据包发送出去。

*如果这里没有指定 `Iface`（接口），操作系统就懵了，不知道该用哪个门。*

**场景二：访问同一局域网内的另一台电脑（例如 `192.168.1.50`）**

1.  电脑要访问 `192.168.1.50`。
2.  查询路由表，它匹配到了第三条记录：`192.168.1.0/24`。
3.  这条记录显示：网关是 `0.0.0.0`（表示目标就在同一局域网，无需网关），并且**通过接口 `eth0`** 直接发送。
4.  操作系统会通过 `eth0` 网卡直接在本地网络里“喊话”（ARP广播），寻找 `192.168.1.50` 的MAC地址，然后直接通信。

*这里明确指出了访问 `192.168.1.x` 这个网段的设备，必须走 `eth0` 这个门，走 `wlan0` 是绝对到不了的，因为那是两个不同的网络。*

**场景三：策略路由（多网卡同时上网）**

这是最体现对应关系重要性的场景。你的电脑同时连着有线网络（公司内网，可访问内部服务器）和无线Wi-Fi（用于上外网）。

*   路由表通过 **`Iface`** 字段实现了流量的分离：
    *   所有去往公司服务器（如 `10.10.x.x`）的流量，由指向 `eth0` 的路由记录管理。
    *   所有去往互联网的流量，因为有线路由的**Metric（度量值，100）** 比无线（600）更优，所以会优先走 `eth0`。如果 `eth0` 断开，系统会自动切换到 `wlan0` 的默认路由，实现故障转移。

如果没有与网卡的对应关系，就无法实现这种精细的、基于源IP或目标IP的流量控制。

### 总结

路由表记录与网卡对应是**必然的**，因为：

1.  **物理出口**：网卡是数据包离开主机的唯一物理（或虚拟）通道。
2.  **路径选择**：不同的网卡通常连接到不同的逻辑或物理网络，路由表的核心职责就是为不同目标网络选择正确的出口。
3.  **地址绑定**：在发送数据包时，网卡需要以其自身的IP地址作为源IP。操作系统需要知道从哪个口出去，才能正确封装数据包的源IP地址。
4.  **策略管理**：在多网卡环境下，这种对应关系是实现负载均衡、故障转移和访问控制的基础。

所以，**路由表本质上就是一个“目标网络 -> 出口网卡 + 下一跳网关”的映射表**，与网卡的对应关系是其设计的核心和基础。

## 怎么判断一个网卡是虚拟还是物理的呢？

判断网卡是虚拟还是物理的，有多种方法，可以从操作系统内部查看，也可以从外部硬件推断。

下面我为你整理了从简单到专业的一系列方法，你可以根据你所处的环境和拥有的权限来选择。

### 总结：核心判断依据

*   **物理网卡**：与真实的、看得见摸得着的硬件设备对应。通常有唯一的MAC地址和物理端口（如RJ-45网线接口）。
*   **虚拟网卡**：由操作系统、虚拟化软件（如VMware, Hyper-V, VirtualBox）或网络功能虚拟化（NFV）创建的逻辑网络接口。它没有独立的物理硬件，用于虚拟机内部通信、软件路由、VPN隧道等。

---

### 方法一：在操作系统中通过命令或界面查看（最常用）

这是最直接的方法，无需接触硬件。

#### 1. 在 Windows 系统中

**a) 使用设备管理器**
1.  右键点击“此电脑” -> “管理” -> “设备管理器”。
2.  展开“网络适配器”。
3.  **观察名称**：
    *   **物理网卡**：通常直接显示品牌和型号，如 `Intel(R) Ethernet Connection (7) I219-V`， `Realtek PCIe GbE Family Controller`。
    *   **虚拟网卡**：名称通常包含虚拟化软件或特定功能的关键字：
        *   `VMware Virtual Ethernet Adapter` （VMware相关）
        *   `VirtualBox Host-Only Ethernet Adapter` （VirtualBox相关）
        *   `Hyper-V Virtual Ethernet Adapter` （Hyper-V相关）
        *   `WAN Miniport` （Windows自带的PPPoE、VPN等虚拟适配器）
        *   `TAP-Windows Adapter V9` （OpenVPN等VPN软件使用）

**b) 使用命令行（PowerShell）**
1.  以管理员身份打开 PowerShell。
2.  输入命令：`Get-NetAdapter`
3.  查看返回列表中的 `Name` 和 `InterfaceDescription` 列。判断方法与设备管理器类似，虚拟网卡的描述会包含 `Hyper-V`， `VMware`， `TAP` 等字样。

#### 2. 在 Linux 系统中

Linux下的命名规则更为清晰。

**a) 使用 `ip link` 命令**
1.  打开终端。
2.  输入命令：`ip link`
3.  观察网卡名称（第一列）：
    *   **物理网卡**：传统命名如 `eth0`， `ens33`， `enp0s3`。新的命名规则通常与物理位置相关（如 `ens33`）。
    *   **虚拟网卡**：名称有很强的特征：
        *   `virbr0`， `vnet0` （Libvirt/KVM虚拟化）
        *   `docker0`， `vethxxxxx` （Docker容器虚拟网络）
        *   `wlp0s1` （这是**物理**无线网卡，`wl`代表wireless LAN，不要混淆）
        *   `lo` （环回接口，特殊的虚拟网卡）
        *   `tun0`， `tap0` （VPN隧道接口）

**b) 使用 `lshw` 命令（更详细）**
1.  输入命令：`sudo lshw -class network`
2.  这个命令会显示非常详细的硬件信息。查看每个网卡描述的 `product` 和 `logical name` 字段。
    *   **物理网卡**：`product` 字段会显示具体的硬件型号，如 `Ethernet Connection I217-LM`。
    *   **虚拟网卡**：`product` 字段可能是空的，或者是 `Virtual Ethernet adapter`， `Virtual Ethernet pair` 等。`description` 字段也可能直接说明是虚拟接口。

#### 3. 在 macOS 系统中

1.  打开“系统报告”（关于本机 -> 系统报告）。
2.  在侧边栏选择“网络”。
3.  在右侧列表中，查看每个接口的“类型”或“名称”：
    *   **物理网卡**：如 `Ethernet`， `Wi-Fi`。
    *   **虚拟网卡**：如 `utun0`， `utun1` （VPN或系统服务使用）， `bridge0`。

---

### 方法二：通过MAC地址（OUI）判断

每个网卡的MAC地址前3个字节是**组织唯一标识符（OUI）**，代表制造商。可以查询OUI来判断。

1.  **找到MAC地址**：使用 `ipconfig /all` (Windows) 或 `ip link` (Linux) 找到目标网卡的MAC地址。
2.  **查询OUI**：在网站上（如 https://www.macvendors.com/）输入MAC地址查询。
    *   **物理网卡**：OUI通常对应一个知名的硬件制造商，如 `Intel` (00-15-5D)， `Realtek` (00-13-3A) 等。
    *   **虚拟网卡**：OUI可能属于虚拟化软件厂商：
        *   **VMware**： `00-0C-29`， `00-50-56`
        *   **Microsoft (Hyper-V)**： `00-15-5D` （这个OUI也属于Intel，但微软Hyper-V默认使用这个范围的MAC）
        *   **Parallels (macOS虚拟机)**： `00-1C-42`
        *   **Palo Alto Networks (GlobalProtect VPN)**： 可能使用特定的OUI。

**注意**：这种方法不是100%准确，因为管理员可以手动修改MAC地址（MAC spoofing），但绝大多数情况下是可靠的。

---

### 方法三：物理检查（最终确认）

如果上述方法仍有疑问，或者你有权限接触硬件，这是最可靠的方法。

*   **查看服务器或电脑背部**：是否有对应的RJ-45网络接口指示灯在闪烁。一个物理网卡必定对应一个物理端口。
*   **进入BIOS/UEFI或RAID卡配置界面**：查看硬件设备列表，物理网卡会在这里显示。
*   **对于服务器**：查看主板集成（LOM）或插在PCIe插槽上的网卡。虚拟网卡（如VMXNET3）在宿主机的硬件层面是看不到的。

### 快速判断流程图

```mermaid
graph TD
    A[开始判断网卡类型] --> B{查看网卡名称/描述};
    B -->|包含 VMware/VirtualBox/Hyper-V/TAP 等词| C[大概率是虚拟网卡];
    B -->|是 eth, eno, ens, enp 等| D[大概率是物理网卡];
    C --> E{仍有疑问？};
    D --> E;
    E --> F[查询MAC地址(OUI)];
    F -->|OUI属于虚拟化软件商| C;
    F -->|OUI属于硬件制造商| D;
    E --> G[终极方法：物理检查];
    G -->|有对应物理端口和指示灯| H[确认物理网卡];
    G -->|无对应物理硬件| I[确认虚拟网卡];
```

## ZeroTier总结

如下：

- 不好：尝试查找类似traceroute的方案判断ZeroTier流量经过哪些服务器到达终点，但没有找到这样的方案。
- 不好：ping丢包严重时没有比较好的debug支持判断丢包问题在哪里。

## ZeroTier信息

网址：https://my.zerotier.com/（旧版本控制台，新版本控制台不能添加自定义静态路由），使用Github帐号登录。

## ZeroTier Planet和Moon服务器概念

简单来说，**Planet（行星）和 Moon（月球）是为了解决同一个问题而生的两种不同层级的服务器：在无法直接点对点（P2P）连接时，为你的设备提供可靠的中转（Relay）服务。**

让我们来详细分解一下。

### 核心问题：为什么需要服务器？

ZeroTier 的目标是让分布在全球的设备像在同一个局域网里一样通信，它首先会尝试建立直接的 P2P 连接。但现实中，很多网络环境有严格限制（如公司防火墙、运营商NAT），导致 P2P 直连失败。

这时候，就需要一个双方都能访问的“中间人”来转发数据，这个“中间人”就是服务器。

---

### 1. Planet（行星）服务器 - ZeroTier 的官方“根服务器”

*   **身份：** 由 ZeroTier 官方搭建和维护的全球服务器集群。
*   **作用：**
    1.  **身份认证与授权：** 当你加入一个网络时，你的设备会向 Planet 服务器“报到”，Planet 服务器会验证你是否有权限加入该网络，并下发网络配置和成员列表。
    2.  **网络控制器：** 管理所有虚拟网络的成员、IP地址分配（DHCP）、访问规则（Rules）等。你通过 ZeroTier Central 网页进行的操作，最终都是由 Planet 服务器下发给各个节点的。
    3.  **根服务器/星球中继：** 当 P2P 连接失败，且没有自定义的 Moon 服务器时，设备会通过 Planet 服务器进行流量中转。
*   **特点：**
    *   **免费使用：** 对于普通用户，Planet 服务是免费的（有100个设备限制）。
    *   **全球分布：** ZeroTier 在全球多个地点部署了 Planet 节点，以保证延迟和可靠性。
    *   **公共基础设施：** 可以把它想象成互联网的 DNS 根服务器，是 ZeroTier 全球网络的基石。

**局限性：** 由于是公共服务器，全球用户都在使用，在某些网络环境下（尤其是在中国大陆），访问海外的 Planet 服务器可能不稳定、延迟高甚至被干扰，导致整个 ZeroTier 网络体验不佳。

---

### 2. Moon（月球）服务器 - 你的私有“专属中转站”

Moon 就是为了解决 Planet 的局限性而生的。

*   **身份：** **由用户自己搭建**的辅助服务器。它就像是围绕着你私有网络的一颗“月球”，而 ZeroTier 的官方 Planet 则是“地球”。
*   **作用：**
    1.  **降低延迟，提高稳定性：** 如果你在国内有一台云服务器（如阿里云、腾讯云），可以将其配置为 Moon。那么，你的所有国内设备在连接时，会优先通过这个国内的 Moon 服务器进行通信和中转，速度更快、更稳定。
    2.  **提升连接成功率：** 在某些特殊网络环境下，设备可能很难连接上远在海外的 Planet，但可以轻松连接到你本地的 Moon，从而成功接入 ZeroTier 网络。
    3.  **增强私密性（一定程度上）：** 你的大部分协调和中转流量不再必须经过 ZeroTier 官方的 Planet 服务器。
*   **特点：**
    *   **自行搭建：** 需要用户自己有一台具有公网 IP、网络稳定的服务器（VPS）来搭建。
    *   **免费软件：** 搭建 Moon 的功能是 ZeroTier 软件自带的，无需额外付费。
    *   **辅助角色：** Moon 不替代 Planet。设备仍然需要 Planet 来进行最初的认证和授权，但一旦“认识”了 Moon，后续的通信会优先选择 Moon。

---

### 一个生动的比喻

把 ZeroTier 网络比作一个跨国公司的电话系统：

*   **Planet 服务器** 就像是公司的 **总机**。每个员工（设备）入职时都要在总机登记。当美国分部的 Alice 想直接呼叫中国分部的 Bob 时，总机帮他们建立直接连接（P2P）。
*   如果 Alice 和 Bob 之间的国际长途线路不好（防火墙/NAT），直接通话失败。
*   这时，总机说：“别急，我们在中国上海有一个**区域办事处（Moon）**，信号很好。Alice，你把电话打到上海办事处，再由办事处转给 Bob。”
*   这个“上海办事处”就是你自建的 **Moon 服务器**，它专门为你公司的中国区员工提供优质的中转服务。

### 总结对比表

| 特性         | Planet（行星）                   | Moon（月球）                 |
| :----------- | :------------------------------- | :--------------------------- |
| **运营方**   | ZeroTier 官方                    | 用户自己                     |
| **成本**     | 免费（有限额）                   | 需要自备服务器（VPS费用）    |
| **主要作用** | 全球根服务器、身份认证、网络控制 | 区域性中转、加速、提升稳定性 |
| **依赖性**   | 必须存在，是网络的基础           | 可选配件，用于优化体验       |
| **好比**     | 互联网的根DNS服务器              | 你自己搭建的私有CDN节点      |

### 给你的建议

*   **对于大多数普通用户**：如果只是连接少数几台设备，且网络环境不错，直接使用 ZeroTier 官方的 Planet 服务就足够了。
*   **如果你在中国大陆**，并且遇到以下情况，**强烈建议自建一个 Moon**：
    *   设备之间无法直连，且通过 Planet 中转速度很慢、延迟很高。
    *   有时连不上 ZeroTier 网络。
    *   有重要的设备需要稳定、低延迟的组网需求。

## ZeroTier配置Moon服务器

在阿里云创建Ubuntu20.04，防火墙开放UDP协议20378/65000端口。

安装ZeroTier

```sh
curl -s https://install.zerotier.com | sudo bash
```

加入网络

```sh
sudo zerotier-cli join <你的16位网络ID>
```

登录ZeroTier Central授权该节点接入。

把默认端口9993修改为55000

- 创建文件/var/ib/zerotier-one/local.conf

  ```json
  {
    "settings": {
      "primaryPort": 55000
    }
  }
  ```

生成Moon配置文件

```sh
# 切换到 ZeroTier 目录
cd /var/lib/zerotier-one

# 生成月球配置，‘000000’是占位符，会自动被你的节点ID替换
sudo zerotier-idtool initmoon identity.public > moon.json
```

 编辑moon.json配置文件补充公网IP地址

```sh
# 将 "stableEndpoints"修改为你的服务器的公网 IP 和 ZeroTier 端口
# 配置文件中其它信息不需要修改
"stableEndpoints": [ "1.2.3.4/55000" ]
```

编译并签名Moon配置

```sh
# 使用以下命令将 moon.json编译成最终的二进制配置文件 000000xxx.moon
sudo zerotier-idtool genmoon moon.json
```

将Moon配置文件移动到正确位置并重启服务

```sh
# 切换到 ZeroTier 目录
cd /var/lib/zerotier-one

# 创建 moons.d 目录（如果不存在）
sudo mkdir -p moons.d

# 将生成的 .moon 文件移动到 moons.d 目录
sudo mv 000000xxx.moon moons.d/

# 重启 ZeroTier 服务
sudo systemctl restart zerotier-one
```

验证Moon是否运行成功

```sh
sudo zerotier-cli listmoons
```

客户端配置指定使用Moon服务器通讯（iStoreOS中需要提供ZEROTIER_HOME=/etc/config/zero环境变量，否则会报告`zerotier-cli: missing port and zerotier-one.port not found in /var/lib/zerotier-one`错误，例如：ZEROTIER_HOME=/etc/config/zero zerotier-cli xxx）

```sh
# 在 Moon 服务器上运行 zerotier-cli listmoons看到的那个 ID，就是你的 Moon ID
zerotier-cli listmoons

# 在你的电脑上，执行加入命令
# 需要管理员权限
sudo zerotier-cli orbit <Moon-ID> <Moon-ID>

# 在你的电脑上验证客户端是否成功连接至 Moon
zerotier-cli listpeers
# 在输出的对等节点列表中，找到你的 Moon ID 那一行。如果连接成功，你会看到它后面有 MOON标识，并且有延迟信息，例如：
200 listpeers <Moon-ID> <Moon-IP>/9993;1234;1234 105 - MOON
```

## ZeroTier客户端macOS安装

步骤如下：

1. 切换网络：macOS系统连接到手机热点，否则如果连接到公司网络不能更加真实地模拟异地办公。

2. 下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MacOS PKG Installer，双击Installer根据提示安装即可。

3. 加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID（咨询网络管理员获取，目前测试使用：b6079f73c6ec26a7）。 

4. 查看网络状态并授权：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络（咨询网络管理员授权）。

5. 再次查看网络为OK状态：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: OK`功能。

6. 设置客户端流量走私有服务器：打开终端并执行下面命令

   ```sh
   # 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
   $ sudo zerotier-cli orbit 32c336b0cf 32c336b0cf
   200 orbit OK
   
   # 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
   $ sudo zerotier-cli listpeers
   200 listpeers <ztaddr> <path> <latency> <version> <role>
   ...
   200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
   ...
   ```

7. 测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

   ```sh
   $ ping 192.168.1.1                             
   PING 192.168.1.1 (192.168.1.1): 56 data bytes
   64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
   64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
   64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
   64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
   64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
   64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
   64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
   ```


## ZeroTier客户端Windows11安装

步骤如下：

1. 切换网络：Windows11系统连接到手机热点，否则如果连接到公司网络不能更加真实地模拟异地办公。

2. 下载并安装客户端：访问 https://www.zerotier.com/download/ 下载MSI Installer(x86/x64)，双击Installer根据提示安装即可。

3. 加入网络：运行ZeroTier客户端后，点击`托盘图标`>`Join New Network...`功能，在弹出框中填写网络ID（咨询网络管理员获取，目前测试使用：b6079f73c6ec26a7）。 

4. 查看网络状态并授权：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: ACCESS_DENIED`功能，说明客户端需要网络管理员授权客户端接入网络（咨询网络管理员授权）。

5. 再次查看网络为OK状态：打开`托盘图标`>`b6079f73c6ec26a7 <网络名称>`>`Status: OK`功能。

6. 设置客户端流量走私有服务器：打开终端并执行下面命令

   ```sh
   # 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
   $ sudo zerotier-cli orbit 32c336b0cf 32c336b0cf
   200 orbit OK
   
   # 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
   $ sudo zerotier-cli listpeers
   200 listpeers <ztaddr> <path> <latency> <version> <role>
   ...
   200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
   ...
   ```

7. 测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

   ```sh
   $ ping 192.168.1.1                             
   PING 192.168.1.1 (192.168.1.1): 56 data bytes
   64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
   64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
   64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
   64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
   64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
   64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
   64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
   ```


## ZeroTier客户端Ubuntu20.04安装

安装ZeroTier客户端

```sh
curl -s https://install.zerotier.com | sudo bash

# 查看ZeroTier服务状态为running状态
sudo systemctl status zerotier-one
```

加入网络

```sh
sudo zerotier-cli join b6079f73c6ec26a7
```

查看当前网络状态为ACCESS_DENIED

```sh
$ sudo zerotier-cli listnetworks
200 listnetworks <nwid> <name> <mac> <status> <type> <dev> <ZT assigned ips>
200 listnetworks b6079f73c6ec26a7  a6:95:37:0d:bd:b0 ACCESS_DENIED PRIVATE ztyxaxgvlb -
```

登录ZeroTier控制台授权客户端接入。

再次查看网络状态变为OK

```sh
$ sudo zerotier-cli listnetworks
200 listnetworks <nwid> <name> <mac> <status> <type> <dev> <ZT assigned ips>
200 listnetworks b6079f73c6ec26a7 dexterleslie's 1st network a6:95:37:0d:bd:b0 OK PRIVATE ztyxaxgvlb 10.244.97.154/16
```

设置客户端流量走私有服务器：打开终端并执行下面命令

```sh
# 私有服务器的节点ID需要咨询网络管理员是哪一个，不能随便指定，目前测试使用：32c336b0cf
$ sudo zerotier-cli orbit 32c336b0cf 32c336b0cf
200 orbit OK

# 使用命令显示200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON表示私有服务器节点设置成功
$ sudo zerotier-cli listpeers
200 listpeers <ztaddr> <path> <latency> <version> <role>
...
200 listpeers 32c336b0cf x.x.x.x/55000;4180;4150 28 1.16.0 MOON
...
```

测试内网连通性：ping公司网关（如果ping不同可能需要等待几分钟等待网络信息同步完成后再ping）

```sh
$ ping 192.168.1.1                             
PING 192.168.1.1 (192.168.1.1): 56 data bytes
64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=8.691 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=9.299 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=7.422 ms
64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=10.673 ms
64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=8.617 ms
64 bytes from 192.168.1.1: icmp_seq=5 ttl=63 time=7.087 ms
64 bytes from 192.168.1.1: icmp_seq=6 ttl=63 time=8.515 ms
```

