worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 65535;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # 关闭gzip以便更清晰地对比HTTP/2的优势
    gzip off;
    
    server {
        # 监听配置：指定服务器监听的端口和协议
        # 8443：监听端口号，使用非标准HTTPS端口（标准HTTPS端口是443）
        # 使用8443端口可以避免与系统上其他服务冲突，适合开发和测试环境
        # ssl：启用SSL/TLS加密，要求所有连接必须使用HTTPS协议
        # 启用ssl后，必须配置ssl_certificate和ssl_certificate_key指令提供证书和私钥
        # http2：启用HTTP/2协议支持，允许客户端使用HTTP/2进行通信
        # HTTP/2相比HTTP/1.1的优势：多路复用、服务器推送、头部压缩、二进制分帧等，提升性能和效率
        # 注意：HTTP/2需要基于TLS（HTTPS），不能用于纯HTTP连接
        listen 8443 ssl http2;
        server_name localhost;
        
        # SSL证书配置：指定服务器用于HTTPS连接的SSL/TLS证书和私钥文件路径
        # ssl_certificate：SSL证书文件路径，包含服务器的公钥和证书信息
        # 证书文件通常包含：服务器域名、公钥、证书颁发机构(CA)签名、有效期等信息
        # 客户端通过证书验证服务器身份，确保证书由受信任的CA签发且未过期
        ssl_certificate /usr/local/openresty/nginx/conf/cert.crt;
        # ssl_certificate_key：SSL私钥文件路径，用于解密客户端发送的加密数据
        # 私钥必须与证书文件中的公钥配对，且必须严格保密，只有服务器拥有
        # 私钥泄露会导致安全风险，攻击者可能冒充服务器进行中间人攻击
        # 建议设置严格的文件权限（如 600），确保只有nginx进程可以读取
        ssl_certificate_key /usr/local/openresty/nginx/conf/key.pem;
        
        # SSL配置
        # 协议控制 ：指定服务器仅支持 TLS 1.2 和 TLS 1.3 这两个安全协议版本
        # 安全性保障 ：禁用了不安全的旧版本协议（如 SSLv2、SSLv3、TLSv1.0、TLSv1.1），这些旧版本存在已知安全漏洞
        ssl_protocols TLSv1.2 TLSv1.3;
        # 加密套件配置：控制服务器允许使用的SSL/TLS加密算法组合
        # HIGH：仅使用高强度加密套件（通常指128位或更高强度的对称加密算法，如 AES-128、AES-256 等）
        # !aNULL：排除匿名NULL加密套件（anonymous NULL cipher suites），这些套件不提供身份验证，存在安全风险
        # !MD5：排除使用MD5哈希算法的加密套件，MD5已被证明存在碰撞漏洞，不再安全
        # 此配置确保只使用现代、安全的加密算法，提供强加密和身份验证保护
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        root /usr/local/openresty/nginx/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }
        
        # 添加CORS头
        add_header Access-Control-Allow-Origin * always;
    }
    
    # HTTP重定向到HTTPS
    server {
        listen 8081;
        server_name localhost;
        return 301 https://localhost:8443$request_uri;
    }
}

