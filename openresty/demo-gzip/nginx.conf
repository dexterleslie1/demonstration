worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # Gzip 压缩配置
    gzip on;                                    # 启用 gzip 压缩
    # 启用 Vary: Accept-Encoding 响应头
    # 作用：告知缓存服务器（如 CDN、代理服务器）该响应内容会根据客户端的 Accept-Encoding 请求头而变化
    # 重要性：确保不支持 gzip 的客户端（如某些旧浏览器）能够正确获取未压缩的内容
    # 缓存影响：缓存服务器会根据 Accept-Encoding 的值分别缓存压缩和未压缩的版本
    # 例如：支持 gzip 的客户端会收到压缩内容，不支持 gzip 的客户端会收到原始内容
    gzip_vary on;
    # 配置对代理请求的 gzip 压缩行为
    # 作用：控制当请求来自代理服务器（如反向代理、负载均衡器、CDN）时是否启用压缩
    # 值说明：any 表示对所有代理请求都启用压缩，无论响应头如何
    # 其他可选值：
    #   - off: 不对代理请求启用压缩
    #   - expired/no-cache/no-store/private: 根据响应头的 Cache-Control 或 Expires 决定
    #   - no_last_modified/no_etag: 根据响应头是否包含 Last-Modified 或 ETag 决定
    #   - auth: 仅对包含 Authorization 请求头的代理请求启用压缩
    # 使用场景：当 Nginx 作为后端服务器，前面有代理层时，确保代理请求也能获得压缩内容
    gzip_proxied any;
    gzip_comp_level 6;                          # 压缩级别 (1-9，6 是平衡性能和压缩率)
    # 指定启用 gzip 压缩的 MIME 类型
    # 作用：只对指定的内容类型启用压缩，避免对已经压缩或压缩效果不佳的文件类型进行压缩
    # 原则：只压缩文本类文件，因为文本文件压缩率高（通常可压缩 60-80%）
    # 不压缩的类型：
    #   - 图片（jpg/png/gif/webp）：已经是压缩格式，再次压缩效果差且浪费 CPU
    #   - 视频/音频（mp4/mp3）：已经是压缩格式
    #   - 字体文件（woff/woff2）：已经是压缩格式
    #   - PDF：通常已经压缩
    gzip_types
        text/plain                              # 纯文本文件
        text/css                                # CSS 样式表文件
        text/xml                                # XML 文件
        text/javascript                         # JavaScript 文件（旧式 MIME 类型）
        application/json                        # JSON 数据文件
        application/javascript                  # JavaScript 文件（标准 MIME 类型）
        application/xml+rss                     # RSS Feed XML 文件
        application/atom+xml                    # Atom Feed XML 文件
        image/svg+xml;                          # SVG 矢量图（XML 格式，文本类，压缩效果好）
    # 设置启用 gzip 压缩的最小响应长度
    # 作用：只对大于指定字节数的响应启用压缩，避免压缩过小的文件
    # 原因：小文件压缩后可能反而变大（压缩算法开销 + 压缩头信息），且压缩小文件消耗 CPU 资源
    # 值说明：1000 字节（约 1KB）是一个平衡点
    #   - 小于 1000 字节：压缩收益低，可能得不偿失
    #   - 大于 1000 字节：压缩收益明显，值得消耗 CPU 资源
    # 默认值：20（字节），通常建议设置为 1000 或更高
    # 性能考虑：避免对大量小文件（如 API 响应、图标文件）进行不必要的压缩处理
    gzip_min_length 1000;
    # 禁用特定 User-Agent 的 gzip 压缩
    # 作用：对匹配指定 User-Agent 字符串的客户端禁用 gzip 压缩
    # IE6 问题：Internet Explorer 6 对 gzip 压缩的支持存在严重缺陷
    #   1. 无法正确处理某些 gzip 压缩的响应，可能导致页面显示错误或崩溃
    #   2. 对 Vary 响应头的处理有问题，可能导致缓存混乱
    #   3. 在某些情况下会错误地解压已经解压过的内容
    # 值说明："msie6" 匹配 User-Agent 中包含 "MSIE 6" 的请求
    #   也可以使用正则表达式，如 "MSIE [4-6]\." 禁用 IE4-IE6
    # 现状：IE6 已经停止支持多年，现在很少使用，但保留此配置可避免潜在问题
    # 其他用途：也可以用于禁用其他有问题的客户端，如某些旧版移动浏览器
    gzip_disable "msie6";
    
    server {
        listen 8080;
        server_name localhost;
        
        root /usr/local/openresty/nginx/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
            # 添加响应头显示压缩信息
            add_header X-Gzip-Enabled "true" always;
        }
        
        # 用于对比：禁用 gzip 的路径
        location /no-gzip/ {
            rewrite ^/no-gzip/(.*)$ /$1 break;
            gzip off;
            root /usr/local/openresty/nginx/html;
            try_files $uri =404;
            add_header X-Gzip-Enabled "false" always;
        }
    }
}

