worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # gzip压缩配置
    gzip on;                                    # 启用 gzip 压缩
    # 启用 Vary: Accept-Encoding 响应头
    # 作用：告知缓存服务器（如 CDN、代理服务器）该响应内容会根据客户端的 Accept-Encoding 请求头而变化
    # 重要性：确保不支持 gzip 的客户端（如某些旧浏览器）能够正确获取未压缩的内容
    # 缓存影响：缓存服务器会根据 Accept-Encoding 的值分别缓存压缩和未压缩的版本
    # 例如：支持 gzip 的客户端会收到压缩内容，不支持 gzip 的客户端会收到原始内容
    gzip_vary on;
    # 配置对代理请求的 gzip 压缩行为
    # 作用：控制当请求来自代理服务器（如反向代理、负载均衡器、CDN）时是否启用压缩
    # 值说明：any 表示对所有代理请求都启用压缩，无论响应头如何
    # 其他可选值：
    #   - off: 不对代理请求启用压缩
    #   - expired/no-cache/no-store/private: 根据响应头的 Cache-Control 或 Expires 决定
    #   - no_last_modified/no_etag: 根据响应头是否包含 Last-Modified 或 ETag 决定
    #   - auth: 仅对包含 Authorization 请求头的代理请求启用压缩
    # 使用场景：当 Nginx 作为后端服务器，前面有代理层时，确保代理请求也能获得压缩内容
    gzip_proxied any;
    gzip_comp_level 6;                          # 压缩级别 (1-9，6 是平衡性能和压缩率)
    # 设置启用 gzip 压缩的最小响应长度
    # 作用：只对大于指定字节数的响应启用压缩，避免压缩过小的文件
    # 原因：小文件压缩后可能反而变大（压缩算法开销 + 压缩头信息），且压缩小文件消耗 CPU 资源
    # 1024 字节（1KB）是一个平衡点
    #   - 小于 1024 字节：压缩收益低，可能得不偿失
    #   - 大于 1024 字节：压缩收益明显，值得消耗 CPU 资源
    # 默认值：20（字节），通常建议设置为 1024 或更高
    # 性能考虑：避免对大量小文件（如 API 响应、图标文件）进行不必要的压缩处理
    gzip_min_length 1k;
    # 禁用特定 User-Agent 的 gzip 压缩
    # 作用：对匹配指定 User-Agent 字符串的客户端禁用 gzip 压缩
    # IE6 问题：Internet Explorer 6 对 gzip 压缩的支持存在严重缺陷
    #   1. 无法正确处理某些 gzip 压缩的响应，可能导致页面显示错误或崩溃
    #   2. 对 Vary 响应头的处理有问题，可能导致缓存混乱
    #   3. 在某些情况下会错误地解压已经解压过的内容
    # 值说明："msie6" 匹配 User-Agent 中包含 "MSIE 6" 的请求
    #   也可以使用正则表达式，如 "MSIE [4-6]\." 禁用 IE4-IE6
    # 现状：IE6 已经停止支持多年，现在很少使用，但保留此配置可避免潜在问题
    # 其他用途：也可以用于禁用其他有问题的客户端，如某些旧版移动浏览器
    gzip_disable "msie6";
    # 配置用于压缩响应的缓冲区数量和大小（最佳实践配置）
    # 作用：设置 gzip 压缩过程中使用的缓冲区，用于临时存储待压缩的数据
    # 格式：gzip_buffers number size;
    # 参数说明：
    #   - number: 缓冲区的数量
    #   - size: 每个缓冲区的大小（支持单位：k/K 表示 KB，m/M 表示 MB）
    # 最佳实践值：32 8k
    #   总缓冲区大小 = 32 × 8KB = 256KB
    #   这是业界推荐的最佳实践配置，平衡了性能和内存占用
    # 重要：缓冲区是每个请求独立分配的，不是所有请求共用的
    #   - 每个需要压缩的请求都会分配自己的缓冲区（32个，每个8KB，总计256KB）
    #   - 请求处理完成后，缓冲区会被释放
    #   - 并发请求会各自分配独立的缓冲区
    #   - 内存占用 = 并发压缩请求数 × 256KB
    #     例如：100个并发压缩请求 ≈ 25.6MB，1000个并发 ≈ 256MB
    #     相比 32 64k（2MB）配置，内存占用减少了87.5%，更适合高并发场景
    # 默认值：32 4k 或 16 8k（取决于平台），总大小通常为 128KB
    # 工作原理：
    #   1. Nginx 在压缩响应时，会将数据写入这些缓冲区
    #   2. 当缓冲区填满或响应完成时，将缓冲区中的数据压缩并发送给客户端
    #   3. 缓冲区用于平衡内存使用和压缩效率
    # 为什么选择 32 8k（256KB）作为最佳实践？
    #   - 足够处理大多数 Web 响应：HTML、CSS、JS、JSON API 响应通常小于 256KB
    #   - 平衡性能和内存：比默认值稍大，能减少压缩次数，提高效率
    #   - 高并发友好：内存占用合理，1000并发仅需约256MB内存
    #   - 适合大多数场景：对于超过256KB的响应，nginx会自动使用临时文件
    # 性能考虑：
    #   - 缓冲区太小（如 16 4k=64KB）：可能导致频繁的内存分配和压缩操作，降低性能
    #   - 缓冲区太大（如 32 64k=2MB）：每个请求占用过多内存，高并发时内存压力大
    #   - 32 8k（256KB）：在性能和内存占用之间取得良好平衡
    # 何时需要调整？
    #   - 大多数 Web 应用：32 8k（256KB）已足够，无需调整
    #   - 超大响应（>1MB）：如果响应经常超过256KB，可以考虑 32 16k（512KB）
    #   - 内存极度受限：可以减小为 16 8k（128KB）或 32 4k（128KB）
    #   - 小文件为主（<100KB）：可以减小为 16 8k（128KB）以节省内存
    gzip_buffers 32 8k;
    # 设置启用 gzip 压缩的最低 HTTP 版本
    # 作用：指定客户端必须使用哪个 HTTP 版本才能启用 gzip 压缩
    # 值说明：
    #   - 1.0: HTTP/1.0（默认值，兼容性最好）
    #   - 1.1: HTTP/1.1（推荐值，现代浏览器都支持）
    # 为什么设置为 1.1：
    #   1. HTTP/1.1 对 gzip 压缩的支持更完善和稳定
    #   2. HTTP/1.0 对 gzip 的支持存在一些兼容性问题
    #   3. 现代浏览器（包括移动浏览器）都支持 HTTP/1.1
    #   4. HTTP/1.1 支持更好的连接复用和压缩机制
    # 影响：
    #   - 设置为 1.1 后，使用 HTTP/1.0 的客户端将不会获得 gzip 压缩
    #   - 但现代浏览器都使用 HTTP/1.1，所以影响很小
    #   - 可以提高压缩的稳定性和可靠性
    gzip_http_version 1.1;
    # 指定启用 gzip 压缩的 MIME 类型
    # 作用：只对指定的内容类型启用压缩，避免对已经压缩或压缩效果不佳的文件类型进行压缩
    # 原则：只压缩文本类文件，因为文本文件压缩率高（通常可压缩 60-80%）
    # 不压缩的类型：
    #   - 图片（jpg/png/gif/webp）：已经是压缩格式，再次压缩效果差且浪费 CPU
    #   - 视频/音频（mp4/mp3）：已经是压缩格式
    #   - 字体文件（woff/woff2）：已经是压缩格式
    #   - PDF：通常已经压缩
    gzip_types
        text/html                               # HTML 文件
        text/plain                              # 纯文本文件
        text/css                                # CSS 样式表文件
        text/xml                                # XML 文件
        text/javascript                         # JavaScript 文件（旧式 MIME 类型）
        text/markdown                           # Markdown 文件
        application/json                        # JSON 数据文件
        application/javascript                  # JavaScript 文件（标准 MIME 类型）
        application/x-javascript                # JavaScript 文件（另一种旧式 MIME 类型）
        application/xml                         # 通用 XML 文件
        application/xhtml+xml                   # XHTML 文件
        application/xml+rss                     # RSS Feed XML 文件
        application/rss+xml                     # RSS Feed XML 文件（另一种写法）
        application/atom+xml                    # Atom Feed XML 文件
        application/manifest+json               # Web App Manifest 文件（PWA）
        image/svg+xml;                          # SVG 矢量图（XML 格式，文本类，压缩效果好）
    
    server {
        listen 8080;
        server_name localhost;
        
        root /usr/local/openresty/nginx/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
            # 添加响应头显示压缩信息
            add_header X-Gzip-Enabled "true" always;
        }
        
        # 用于对比：禁用 gzip 的路径
        location /no-gzip/ {
            rewrite ^/no-gzip/(.*)$ /$1 break;
            gzip off;
            root /usr/local/openresty/nginx/html;
            try_files $uri =404;
            add_header X-Gzip-Enabled "false" always;
        }
    }
}

