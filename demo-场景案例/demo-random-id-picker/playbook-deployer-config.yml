- name: "复制deployer"
  hosts: "{{ groups['all'] | difference(groups['management']) }}"
  tasks:
    - name: "复制deployer目录到远程"
      copy:
        src: deployer/
        dest: ~/deployer-demo-random-id-picker

- name: "配置数据库的deployer"
  hosts: db
  tasks:
    - name: "配置数据库服务的innodb-buffer-pool-size"
      lineinfile:
        path: ~/deployer-demo-random-id-picker/db/.env
        regexp: "^innodb_buffer_pool_size="
        line: "innodb_buffer_pool_size={{ innodb_buffer_pool_size }}"

- name: "配置openresty服务的deployer"
  hosts: openresty
  tasks:
    - name: "配置OpenResty服务的nginx.conf"
      template:
        src: deployer/openresty/nginx.conf.j2
        dest: ~/deployer-demo-random-id-picker/openresty/nginx.conf

- name: "配置api服务的deployer"
  hosts: api
  tasks:
    - name: "配置api服务的java_opts"
      lineinfile:
        path: ~/deployer-demo-random-id-picker/service/.env
        regexp: "^java_opts="
        line: "java_opts={{ java_opts }}"
    - name: "配置api服务的common_db_host"
      lineinfile:
        path: ~/deployer-demo-random-id-picker/service/.env
        regexp: "^common_db_host="
        line: "common_db_host={{ groups['db'][0] }}"
    - name: "配置api服务的common_redis_host"
      lineinfile:
        path: ~/deployer-demo-random-id-picker/service/.env
        regexp: "^common_redis_host="
        line: "common_redis_host={{ groups['common'][0] }}"
