# `k8s`监控

>`https://lumigo.io/kubernetes-monitoring/`

## 要监控的关键`Kubernetes`指标

监控集群、节点、部署和 pod 级别的指标可以提供有关系统健康和性能的重要见解，使操作员能够快速识别和解决问题并优化资源利用率。

### `Kubernetes`集群和节点指标

`Kubernetes`集群指标概述了整个集群的运行状况和性能。需要监控的一些重要集群级指标包括：

- 集群`CPU`和内存使用情况
- 集群中的节点数
- 集群中的`pod`数
- 集群中运行的容器数
- `API`服务器延迟和错误率

`Kubernetes`节点指标可让您深入了解集群中各个节点的运行状况和性能。这些指标可帮助您识别集群中特定节点的任何瓶颈或问题。一些关键节点指标包括：

- 每个节点的`CPU`和内存使用情况
- 网络吞吐量和延迟
- 磁盘使用情况和`I/O`操作
- 每个节点上调度的`pod`数量
- 节点正常运行时间和可用性

### `Kubernetes deployment`和`Pod`指标

除了监控集群和节点指标外，关注 Kubernetes 部署和 pod 指标也很重要。这些指标可以深入了解 Kubernetes 应用程序的运行状况和性能，并帮助您识别可能出现的任何问题。以下是一些关键指标的概述：

**`deployment指标**

这些指标特定于`Kubernetes`部署，用于管理容器化应用程序的推出和扩展。需要监控的一些关键部署指标包括：

- **可用副本数：**表示当前可用且正在运行的应用程序副本（即实例）的数量。
- **所需副本数：**表示根据部署的配置应运行的副本数。
- **部署状态：**表示部署当前正在推出、回滚还是已成功完成推出。
- **部署进度：**表示部署推出的进度，占正在运行的所需副本的百分比。

**`Pod`指标**

`Pod`是`Kubernetes`中最小的可部署单元，包含一个或多个容器。监控`Pod`指标可以帮助您识别单个容器或应用程序的任何问题。要监控的一些关键 Pod 指标包括：

- **`CPU`和内存使用率：**高使用率可能表示应用程序资源不足或节点上的资源受限。
- **容器重启：**表示容器重启的次数。频繁重启可能表示容器的配置或资源使用存在问题。
- **`Pod`状态：**表示`Pod`是正在运行、待处理还是已终止。待处理状态的`Pod`可能表示节点上的资源受限或集群资源不足。

## 最佳`Kubernetes`监控工具

### `Kubernetes Dashboard`

Kubernetes 仪表板是一个基于 Web 的图形用户界面 (GUI)，可用于管理、监控和排除 Kubernetes 集群故障。它提供了一种方便的方式来查看和管理 Kubernetes 资源（例如部署、服务和 Pod），而无需使用命令行界面 (CLI)。

Kubernetes 仪表板默认包含在 Kubernetes 中，可以从 Kubernetes 主节点安装和访问。安装后，您可以从 Web 浏览器访问仪表板，从而查看有关 Kubernetes 集群的详细信息并执行各种任务，例如扩展部署、创建新资源和管理应用程序的配置。

Kubernetes Dashboard 的一些主要功能包括：

- **集群概览**：仪表板提供 Kubernetes 集群的概览，显示节点、Pod 和服务的数量，以及当前的 CPU 和内存使用情况。
- **资源管理**：您可以从仪表板管理 Kubernetes 资源，例如部署、服务和 Pod。您可以创建、编辑和删除资源，并查看有关每个资源的详细信息。
- **应用程序监控**：仪表板可让您监控在 Kubernetes 上运行的应用程序的状态和性能。您可以查看日志和指标、解决问题并配置警报。
- **可定制的视图**：仪表板提供可定制的视图，允许您创建和保存包含对您最重要的指标和信息的自己的仪表板。

### Prometheus

Prometheus 是一个开源监控系统和时间序列数据库，广泛用于监控容器化应用程序和基础设施。它最初由 SoundCloud 开发，后来捐赠给云原生计算基金会 (CNCF)。

Prometheus 旨在收集和存储时间序列数据，让您可以监控和分析性能指标，例如 CPU 和内存使用情况、请求延迟和网络吞吐量。

Prometheus 的一些主要功能包括：

- **灵活的数据模型**：Prometheus 使用灵活的数据模型，让您能够以简单一致的方式表示复杂的多维数据。这使得查询和分析您的指标变得容易。
- **强大的查询语言**：Prometheus 具有强大的查询语言，允许您过滤和聚合指标，以及执行计算和创建派生指标。
- **可扩展性**：Prometheus 的设计目标是高度可扩展，可以处理来自数千台服务器的数百万个指标。它使用基于拉取的模型，代理会定期从端点抓取指标，因此可以根据需要轻松添加和删除服务器。
- **警报**：Prometheus 包含一个强大的警报系统，允许您根据预定义条件设置和配置警报。您还可以使用查询语言创建自定义警报规则。
- **集成**：Prometheus 可与多种工具和服务集成，包括 Grafana、Kubernetes 和 Docker。这使得监控容器化应用程序和基础设施变得容易。

### cAdvisor

cAdvisor（Container Advisor 的缩写）是一个开源代理，它作为守护进程在 Kubernetes 集群中的每个节点上运行，并提供有关在该节点上运行的容器的资源使用情况和性能的详细信息。

cAdvisor 能够收集各种容器指标，包括 CPU 使用率、内存使用率、网络带宽和 I/O 统计信息等。它还可以提供有关各个容器的文件系统使用情况和网络连接的详细信息。

在 Kubernetes 集群中使用 cAdvisor 的一些主要好处包括：

- **实时数据收集**：cAdvisor 提供有关容器性能的实时数据，使操作员能够快速响应出现的问题。
- **可扩展性**：cAdvisor 旨在实现高度可扩展性，使其能够收集和存储在节点或整个集群上运行的大量容器的指标。
- **与 Kubernetes 集成**：cAdvisor 与 Kubernetes 紧密集成，使其易于在集群中的每个节点上部署和配置。

## Kubernetes 监控最佳实践

### 停止测量单个容器

与其测量单个容器，不如关注 Kubernetes 集群的整体运行状况和性能。这意味着在集群和节点级别监控 CPU 和内存使用情况、网络吞吐量和磁盘 I/O 等指标。这种方法提供了对 Kubernetes 环境的更全面视图，使您能够检测可能影响多个容器或应用程序的问题。

### 确保各层之间的数据一致性

确保从 Kubernetes 环境收集的指标和日志在所有层（从容器到节点再到集群）上保持一致非常重要。这有助于避免差异并确保您获得对环境的准确了解。使用集中式日志记录和监控解决方案有助于确保一致性并避免重复工作。

### 跟踪微服务的 API 网关

在监控基于微服务的架构时，跟踪 API 网关非常重要。 API 网关是所有微服务请求的入口点，因此监控它有助于自动检测可能影响多个微服务的问题。通过监控 API 网关，您可以快速识别可能导致应用程序性能问题的问题并采取措施解决这些问题。

### 使用现成的仪表板和警报

许多监控工具提供专为 Kubernetes 环境设计的开箱即用的仪表板和警报。这些仪表板和警报可以提供有关 Kubernetes 环境性能和健康状况的宝贵见解，并有助于快速识别和解决问题。通过使用预构建的仪表板和警报，您可以节省时间和精力，同时仍能全面了解您的环境。





