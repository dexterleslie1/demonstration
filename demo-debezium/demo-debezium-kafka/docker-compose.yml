version: '3.0'

services:
  db:
    image: mariadb:11.4
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - TZ=Asia/Shanghai
    volumes:
      - ./db.sql:/docker-entrypoint-initdb.d/db.sql:ro
      - ./my-customize.cnf:/etc/mysql/conf.d/my-customize.cnf:ro
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_general_ci
      - --skip-character-set-client-handshake
      - --innodb-buffer-pool-size=256m
    ports:
      - "3306:3306"

  debezium-connect:
    image: quay.io/debezium/connect:3.2
    environment:
      TZ: Asia/Shanghai
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: my_connect_configs
      OFFSET_STORAGE_TOPIC: my_connect_offsets
      STATUS_STORAGE_TOPIC: my_connect_statuses
      # kafka 集群
      BOOTSTRAP_SERVERS: "kafka:9092"
    ports:
      - "8083:8083"
  # 初始化 debezium connector
  debezium-connect-init:
    image: amd64/buildpack-deps:buster-curl
    volumes:
      - ./debezium-connect-init.sh:/debezium-connect-init.sh:ro
    entrypoint: sh /debezium-connect-init.sh

  # 使用 debezium kafka 的配置
#  kafka:
#    image: quay.io/debezium/kafka:3.2
#    environment:
#      TZ: Asia/Shanghai
#    ports:
#      - "9092:9092"

  # 使用 confluent kafka 的配置
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    environment:
      TZ: Asia/Shanghai
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
  kafka:
    image: confluentinc/cp-kafka:7.3.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      # 映射 JMX 端口到主机
      # - "9997:9997"
    environment:
      TZ: Asia/Shanghai
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${kafka_advertised_listeners}:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # 设置 Kafka 的 JVM 堆内存
      KAFKA_HEAP_OPTS: "-Xms1g -Xmx1g"
      # 配置 JMX 端口和认证，配置了 jmx 端口才能够被外部工具监控
      # KAFKA_JMX_OPTS: "-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.port=9997 -Dcom.sun.management.jmxremote.rmi.port=9997"
      # 禁用自动创建 Topic，否则 Spring Boot 会自动创建 partitions=0 的 topic
      # KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
