- name: "复制deployer"
  hosts: "{{ groups['all'] | difference(groups['management']) }}"
  tasks:
    - name: "复制deployer目录到远程"
      copy:
        src: deployer/
        dest: ~/deployer-demo-kafka-benchmark

- name: "配置Kafka服务的deployer"
  hosts: kafka
  tasks:
    - name: "配置Kafka服务的kafka_advertised_listeners"
      lineinfile:
        path: ~/deployer-demo-kafka-benchmark/common/.env
        regexp: "^kafka_advertised_listeners="
        line: "kafka_advertised_listeners={{ groups['kafka'][0] }}"

- name: "配置openresty服务的deployer"
  hosts: openresty
  tasks:
    - name: "配置OpenResty服务的nginx.conf"
      template:
        src: deployer/openresty/nginx.conf.j2
        dest: ~/deployer-demo-kafka-benchmark/openresty/nginx.conf

- name: "配置crond服务的deployer"
  hosts: crond
  tasks:
    - name: "配置crond服务的kafka_bootstrap_servers"
      lineinfile:
        path: ~/deployer-demo-kafka-benchmark/crond/.env
        regexp: "^kafka_bootstrap_servers="
        line: "kafka_bootstrap_servers={{ groups['kafka'][0] }}"
    - name: "配置crond服务的redisHost"
      lineinfile:
        path: ~/deployer-demo-kafka-benchmark/crond/.env
        regexp: "^redisHost="
        line: "redisHost={{ groups['kafka'][0] }}"

- name: "配置api服务的deployer"
  hosts: api
  tasks:
    - name: "配置api服务的kafka_bootstrap_servers"
      lineinfile:
        path: ~/deployer-demo-kafka-benchmark/service/.env
        regexp: "^kafka_bootstrap_servers="
        line: "kafka_bootstrap_servers={{ groups['kafka'][0] }}"
    - name: "配置api服务的redisHost"
      lineinfile:
        path: ~/deployer-demo-kafka-benchmark/service/.env
        regexp: "^redisHost="
        line: "redisHost={{ groups['kafka'][0] }}"
